{% extends "dashboard/dashboard_base.html" %}
{% load humanize %}
{% block title %}Accounts - Sujata Associates{% endblock %}

{% block content %}
<div class="dashboard-header">
  <h1>Accounts</h1>
  <p class="text-muted">Client receivables and Employee account details</p>
  
</div>

<style>
  .nav-tabs .nav-link { color: #000 !important; }
  .nav-tabs .nav-link.active { color: #000 !important; }
  .nav-tabs .nav-link:hover { color: #fff !important; background-color: var(--primary-color) !important; }
  /* right align the Actions column contents */
  table .btn { padding: .25rem .5rem; }
  td:last-child { width: 120px; }
  /* Ensure desktop tables scroll horizontally if overflow */
  .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .accounts-table { width: 100%; }
  /* Desktop tuning: keep dense layout so less horizontal scroll is needed */
  @media (min-width: 992px) and (max-width: 1399px) {
    .accounts-table { font-size: .9rem; }
    .accounts-table th,
    .accounts-table td { white-space: normal; padding: .5rem .65rem; }
    /* Tighter min-width so most columns fit without large horizontal scroll */
    .accounts-table.clients-table,
    .accounts-table.employees-table { min-width: 980px; }
    .accounts-table.pay-table,
    .accounts-table.transactions-table { min-width: 720px; }
  }
  /* Extra‑wide screens: keep single-line cells and wider tables */
  @media (min-width: 1400px) {
    .accounts-table th,
    .accounts-table td { white-space: nowrap; }
    .accounts-table.clients-table,
    .accounts-table.employees-table { min-width: 1100px; }
    .accounts-table.pay-table,
    .accounts-table.transactions-table { min-width: 880px; }
  }

  /* Mobile card layout for tables */
  @media (max-width: 768px) {
    .accounts-table { border: 0; }
    .accounts-table thead { display: none; }
    .accounts-table tbody tr { display: block; margin: 0 0 1rem 0; border: 1px solid #eee; border-radius: 10px; background: #fff; overflow: hidden; }
    .accounts-table tbody tr td { display: flex; flex-direction: column; align-items: flex-start; gap: .35rem; padding: .75rem 1rem; border-bottom: 1px solid #f1f1f1; }
    .accounts-table tbody tr td:last-child { border-bottom: 0; }
    .accounts-table tbody tr td::before { content: attr(data-label); font-weight: 600; color: #666; text-transform: uppercase; font-size: .75rem; letter-spacing: .02em; }
    .accounts-table tbody tr td .badge { align-self: flex-start; }
    .accounts-table tbody tr td .d-flex { width: 100%; flex-wrap: wrap; gap: .5rem; }
    .accounts-table tbody tr td .d-flex .btn { flex: 0 0 auto; }
    .accounts-table .d-flex { justify-content: flex-start !important; }
  }
</style>

<ul class="nav nav-tabs" id="accountsTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="clients-tab" data-bs-toggle="tab" data-bs-target="#clients" type="button" role="tab">Clients</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="employees-tab" data-bs-toggle="tab" data-bs-target="#employees" type="button" role="tab">Employees</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="pay-employee-tab" data-bs-toggle="tab" data-bs-target="#pay-employee" type="button" role="tab">Pay to Employee</button>
  </li>
</ul>

<div class="tab-content pt-3" id="accountsTabsContent">
  <!-- Clients Tab -->
  <div class="tab-pane fade" id="clients" role="tabpanel" aria-labelledby="clients-tab">
    <div class="card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="mb-0">Client Accounts</h5>
        <div class="d-flex gap-2">
          <input type="search" class="form-control form-control-sm" style="max-width: 240px;" placeholder="Search client, email, invoice...">
          <button class="btn btn-sm btn-outline-primary"><i class="bi bi-funnel"></i> Filter</button>
          <button class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> Export</button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 accounts-table clients-table">
            <thead class="table-light">
              <tr>
                <th>Client</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Total Quoted</th>
                <th>Amount Invoiced</th>
                <th>Amount Received</th>
                <th>Outstanding</th>
                <th>Last Payment</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for client in clients %}
              <tr>
                <td data-label="Client">
                  {{ client.client_name }}
                  {% if client.company_name %}
                    <br><small class="text-muted">{{ client.company_name }}</small>
                  {% endif %}
                </td>
                <td data-label="Email">{{ client.email|default:"-" }}</td>
                <td data-label="Phone">{{ client.phone|default:"-" }}</td>
                <td data-label="Total Quoted">₹ {{ client.total_quoted|floatformat:2|intcomma }}</td>
                <td data-label="Amount Invoiced">₹ {{ client.amount_invoiced|floatformat:2|intcomma }}</td>
                <td data-label="Amount Received">₹ {{ client.amount_received|floatformat:2|intcomma }}</td>
                <td data-label="Outstanding">
                  {% if client.outstanding > 0 %}
                    <span class="text-danger fw-semibold">₹ {{ client.outstanding|floatformat:2|intcomma }}</span>
                  {% else %}
                    <span class="text-success fw-semibold">₹ {{ client.outstanding|floatformat:2|intcomma }}</span>
                  {% endif %}
                </td>
                <td data-label="Last Payment">
                  {% if client.last_payment %}
                    {{ client.last_payment|date:"d M Y" }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Status">
                  <span class="badge {{ client.status_badge }}">{{ client.status }}</span>
                </td>
                <td data-label="Actions">
                  <div class="d-flex justify-content-end gap-2">
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#clientDetailModal{{ client.id }}" data-bs-title="View">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" data-bs-title="Edit">
                      <i class="bi bi-pencil"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="10" class="text-center text-muted py-4">No clients found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="small text-muted">
          Showing {{ clients.start_index }}–{{ clients.end_index }} of {{ clients.paginator.count }}
        </div>
        <nav>
          <ul class="pagination pagination-sm mb-0">
            {% if clients.has_previous %}
              <li class="page-item"><a class="page-link" href="?client_page={{ clients.previous_page_number }}{% if employees.number > 1 %}&emp_page={{ employees.number }}{% endif %}">Prev</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Prev</span></li>
            {% endif %}
            
            {% for num in clients.paginator.page_range %}
              {% if clients.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% elif num > clients.number|add:'-3' and num < clients.number|add:'3' %}
                <li class="page-item"><a class="page-link" href="?client_page={{ num }}{% if employees.number > 1 %}&emp_page={{ employees.number }}{% endif %}">{{ num }}</a></li>
              {% endif %}
            {% endfor %}
            
            {% if clients.has_next %}
              <li class="page-item"><a class="page-link" href="?client_page={{ clients.next_page_number }}{% if employees.number > 1 %}&emp_page={{ employees.number }}{% endif %}">Next</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>

    <!-- Client Detail Modals -->
    {% for client in clients %}
    <div class="modal fade" id="clientDetailModal{{ client.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-person-badge"></i> Client Account - {{ client.client_name }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6"><strong>Client:</strong> {{ client.client_name }}</div>
              <div class="col-md-6"><strong>Company:</strong> {{ client.company_name|default:"-" }}</div>
              <div class="col-md-6"><strong>Email:</strong> {{ client.email|default:"-" }}</div>
              <div class="col-md-6"><strong>Phone:</strong> {{ client.phone|default:"-" }}</div>
              <div class="col-md-6"><strong>Project:</strong> {{ client.project_name|default:"-" }}</div>
              <div class="col-md-6"><strong>Project Cost:</strong> ₹ {{ client.project_cost|default:0|floatformat:2|intcomma }}</div>
              <div class="col-md-6"><strong>Total Quoted:</strong> ₹ {{ client.total_quoted|floatformat:2|intcomma }}</div>
              <div class="col-md-6"><strong>Amount Invoiced:</strong> ₹ {{ client.amount_invoiced|floatformat:2|intcomma }}</div>
              <div class="col-md-6"><strong>Amount Received:</strong> ₹ {{ client.amount_received|floatformat:2|intcomma }}</div>
              <div class="col-md-6"><strong>Outstanding:</strong> 
                {% if client.outstanding > 0 %}
                  <span class="text-danger">₹ {{ client.outstanding|floatformat:2|intcomma }}</span>
                {% else %}
                  <span class="text-success">₹ {{ client.outstanding|floatformat:2|intcomma }}</span>
                {% endif %}
              </div>
            </div>

            <hr>
            <h6 class="mb-2">Quotes</h6>
            {% if client.quotes %}
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th>Quote #</th><th>Date</th><th>Amount</th><th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for quote in client.quotes %}
                  <tr>
                    <td>{{ quote.quote_number }}</td>
                    <td>{{ quote.created_at|date:"d M Y" }}</td>
                    <td>₹ {{ quote.total|floatformat:2|intcomma }}</td>
                    <td><span class="badge {{ quote.get_status_badge_class }}">{{ quote.status }}</span></td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <p class="text-muted">No quotes found for this client.</p>
            {% endif %}

            <h6 class="mt-3 mb-2">Quote Summary</h6>
            <ul class="mb-0">
              <li>Total Quotes: {{ client.quotes.count }}</li>
              <li>Total Quoted: ₹ {{ client.total_quoted|floatformat:2|intcomma }}</li>
              <li>Accepted Quotes: {{ client.quotes|length }} (₹ {{ client.amount_invoiced|floatformat:2|intcomma }})</li>
            </ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary"><i class="bi bi-plus"></i> Add Payment</button>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Employees Tab -->
  <div class="tab-pane fade" id="employees" role="tabpanel" aria-labelledby="employees-tab">
    <div class="card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="mb-0">Employee Account Details</h5>
        <div class="d-flex gap-2">
          <input type="search" class="form-control form-control-sm" style="max-width: 220px;" placeholder="Search employee, dept, UPI...">
          <button class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> Export</button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 accounts-table employees-table">
            <thead class="table-light">
              <tr>
                <th>Employee</th>
                <th>Dept</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Bank</th>
                <th>Account No.</th>
                <th>IFSC</th>
                <th>UPI</th>
                <th>Salary</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for employee in employees %}
              <tr>
                <td data-label="Employee">{{ employee.get_full_name }}</td>
                <td data-label="Dept">{{ employee.department|default:"-" }}</td>
                <td data-label="Email">{{ employee.email }}</td>
                <td data-label="Phone">{{ employee.phone|default:"-" }}</td>
                <td data-label="Bank">{{ employee.bank_name|default:"-" }}</td>
                <td data-label="Account No.">{{ employee.account_number|default:"-" }}</td>
                <td data-label="IFSC">{{ employee.ifsc|default:"-" }}</td>
                <td data-label="UPI">{{ employee.upi|default:"-" }}</td>
                <td data-label="Salary">
                  {% if employee.ctc %}
                    ₹ {{ employee.ctc|floatformat:2|intcomma }}
                  {% elif employee.basic %}
                    ₹ {{ employee.basic|floatformat:2|intcomma }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Actions">
                  <div class="d-flex justify-content-end gap-2">
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#employeeDetailModal{{ employee.id }}" data-bs-title="View">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#payEmployeeModal{{ employee.id }}" data-bs-title="Pay Now">
                      <i class="bi bi-currency-rupee"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="10" class="text-center text-muted py-4">No employees found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="small text-muted">
          Showing {{ employees.start_index }}–{{ employees.end_index }} of {{ employees.paginator.count }}
        </div>
        <nav>
          <ul class="pagination pagination-sm mb-0">
            {% if employees.has_previous %}
              <li class="page-item"><a class="page-link" href="?emp_page={{ employees.previous_page_number }}{% if clients.number > 1 %}&client_page={{ clients.number }}{% endif %}">Prev</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Prev</span></li>
            {% endif %}
            
            {% for num in employees.paginator.page_range %}
              {% if employees.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% elif num > employees.number|add:'-3' and num < employees.number|add:'3' %}
                <li class="page-item"><a class="page-link" href="?emp_page={{ num }}{% if clients.number > 1 %}&client_page={{ clients.number }}{% endif %}">{{ num }}</a></li>
              {% endif %}
            {% endfor %}
            
            {% if employees.has_next %}
              <li class="page-item"><a class="page-link" href="?emp_page={{ employees.next_page_number }}{% if clients.number > 1 %}&client_page={{ clients.number }}{% endif %}">Next</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>

    <!-- Employee Detail Modals -->
    {% for employee in employees %}
    <div class="modal fade" id="employeeDetailModal{{ employee.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-person-vcard"></i> Employee Account</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-4"><strong>Name:</strong> {{ employee.get_full_name }}</div>
              <div class="col-md-4"><strong>Dept:</strong> {{ employee.department|default:"-" }}</div>
              <div class="col-md-4"><strong>Email:</strong> {{ employee.email }}</div>
              <div class="col-md-4"><strong>Phone:</strong> {{ employee.phone|default:"-" }}</div>
              <div class="col-md-4"><strong>Bank:</strong> {{ employee.bank_name|default:"-" }}</div>
              <div class="col-md-4"><strong>Account No.:</strong> {{ employee.account_number|default:"-" }}</div>
              <div class="col-md-4"><strong>IFSC:</strong> {{ employee.ifsc|default:"-" }}</div>
              <div class="col-md-4"><strong>UPI:</strong> {{ employee.upi|default:"-" }}</div>
              <div class="col-md-4"><strong>Salary:</strong> 
                {% if employee.ctc %}
                  ₹ {{ employee.ctc|floatformat:2|intcomma }}
                {% elif employee.basic %}
                  ₹ {{ employee.basic|floatformat:2|intcomma }}
                {% else %}
                  -
                {% endif %}
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Pay to Employee Tab -->
  <div class="tab-pane fade show active" id="pay-employee" role="tabpanel" aria-labelledby="pay-employee-tab">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-wallet2"></i> Pay to Employee</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 accounts-table pay-table">
            <thead class="table-light">
              <tr>
                <th>Employee</th>
                <th>Dept</th>
                <th>Basic</th>
                <th>HRA</th>
                <th>Allowances</th>
                <th>Deductions</th>
                <th>Variable/Bonus</th>
                <th>CTC (Annual)</th>
                <th>Net Salary</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for employee in employees %}
              <tr>
                <td data-label="Employee"><strong>{{ employee.get_full_name }}</strong><br><small class="text-muted">{{ employee.email }}</small></td>
                <td data-label="Dept">{{ employee.department|default:"-" }}</td>
                <td data-label="Basic">₹ {{ employee.basic|default:0|floatformat:2|intcomma }}</td>
                <td data-label="HRA">₹ {{ employee.hra|default:0|floatformat:2|intcomma }}</td>
                <td data-label="Allowances">₹ {{ employee.allowances|default:0|floatformat:2|intcomma }}</td>
                <td data-label="Deductions">₹ {{ employee.deductions|default:0|floatformat:2|intcomma }}</td>
                <td data-label="Variable/Bonus">₹ {{ employee.variable|default:0|floatformat:2|intcomma }}</td>
                <td data-label="CTC (Annual)"><strong>₹ {{ employee.ctc|default:0|floatformat:2|intcomma }}</strong></td>
                <td data-label="Net Salary">
                  <strong class="text-success">₹ {{ employee.get_net_salary|floatformat:2|intcomma }}</strong>
                </td>
                <td data-label="Actions">
                  <div class="d-flex justify-content-end gap-2">
                    {% if employee.id in paid_this_month_ids %}
                      <button class="btn btn-sm btn-secondary" disabled title="Already paid this month">
                        <i class="bi bi-check2-circle"></i> Paid
                      </button>
                    {% else %}
                      <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#payEmployeeModal{{ employee.id }}">
                        <i class="bi bi-currency-rupee"></i> Pay Now
                      </button>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="10" class="text-center text-muted py-4">No employees found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="small text-muted">
          Showing {{ employees.start_index }}–{{ employees.end_index }} of {{ employees.paginator.count }}
        </div>
        <nav>
          <ul class="pagination pagination-sm mb-0">
            {% if employees.has_previous %}
              <li class="page-item"><a class="page-link" href="?emp_page={{ employees.previous_page_number }}{% if clients.number > 1 %}&client_page={{ clients.number }}{% endif %}">Prev</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Prev</span></li>
            {% endif %}
            
            {% for num in employees.paginator.page_range %}
              {% if employees.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% elif num > employees.number|add:'-3' and num < employees.number|add:'3' %}
                <li class="page-item"><a class="page-link" href="?emp_page={{ num }}{% if clients.number > 1 %}&client_page={{ clients.number }}{% endif %}">{{ num }}</a></li>
              {% endif %}
            {% endfor %}
            
            {% if employees.has_next %}
              <li class="page-item"><a class="page-link" href="?emp_page={{ employees.next_page_number }}{% if clients.number > 1 %}&client_page={{ clients.number }}{% endif %}">Next</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>

    <!-- Transaction History Section -->
    <div class="card mt-4">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Payment Transactions</h5>
        <div class="d-flex gap-2">
          <input type="search" class="form-control form-control-sm" style="max-width: 240px;" placeholder="Search employee, month, year...">
          <button class="btn btn-sm btn-outline-primary"><i class="bi bi-funnel"></i> Filter</button>
          <button class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> Export</button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 accounts-table transactions-table">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Month</th>
                <th>Year</th>
                <th>Employee</th>
                <th>Dept</th>
                <th>Amount</th>
                <th>Basic</th>
                <th>HRA</th>
                <th>Allowances</th>
                <th>Deductions</th>
                <th>Variable</th>
                <th>Payment Method</th>
                <th>Transaction ID</th>
                <th>Status</th>
                <th>Processed By</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for transaction in transactions %}
              <tr>
                <td data-label="Date">{{ transaction.payment_date|date:"d M Y" }}</td>
                <td data-label="Month">{{ transaction.get_month_name }}</td>
                <td data-label="Year">{{ transaction.payment_year }}</td>
                <td data-label="Employee">
                  <strong>{{ transaction.get_employee_name|default:"-" }}</strong><br>
                  <small class="text-muted">
                    {% if transaction.employee %}
                      {{ transaction.employee.email }}
                    {% else %}
                      -
                    {% endif %}
                  </small>
                </td>
                <td data-label="Dept">{{ transaction.get_employee_department|default:"-" }}</td>
                <td data-label="Amount"><strong class="text-success">₹ {{ transaction.amount|floatformat:2|intcomma }}</strong></td>
                <td data-label="Basic">₹ {{ transaction.basic|default:0|floatformat:2|intcomma }}</td>
                <td data-label="HRA">₹ {{ transaction.hra|default:0|floatformat:2|intcomma }}</td>
                <td data-label="Allowances">₹ {{ transaction.allowances|default:0|floatformat:2|intcomma }}</td>
                <td data-label="Deductions">₹ {{ transaction.deductions|default:0|floatformat:2|intcomma }}</td>
                <td data-label="Variable">₹ {{ transaction.variable|default:0|floatformat:2|intcomma }}</td>
                <td data-label="Payment Method">
                  <span class="badge bg-info text-dark">
                    {{ transaction.get_payment_method_display }}
                  </span>
                </td>
                <td data-label="Transaction ID">
                  {% if transaction.transaction_id %}
                    <small>{{ transaction.transaction_id }}</small>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td data-label="Status">
                  {% if transaction.status == 'completed' %}
                    <span class="badge bg-success">{{ transaction.get_status_display }}</span>
                  {% elif transaction.status == 'pending' %}
                    <span class="badge bg-warning text-dark">{{ transaction.get_status_display }}</span>
                  {% elif transaction.status == 'failed' %}
                    <span class="badge bg-danger">{{ transaction.get_status_display }}</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ transaction.get_status_display }}</span>
                  {% endif %}
                </td>
                <td data-label="Processed By">
                  {% if transaction.processed_by %}
                    {{ transaction.processed_by.get_full_name|default:transaction.processed_by.username }}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td data-label="Actions">
                  <div class="d-flex justify-content-end gap-2">
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#transactionDetailModal{{ transaction.id }}">
                      <i class="bi bi-eye"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="16" class="text-center text-muted py-4">No payment transactions found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="small text-muted">
          Showing {{ transactions.start_index }}–{{ transactions.end_index }} of {{ transactions.paginator.count }}
        </div>
        <nav>
          <ul class="pagination pagination-sm mb-0">
            {% if transactions.has_previous %}
              <li class="page-item"><a class="page-link" href="?trans_page={{ transactions.previous_page_number }}{% if employees.number > 1 %}&emp_page={{ employees.number }}{% endif %}{% if clients.number > 1 %}&client_page={{ clients.number }}{% endif %}">Prev</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Prev</span></li>
            {% endif %}
            
            {% for num in transactions.paginator.page_range %}
              {% if transactions.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% elif num > transactions.number|add:'-3' and num < transactions.number|add:'3' %}
                <li class="page-item"><a class="page-link" href="?trans_page={{ num }}{% if employees.number > 1 %}&emp_page={{ employees.number }}{% endif %}{% if clients.number > 1 %}&client_page={{ clients.number }}{% endif %}">{{ num }}</a></li>
              {% endif %}
            {% endfor %}
            
            {% if transactions.has_next %}
              <li class="page-item"><a class="page-link" href="?trans_page={{ transactions.next_page_number }}{% if employees.number > 1 %}&emp_page={{ employees.number }}{% endif %}{% if clients.number > 1 %}&client_page={{ clients.number }}{% endif %}">Next</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Pay Employee Modals (Outside tabs so they work from both tabs) -->
    {% for employee in employees %}
    <div class="modal fade" id="payEmployeeModal{{ employee.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-wallet2"></i> Pay to Employee - {{ employee.get_full_name }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <strong>Employee:</strong> {{ employee.get_full_name }}
              </div>
              <div class="col-md-6">
                <strong>Department:</strong> {{ employee.department|default:"-" }}
              </div>
              <div class="col-md-6">
                <strong>Email:</strong> {{ employee.email }}
              </div>
              <div class="col-md-6">
                <strong>Phone:</strong> {{ employee.phone|default:"-" }}
              </div>
            </div>

            <hr>

            <h6 class="mb-3">Salary Breakdown</h6>
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label">Basic Salary</label>
                <input type="text" class="form-control" value="₹ {{ employee.basic|default:0|floatformat:2|intcomma }}" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">HRA</label>
                <input type="text" class="form-control" value="₹ {{ employee.hra|default:0|floatformat:2|intcomma }}" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Allowances</label>
                <input type="text" class="form-control" value="₹ {{ employee.allowances|default:0|floatformat:2|intcomma }}" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Deductions</label>
                <input type="text" class="form-control" value="₹ {{ employee.deductions|default:0|floatformat:2|intcomma }}" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Variable/Bonus</label>
                <input type="text" class="form-control" value="₹ {{ employee.variable|default:0|floatformat:2|intcomma }}" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">CTC (Annual)</label>
                <input type="text" class="form-control" value="₹ {{ employee.ctc|default:0|floatformat:2|intcomma }}" readonly>
              </div>
            </div>

            <div class="alert alert-info">
              <strong>Net Salary:</strong> 
              ₹ {{ employee.get_net_salary|floatformat:2|intcomma }}
            </div>

            <hr>

            <h6 class="mb-3">Payment Details</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Bank Name</label>
                <input type="text" class="form-control" value="{{ employee.bank_name|default:"-" }}" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Account Number</label>
                <input type="text" class="form-control" value="{{ employee.account_number|default:"-" }}" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">IFSC Code</label>
                <input type="text" class="form-control" value="{{ employee.ifsc|default:"-" }}" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">UPI ID</label>
                <input type="text" class="form-control" value="{{ employee.upi|default:"-" }}" readonly>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="processPayment({{ employee.id }})">
              <i class="bi bi-check-circle"></i> Pay Now
            </button>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
function processPayment(employeeId) {
  if (confirm('Are you sure you want to process payment for this employee?')) {
    // Here you can add AJAX call to process payment
    fetch(`/accounts/pay-employee/${employeeId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Payment processed successfully!');
        location.reload();
      } else {
        alert('Error processing payment: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error processing payment. Please try again.');
    });
  }
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

<!-- Transaction Detail Modals -->
{% for transaction in transactions %}
<div class="modal fade" id="transactionDetailModal{{ transaction.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-receipt"></i> Transaction Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3 mb-3">
          <div class="col-md-6"><strong>Employee:</strong> {{ transaction.get_employee_name|default:"-" }}</div>
          <div class="col-md-6"><strong>Department:</strong> {{ transaction.get_employee_department|default:"-" }}</div>
          <div class="col-md-6"><strong>Email:</strong> {% if transaction.employee %}{{ transaction.employee.email }}{% else %}-{% endif %}</div>
          <div class="col-md-6"><strong>Payment Date:</strong> {{ transaction.payment_date|date:"d M Y" }}</div>
          <div class="col-md-6"><strong>Month:</strong> {{ transaction.get_month_name }}</div>
          <div class="col-md-6"><strong>Year:</strong> {{ transaction.payment_year }}</div>
          <div class="col-md-6"><strong>Payment Period:</strong> {{ transaction.get_payment_period }}</div>
          <div class="col-md-6"><strong>Payment Method:</strong> {{ transaction.get_payment_method_display }}</div>
        </div>

        <hr>

        <h6 class="mb-3">Salary Breakdown</h6>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label">Basic Salary</label>
            <input type="text" class="form-control" value="₹ {{ transaction.basic|default:0|floatformat:2|intcomma }}" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">HRA</label>
            <input type="text" class="form-control" value="₹ {{ transaction.hra|default:0|floatformat:2|intcomma }}" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">Allowances</label>
            <input type="text" class="form-control" value="₹ {{ transaction.allowances|default:0|floatformat:2|intcomma }}" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">Deductions</label>
            <input type="text" class="form-control" value="₹ {{ transaction.deductions|default:0|floatformat:2|intcomma }}" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">Variable/Bonus</label>
            <input type="text" class="form-control" value="₹ {{ transaction.variable|default:0|floatformat:2|intcomma }}" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">CTC (Annual)</label>
            <input type="text" class="form-control" value="₹ {{ transaction.ctc|default:0|floatformat:2|intcomma }}" readonly>
          </div>
        </div>

        <div class="alert alert-success">
          <strong>Net Amount Paid:</strong> ₹ {{ transaction.amount|floatformat:2|intcomma }}
        </div>

        <hr>

        <h6 class="mb-3">Transaction Information</h6>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Transaction ID</label>
            <input type="text" class="form-control" value="{{ transaction.transaction_id|default:"-" }}" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">Reference Number</label>
            <input type="text" class="form-control" value="{{ transaction.reference_number|default:"-" }}" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">Status</label>
            <input type="text" class="form-control" value="{{ transaction.get_status_display }}" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label">Processed By</label>
            <input type="text" class="form-control" value="{% if transaction.processed_by %}{{ transaction.processed_by.get_full_name|default:transaction.processed_by.username }}{% else %}-{% endif %}" readonly>
          </div>
          {% if transaction.notes %}
          <div class="col-12">
            <label class="form-label">Notes</label>
            <textarea class="form-control" readonly>{{ transaction.notes }}</textarea>
          </div>
          {% endif %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% endblock %}


