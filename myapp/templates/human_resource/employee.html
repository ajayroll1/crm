{% extends "dashboard/dashboard_base.html"%}
{% block title %}Employees -Sujata Associates{% endblock%}

{% block content %}
<div class="dashboard-header">
  <h1>Employee Master</h1>
  <p class="text-muted">Add and manage complete employee records</p>
</div>

<style>
  .nav-tabs .nav-link { color: #000 !important; }
  .nav-tabs .nav-link.active { color: #000 !important; }
  .nav-tabs .nav-link:hover { color: #fff !important; background-color: var(--primary-color) !important; }
  .form-section-title { font-weight: 600; margin: .25rem 0 1rem; color: var(--primary-color); }
  /* Mobile responsiveness */
  .tab-content .card { border-radius: 10px; }
  .tab-content .card-header { background: #fff; }
  /* Make tabs horizontally scrollable on mobile */
  @media (max-width: 768px){
    /* Hide desktop tabs; use dropdown menu */
    #empTabs { display: none !important; }
    .emp-tabs-menu { display: block; }
    .card-body .row.g-3 > [class*="col-"] { padding-bottom: .25rem; }
    /* Ensure inputs and selects are comfortably tappable */
    .form-control, .form-select { font-size: 16px; }
    /* Reduce inner spacing a bit for small screens */
    .card-body { padding: .75rem !important; }
    .card-header { padding: .75rem 1rem !important; }
    .dashboard-header { padding: 0 0 .5rem 0; margin-bottom: 1rem; }
    .dashboard-header h1 { font-size: 1.5rem; }
    label.form-label { margin-bottom: .25rem; }
    /* Avoid overflow of long values */
    input, select, textarea { word-break: break-word; }
    /* Two-column rows collapse to one on small screens (safety even if classes change) */
    .row.g-3 > [class*="col-md-"] { flex: 0 0 100%; max-width: 100%; }
    /* File inputs spacing */
    input[type="file"].form-control { padding-top: .4rem; padding-bottom: .4rem; }
  }

  /* Extra-small devices */
  @media (max-width: 576px){
    #empTabs .nav-link { font-size: .9rem; }
    .form-section-title { font-size: .95rem; }
  }

  /* Leave Balance Cards Styling */
  .leave-balance-card {
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
    height: 100%;
  }
  
  .leave-balance-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  
  .leave-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
  }
  
  .leave-icon.success {
    background-color: #d4edda;
    color: #28a745;
  }
  
  .leave-icon.warning {
    background-color: #fff3cd;
    color: #ffc107;
  }
  
  .leave-icon.info {
    background-color: #d1ecf1;
    color: #17a2b8;
  }
  
  .leave-icon.primary {
    background-color: #cfe2ff;
    color: #0d6efd;
  }
  
  .leave-icon.secondary {
    background-color: #e2e3e5;
    color: #6c757d;
  }
  
  .leave-icon.danger {
    background-color: #f8d7da;
    color: #dc3545;
  }
  
  .leave-type-name {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
    font-weight: 500;
  }
  
  .leave-days {
    font-size: 2rem;
    font-weight: 700;
    color: #212529;
    line-height: 1;
    margin-bottom: 0.25rem;
  }
  
  .leave-days-display {
    font-size: 2rem;
    font-weight: 700;
    color: #212529;
    line-height: 1;
    margin-bottom: 0.25rem;
    min-height: 2.5rem;
    display: flex;
    align-items: center;
  }
  
  .leave-days-input {
    font-size: 1.5rem;
    font-weight: 700;
    text-align: center;
  }
  
  .leave-edit-btn {
    flex-shrink: 0;
  }
  
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .leave-subtitle {
    font-size: 0.75rem;
    color: #6c757d;
  }

  /* Employee table mobile responsiveness */
  @media (max-width: 768px) {
    /* Leave Cards Mobile */
    .leave-balance-card {
      min-height: 100px;
    }
    
    .leave-icon {
      width: 45px;
      height: 45px;
      font-size: 1.3rem;
    }
    
    .leave-type-name {
      font-size: 0.85rem;
    }
    
    .leave-days {
      font-size: 1.75rem;
    }
    
    .leave-subtitle {
      font-size: 0.7rem;
    }
    
    .table-responsive {
      border: none;
    }
    
    .table thead {
      display: none;
    }
    
    .table tbody tr {
      display: block;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin-bottom: 10px;
      padding: 15px;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .table tbody td {
      display: block;
      border: none;
      padding: 5px 0;
      text-align: left !important;
    }
    
    .table tbody td:before {
      content: attr(data-label) ": ";
      font-weight: 600;
      color: #6c757d;
      display: inline-block;
      width: 100px;
    }
    
    .table tbody td[data-label="Employee"]:before {
      content: "";
      display: none;
    }
    
    .table tbody td[data-label="Actions"]:before {
      content: "";
      display: none;
    }
    
    .table tbody td[data-label="Actions"] {
      text-align: center !important;
      padding-top: 10px;
      border-top: 1px solid #dee2e6;
      margin-top: 10px;
    }
    
    .btn-group .btn {
      margin: 0 2px;
    }
    
    .card-header .d-flex {
      flex-direction: column;
      gap: 10px;
    }
    
    .card-header .input-group {
      width: 100% !important;
    }
  }

  @media (max-width: 576px) {
    /* Leave Cards Extra Small */
    .leave-balance-card {
      min-height: 90px;
      margin-bottom: 0.75rem;
    }
    
    .leave-icon {
      width: 40px;
      height: 40px;
      font-size: 1.1rem;
    }
    
    .leave-type-name {
      font-size: 0.8rem;
    }
    
    .leave-days {
      font-size: 1.5rem;
    }
    
    .leave-subtitle {
      font-size: 0.65rem;
    }
  }
</style>

<!-- Mobile tabs hamburger -->
<div class="d-md-none mb-2 emp-tabs-menu">
  <div class="dropdown">
    <button class="btn btn-outline-primary btn-sm dropdown-toggle w-100" type="button" id="empTabsMenuBtn" data-bs-toggle="dropdown" aria-expanded="false">
      Sections
    </button>
    <ul class="dropdown-menu w-100" aria-labelledby="empTabsMenuBtn">
      <li><a class="dropdown-item" data-tab="#personal" href="#">Personal</a></li>
      <li><a class="dropdown-item" data-tab="#job" href="#">Job</a></li>
      <li><a class="dropdown-item" data-tab="#payroll" href="#">Payroll</a></li>
      <li><a class="dropdown-item" data-tab="#banking" href="#">Banking</a></li>
      <li><a class="dropdown-item" data-tab="#tax" href="#">Tax/IDs</a></li>
      <li><a class="dropdown-item" data-tab="#docs" href="#">Documents</a></li>
      <li><a class="dropdown-item" data-tab="#emergency" href="#">Emergency</a></li>
      <li><a class="dropdown-item" data-tab="#assets" href="#">Assets</a></li>
      <li><a class="dropdown-item" data-tab="#access" href="#">Access</a></li>
      <li><a class="dropdown-item" data-tab="#notes" href="#">Notes</a></li>
      <li><a class="dropdown-item" data-tab="#leaves" href="#">Leaves</a></li>
    </ul>
  </div>
</div>

<ul class="nav nav-tabs d-none d-md-flex" id="empTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal" type="button" role="tab">Personal</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="job-tab" data-bs-toggle="tab" data-bs-target="#job" type="button" role="tab">Job</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="payroll-tab" data-bs-toggle="tab" data-bs-target="#payroll" type="button" role="tab">Payroll</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="banking-tab" data-bs-toggle="tab" data-bs-target="#banking" type="button" role="tab">Banking</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tax-tab" data-bs-toggle="tab" data-bs-target="#tax" type="button" role="tab">Tax/IDs</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="docs-tab" data-bs-toggle="tab" data-bs-target="#docs" type="button" role="tab">Documents</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="emergency-tab" data-bs-toggle="tab" data-bs-target="#emergency" type="button" role="tab">Emergency</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="assets-tab" data-bs-toggle="tab" data-bs-target="#assets" type="button" role="tab">Assets</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="access-tab" data-bs-toggle="tab" data-bs-target="#access" type="button" role="tab">Access</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">Notes</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="leaves-tab" data-bs-toggle="tab" data-bs-target="#leaves" type="button" role="tab">Leaves</button>
  </li>
</ul>

<form id="employeeForm" class="mt-3" method="POST" action="{% url 'employees' %}" enctype="multipart/form-data" novalidate>
  <!-- Hidden field to track employee ID for updates -->
  <input type="hidden" name="employee_id" id="employee_id" value="{% if edit_employee %}{{ edit_employee.id }}{% endif %}">
  {% csrf_token %}
  <div class="tab-content" id="empTabsContent">
    <!-- Personal -->
    <div class="tab-pane fade show active" id="personal" role="tabpanel">
      <div class="card">
        <div class="card-header"><h6 class="form-section-title">Personal Information</h6></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">First Name<span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="first_name" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Last Name<span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="last_name" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Employee Code</label>
              <input type="text" class="form-control" name="emp_code" placeholder="EMP-0012">
            </div>

            <div class="col-md-3">
              <label class="form-label">Gender</label>
              <select class="form-select" name="gender">
                <option value="">Select</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Date of Birth</label>
              <input type="date" class="form-control" name="dob">
            </div>
            <div class="col-md-3">
              <label class="form-label">Email<span class="text-danger">*</span></label>
              <input type="email" class="form-control" name="email" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Phone<span class="text-danger">*</span></label>
              <input type="tel" class="form-control" name="phone" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Current Address</label>
              <input type="text" class="form-control" name="address_current" placeholder="Street, City, State, PIN">
            </div>
            <div class="col-md-6">
              <label class="form-label">Permanent Address</label>
              <input type="text" class="form-control" name="address_permanent" placeholder="Street, City, State, PIN">
            </div>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-primary btn-sm" onclick="saveSection('personal', this)">
            <i class="bi bi-save"></i> Save Personal Info
          </button>
        </div>
      </div>
    </div>

    <!-- Job -->
    <div class="tab-pane fade" id="job" role="tabpanel">
      <div class="card">
        <div class="card-header"><h6 class="form-section-title">Job Details</h6></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Designation<span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="designation" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Department<span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="department" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Reporting Manager</label>
              <input type="text" class="form-control" name="manager">
            </div>
            <div class="col-md-3">
              <label class="form-label">Employment Type</label>
              <select class="form-select" name="employment_type">
                <option>Full-time</option><option>Part-time</option><option>Contract</option><option>Intern</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Location</label>
              <input type="text" class="form-control" name="location" placeholder="Office/Remote/Hybrid">
            </div>
            <div class="col-md-3">
              <label class="form-label">Joining Date</label>
              <input type="date" class="form-control" name="joining_date">
            </div>
            <div class="col-md-3">
              <label class="form-label">Probation (months)</label>
              <input type="number" class="form-control" name="probation" min="0" max="12">
            </div>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-primary btn-sm" onclick="saveSection('job', this)">
            <i class="bi bi-save"></i> Save Job Details
          </button>
        </div>
      </div>
    </div>

    <!-- Payroll -->
    <div class="tab-pane fade" id="payroll" role="tabpanel">
      <div class="card">
        <div class="card-header"><h6 class="form-section-title">Payroll</h6></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">CTC (Annual)</label>
              <input type="text" class="form-control" name="ctc" placeholder="â‚¹">
            </div>
            <div class="col-md-3">
              <label class="form-label">Basic</label>
              <input type="text" class="form-control" name="basic">
            </div>
            <div class="col-md-3">
              <label class="form-label">HRA</label>
              <input type="text" class="form-control" name="hra">
            </div>
            <div class="col-md-3">
              <label class="form-label">Allowances</label>
              <input type="text" class="form-control" name="allowances">
            </div>
            <div class="col-md-3">
              <label class="form-label">Deductions</label>
              <input type="text" class="form-control" name="deductions">
            </div>
            <div class="col-md-3">
              <label class="form-label">Variable/Bonus</label>
              <input type="text" class="form-control" name="variable">
            </div>
            <div class="col-md-3">
              <label class="form-label">Pay Cycle</label>
              <select class="form-select" name="pay_cycle"><option>Monthly</option><option>Bi-weekly</option></select>
            </div>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-primary btn-sm" onclick="saveSection('payroll', this)">
            <i class="bi bi-save"></i> Save Payroll
          </button>
        </div>
      </div>
    </div>

    <!-- Banking -->
    <div class="tab-pane fade" id="banking" role="tabpanel">
      <div class="card">
        <div class="card-header"><h6 class="form-section-title">Banking Details</h6></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Bank Name</label>
              <input type="text" class="form-control" name="bank_name">
            </div>
            <div class="col-md-4">
              <label class="form-label">Account Number</label>
              <input type="text" class="form-control" name="account_number">
            </div>
            <div class="col-md-4">
              <label class="form-label">IFSC</label>
              <input type="text" class="form-control" name="ifsc">
            </div>
            <div class="col-md-4">
              <label class="form-label">UPI ID</label>
              <input type="text" class="form-control" name="upi">
            </div>
            <div class="col-md-4">
              <label class="form-label">PAN</label>
              <input type="text" class="form-control" name="pan">
            </div>
            <div class="col-md-4">
              <label class="form-label">Aadhaar</label>
              <input type="text" class="form-control" name="aadhaar">
            </div>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-primary btn-sm" onclick="saveSection('banking', this)">
            <i class="bi bi-save"></i> Save Banking
          </button>
        </div>
      </div>
    </div>

    <!-- Tax/IDs -->
    <div class="tab-pane fade" id="tax" role="tabpanel">
      <div class="card">
        <div class="card-header"><h6 class="form-section-title">Statutory Details</h6></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">UAN (PF)</label>
              <input type="text" class="form-control" name="uan">
            </div>
            <div class="col-md-4">
              <label class="form-label">ESIC No</label>
              <input type="text" class="form-control" name="esic">
            </div>
            <div class="col-md-4">
              <label class="form-label">GST (if any)</label>
              <input type="text" class="form-control" name="gst">
            </div>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-primary btn-sm" onclick="saveSection('tax', this)">
            <i class="bi bi-save"></i> Save Tax/IDs
          </button>
        </div>
      </div>
    </div>

    <!-- Documents -->
    <div class="tab-pane fade" id="docs" role="tabpanel">
      <div class="card">
        <div class="card-header"><h6 class="form-section-title">Documents</h6></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Aadhaar Card</label>
              <input type="file" class="form-control" name="doc_aadhaar" accept="image/*,application/pdf">
            </div>
            <div class="col-md-6">
              <label class="form-label">PAN Card</label>
              <input type="file" class="form-control" name="doc_pan" accept="image/*,application/pdf">
            </div>

            <div class="col-md-6">
              <label class="form-label">Bank Passbook/Cancelled Cheque</label>
              <input type="file" class="form-control" name="doc_bank" accept="image/*,application/pdf">
            </div>
            <div class="col-md-6">
              <label class="form-label">Experience Letter(s)</label>
              <input type="file" class="form-control" name="doc_experience" multiple accept="image/*,application/pdf">
            </div>

            <div class="col-md-6">
              <label class="form-label">Education Certificates (10/12/Graduation)</label>
              <input type="file" class="form-control" name="doc_education" multiple accept="image/*,application/pdf">
            </div>
            <div class="col-md-6">
              <label class="form-label">Previous Company Offer/Relieving Letter</label>
              <input type="file" class="form-control" name="doc_prev_offer_relieve" multiple accept="image/*,application/pdf">
            </div>

            <div class="col-md-6">
              <label class="form-label">Current Company Offer/Appointment Letter</label>
              <input type="file" class="form-control" name="doc_current_offer" accept="image/*,application/pdf">
            </div>
            <div class="col-md-6">
              <label class="form-label">Latest Month Salary Slips</label>
              <input type="file" class="form-control" name="doc_salary_slips" multiple accept="image/*,application/pdf">
            </div>

            <div class="col-md-12">
              <label class="form-label">Other Docs / Notes</label>
              <textarea class="form-control" rows="2" placeholder="Any additional document details"></textarea>
            </div>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-primary btn-sm" onclick="saveSection('docs', this)">
            <i class="bi bi-save"></i> Save Documents
          </button>
        </div>
      </div>
    </div>

    <!-- Emergency -->
    <div class="tab-pane fade" id="emergency" role="tabpanel">
      <div class="card">
        <div class="card-header"><h6 class="form-section-title">Emergency Contacts</h6></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Primary Contact Name</label>
              <input type="text" class="form-control" name="emg_name1">
            </div>
            <div class="col-md-3">
              <label class="form-label">Relation</label>
              <input type="text" class="form-control" name="emg_relation1">
            </div>
            <div class="col-md-3">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-control" name="emg_phone1">
            </div>
            <div class="col-md-6">
              <label class="form-label">Secondary Contact Name</label>
              <input type="text" class="form-control" name="emg_name2">
            </div>
            <div class="col-md-3">
              <label class="form-label">Relation</label>
              <input type="text" class="form-control" name="emg_relation2">
            </div>
            <div class="col-md-3">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-control" name="emg_phone2">
            </div>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-primary btn-sm" onclick="saveSection('emergency', this)">
            <i class="bi bi-save"></i> Save Emergency
          </button>
        </div>
      </div>
    </div>

    <!-- Assets -->
    <div class="tab-pane fade" id="assets" role="tabpanel">
      <div class="card">
        <div class="card-header"><h6 class="form-section-title">Company Assets</h6></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Laptop</label>
              <input type="text" class="form-control" name="asset_laptop" placeholder="Model / Serial">
            </div>
            <div class="col-md-4">
              <label class="form-label">Phone</label>
              <input type="text" class="form-control" name="asset_phone" placeholder="Model / Serial">
            </div>
            <div class="col-md-4">
              <label class="form-label">Other</label>
              <input type="text" class="form-control" name="asset_other" placeholder="Access card, etc.">
            </div>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-primary btn-sm" onclick="saveSection('assets', this)">
            <i class="bi bi-save"></i> Save Assets
          </button>
        </div>
      </div>
    </div>

    <!-- Access -->
    <div class="tab-pane fade" id="access" role="tabpanel">
      <div class="card">
        <div class="card-header"><h6 class="form-section-title">System Access</h6></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Work Email</label>
              <input type="email" class="form-control" name="work_email">
            </div>
            <div class="col-md-4">
              <label class="form-label">Git/GitHub</label>
              <input type="text" class="form-control" name="github">
            </div>
            <div class="col-md-4">
              <label class="form-label">Jira/PM Tool</label>
              <input type="text" class="form-control" name="pm_tool">
            </div>
            <div class="col-md-4">
              <label class="form-label">VPN Access</label>
              <select class="form-select" name="vpn"><option>Yes</option><option>No</option></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Access Level</label>
              <select class="form-select" name="access_level"><option>User</option><option>Manager</option><option>Admin</option></select>
            </div>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-primary btn-sm" onclick="saveSection('access', this)">
            <i class="bi bi-save"></i> Save Access
          </button>
        </div>
      </div>
    </div>

    <!-- Notes -->
    <div class="tab-pane fade" id="notes" role="tabpanel">
      <div class="card">
        <div class="card-header"><h6 class="form-section-title">Notes & History</h6></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea class="form-control" rows="3" name="notes"></textarea>
            </div>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-primary btn-sm" onclick="saveSection('notes', this)">
            <i class="bi bi-save"></i> Save Notes
          </button>
        </div>
      </div>
    </div>

    <!-- Leaves -->
    <div class="tab-pane fade" id="leaves" role="tabpanel">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="form-section-title mb-0">Leave Balance</h6>
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleLeaveEdit()" id="toggleLeaveEditBtn">
            <i class="bi bi-pencil"></i> Edit Leaves
          </button>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <!-- Annual Leave Card -->
            <div class="col-lg-4 col-md-6 col-sm-6 mb-3">
              <div class="card leave-balance-card h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center flex-grow-1">
                    <div class="leave-icon success me-3">
                      <i class="bi bi-calendar3-range"></i>
                    </div>
                    <div class="flex-grow-1">
                      <div class="leave-type-name">Annual Leave</div>
                      <div class="leave-days-display" id="annual_leave_display">{% if edit_employee %}{{ edit_employee.annual_leave|default:20 }}{% else %}20{% endif %}</div>
                      <input type="number" class="form-control form-control-sm d-none leave-days-input" name="annual_leave" id="annual_leave_input" value="{% if edit_employee %}{{ edit_employee.annual_leave|default:20 }}{% else %}20{% endif %}" min="0" style="max-width: 100px; display: inline-block;">
                      <div class="leave-subtitle">Days Available</div>
                    </div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-secondary d-none leave-edit-btn" onclick="saveLeaveDays('annual_leave')" title="Save">
                    <i class="bi bi-check"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Sick Leave Card -->
            <div class="col-lg-4 col-md-6 col-sm-6 mb-3">
              <div class="card leave-balance-card h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center flex-grow-1">
                    <div class="leave-icon warning me-3">
                      <i class="bi bi-hospital"></i>
                    </div>
                    <div class="flex-grow-1">
                      <div class="leave-type-name">Sick Leave</div>
                      <div class="leave-days-display" id="sick_leave_display">{% if edit_employee %}{{ edit_employee.sick_leave|default:12 }}{% else %}12{% endif %}</div>
                      <input type="number" class="form-control form-control-sm d-none leave-days-input" name="sick_leave" id="sick_leave_input" value="{% if edit_employee %}{{ edit_employee.sick_leave|default:12 }}{% else %}12{% endif %}" min="0" style="max-width: 100px; display: inline-block;">
                      <div class="leave-subtitle">Days Available</div>
                    </div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-secondary d-none leave-edit-btn" onclick="saveLeaveDays('sick_leave')" title="Save">
                    <i class="bi bi-check"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Personal Leave Card -->
            <div class="col-lg-4 col-md-6 col-sm-6 mb-3">
              <div class="card leave-balance-card h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center flex-grow-1">
                    <div class="leave-icon info me-3">
                      <i class="bi bi-person-circle"></i>
                    </div>
                    <div class="flex-grow-1">
                      <div class="leave-type-name">Personal Leave</div>
                      <div class="leave-days-display" id="personal_leave_display">{% if edit_employee %}{{ edit_employee.personal_leave|default:5 }}{% else %}5{% endif %}</div>
                      <input type="number" class="form-control form-control-sm d-none leave-days-input" name="personal_leave" id="personal_leave_input" value="{% if edit_employee %}{{ edit_employee.personal_leave|default:5 }}{% else %}5{% endif %}" min="0" style="max-width: 100px; display: inline-block;">
                      <div class="leave-subtitle">Days Available</div>
                    </div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-secondary d-none leave-edit-btn" onclick="saveLeaveDays('personal_leave')" title="Save">
                    <i class="bi bi-check"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Maternity Leave Card -->
            <div class="col-lg-4 col-md-6 col-sm-6 mb-3">
              <div class="card leave-balance-card h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center flex-grow-1">
                    <div class="leave-icon primary me-3">
                      <i class="bi bi-heart"></i>
                    </div>
                    <div class="flex-grow-1">
                      <div class="leave-type-name">Maternity</div>
                      <div class="leave-days-display" id="maternity_leave_display">{% if edit_employee %}{{ edit_employee.maternity_leave|default:90 }}{% else %}90{% endif %}</div>
                      <input type="number" class="form-control form-control-sm d-none leave-days-input" name="maternity_leave" id="maternity_leave_input" value="{% if edit_employee %}{{ edit_employee.maternity_leave|default:90 }}{% else %}90{% endif %}" min="0" style="max-width: 100px; display: inline-block;">
                      <div class="leave-subtitle">Days Available</div>
                    </div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-secondary d-none leave-edit-btn" onclick="saveLeaveDays('maternity_leave')" title="Save">
                    <i class="bi bi-check"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Paternity Leave Card -->
            <div class="col-lg-4 col-md-6 col-sm-6 mb-3">
              <div class="card leave-balance-card h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center flex-grow-1">
                    <div class="leave-icon secondary me-3">
                      <i class="bi bi-person-badge"></i>
                    </div>
                    <div class="flex-grow-1">
                      <div class="leave-type-name">Paternity</div>
                      <div class="leave-days-display" id="paternity_leave_display">{% if edit_employee %}{{ edit_employee.paternity_leave|default:15 }}{% else %}15{% endif %}</div>
                      <input type="number" class="form-control form-control-sm d-none leave-days-input" name="paternity_leave" id="paternity_leave_input" value="{% if edit_employee %}{{ edit_employee.paternity_leave|default:15 }}{% else %}15{% endif %}" min="0" style="max-width: 100px; display: inline-block;">
                      <div class="leave-subtitle">Days Available</div>
                    </div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-secondary d-none leave-edit-btn" onclick="saveLeaveDays('paternity_leave')" title="Save">
                    <i class="bi bi-check"></i>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Emergency Leave Card -->
            <div class="col-lg-4 col-md-6 col-sm-6 mb-3">
              <div class="card leave-balance-card h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center flex-grow-1">
                    <div class="leave-icon danger me-3">
                      <i class="bi bi-lightning-charge"></i>
                    </div>
                    <div class="flex-grow-1">
                      <div class="leave-type-name">Emergency</div>
                      <div class="leave-days-display" id="emergency_leave_display">{% if edit_employee %}{{ edit_employee.emergency_leave|default:3 }}{% else %}3{% endif %}</div>
                      <input type="number" class="form-control form-control-sm d-none leave-days-input" name="emergency_leave" id="emergency_leave_input" value="{% if edit_employee %}{{ edit_employee.emergency_leave|default:3 }}{% else %}3{% endif %}" min="0" style="max-width: 100px; display: inline-block;">
                      <div class="leave-subtitle">Days Available</div>
                    </div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-secondary d-none leave-edit-btn" onclick="saveLeaveDays('emergency_leave')" title="Save">
                    <i class="bi bi-check"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="reset" class="btn btn-outline-secondary">Reset</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save Employee</button>
        </div>
      </div>
    </div>
  </div>
</form>

<!-- Employee List Table -->
<div class="mt-4">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="form-section-title mb-0">Employee List</h6>
      <div class="d-flex gap-2">
        <form method="get" class="d-flex gap-2">
        <div class="input-group input-group-sm" style="width: 250px;">
            <input type="text" class="form-control" placeholder="Search employees..." id="employeeSearch" name="search" value="{{ search_query }}">
            <button class="btn btn-outline-secondary" type="submit">
            <i class="bi bi-search"></i>
          </button>
        </div>
          {% if search_query %}
          <a href="{% url 'employees' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-clockwise"></i> Reset
          </a>
          {% endif %}
        </form>
        <button class="btn btn-primary btn-sm">
          <i class="bi bi-plus"></i> Add Employee
        </button>
      </div>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="employeeTable">
          <thead class="table-light">
            <tr>
              <th>Employee</th>
              <th>Designation</th>
              <th>Department</th>
              <th>Contact</th>
              <th>Status</th>
              <th width="120">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if employees %}
              {% for employee in employees %}
            <tr>
              <td data-label="Employee">
                <div class="d-flex align-items-center">
                  <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                      <span class="fw-bold">{{ employee.get_initials }}</span>
                  </div>
                  <div>
                      <div class="fw-semibold">{{ employee.get_full_name }}</div>
                      <small class="text-muted">{{ employee.emp_code|default:"No Code" }}</small>
                  </div>
                </div>
              </td>
              <td data-label="Designation">
                  {% if employee.designation %}
                    <span class="badge bg-info">{{ employee.designation }}</span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
              </td>
                <td data-label="Department">{{ employee.department|default:"-" }}</td>
              <td data-label="Contact">
                <div>
                    <div class="small">{{ employee.email }}</div>
                    <div class="small text-muted">{{ employee.phone|default:"-" }}</div>
                </div>
              </td>
              <td data-label="Status">
                  {% if employee.status == 'active' %}
                <span class="badge bg-success">Active</span>
                  {% elif employee.status == 'on_leave' %}
                    <span class="badge bg-warning">On Leave</span>
                  {% elif employee.status == 'inactive' %}
                    <span class="badge bg-secondary">Inactive</span>
                  {% elif employee.status == 'terminated' %}
                    <span class="badge bg-danger">Terminated</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ employee.get_status_display }}</span>
                  {% endif %}
              </td>
              <td data-label="Actions">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewEmployee({{ employee.id }})" title="View">
                    <i class="bi bi-eye"></i>
                  </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="editEmployee({{ employee.id }})" title="Edit">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteEmployee({{ employee.id }})" title="Delete">
                      <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="6" class="text-center py-4">
                  <i class="bi bi-inbox fs-1 text-muted d-block mb-2"></i>
                  <p class="text-muted">No employees found</p>
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
    {% if employees.has_other_pages %}
    <div class="card-footer">
      <div class="d-flex justify-content-between align-items-center">
        <div class="text-muted small">
          Showing {{ employees.start_index }} to {{ employees.end_index }} of {{ employees.paginator.count }} employees
        </div>
        <nav>
          <ul class="pagination pagination-sm mb-0">
            {% if employees.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">First</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ employees.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">Previous</a>
              </li>
            {% else %}
            <li class="page-item disabled">
              <a class="page-link" href="#" tabindex="-1">Previous</a>
            </li>
            {% endif %}
            
            <li class="page-item active">
              <span class="page-link">Page {{ employees.number }} of {{ employees.paginator.num_pages }}</span>
            </li>
            
            {% if employees.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ employees.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">Next</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ employees.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">Last</a>
              </li>
            {% else %}
            <li class="page-item disabled">
              <a class="page-link" href="#">Next</a>
            </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- View Employee Modal -->
<div class="modal fade" id="viewEmployeeModal" tabindex="-1" aria-labelledby="viewEmployeeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewEmployeeModalLabel">Employee Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-4 text-center mb-3">
            <div class="avatar-lg bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 80px; height: 80px;">
              <span class="fw-bold fs-4">JD</span>
            </div>
            <h6 class="mb-1">John Doe</h6>
            <small class="text-muted">EMP-001</small>
          </div>
          <div class="col-md-8">
            <div class="row g-3">
              <div class="col-sm-6">
                <label class="form-label fw-semibold">Email</label>
                <p class="mb-0">john.doe@company.com</p>
              </div>
              <div class="col-sm-6">
                <label class="form-label fw-semibold">Phone</label>
                <p class="mb-0">+91 98765 43210</p>
              </div>
              <div class="col-sm-6">
                <label class="form-label fw-semibold">Designation</label>
                <p class="mb-0">Software Engineer</p>
              </div>
              <div class="col-sm-6">
                <label class="form-label fw-semibold">Department</label>
                <p class="mb-0">IT</p>
              </div>
              <div class="col-sm-6">
                <label class="form-label fw-semibold">Joining Date</label>
                <p class="mb-0">15 Jan 2024</p>
              </div>
              <div class="col-sm-6">
                <label class="form-label fw-semibold">Status</label>
                <p class="mb-0"><span class="badge bg-success">Active</span></p>
              </div>
              <div class="col-12">
                <label class="form-label fw-semibold">Address</label>
                <p class="mb-0">123 Main Street, City, State, 12345</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('employeeForm');
    if (!form) return;
    
    // Mobile tabs menu switching
    document.querySelectorAll('.emp-tabs-menu .dropdown-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const target = item.getAttribute('data-tab');
        const tabBtn = document.querySelector(`[data-bs-target="${target}"]`);
        if (tabBtn) {
          const tab = new bootstrap.Tab(tabBtn);
          tab.show();
          const label = item.textContent.trim();
          const btn = document.getElementById('empTabsMenuBtn');
          if (btn) btn.textContent = label;
        }
      });
    });
    
    // Form validation
    form.addEventListener('submit', (e) => {
      const first = form.querySelector('[name="first_name"]').value.trim();
      const last = form.querySelector('[name="last_name"]').value.trim();
      const email = form.querySelector('[name="email"]').value.trim();
      const phone = form.querySelector('[name="phone"]').value.trim();
      const designation = form.querySelector('[name="designation"]').value.trim();
      const department = form.querySelector('[name="department"]').value.trim();
      const messages = [];
      if (!first) messages.push('First name is required');
      if (!last) messages.push('Last name is required');
      if (!email) messages.push('Email is required');
      if (!phone) messages.push('Phone is required');
      if (!designation) messages.push('Designation is required');
      if (!department) messages.push('Department is required');
      if (messages.length){
        e.preventDefault();
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger';
        alert.innerHTML = '<strong>Please fix the following:</strong><ul class="mb-0">' + messages.map(m => `<li>${m}</li>`).join('') + '</ul>';
        form.querySelectorAll('.alert-danger').forEach(x => x.remove());
        form.querySelector('.tab-pane.active .card-body').prepend(alert);
        alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });
    
    // Employee search functionality - Server-side search
    const searchInput = document.getElementById('employeeSearch');
    const searchForm = searchInput?.closest('form') || searchInput?.closest('.input-group')?.parentElement;
    
    if (searchInput) {
      let searchTimeout;
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const searchTerm = this.value.trim();
        
        // Redirect to employees page with search query
        searchTimeout = setTimeout(() => {
          const url = new URL(window.location.href);
          if (searchTerm) {
            url.searchParams.set('search', searchTerm);
          } else {
            url.searchParams.delete('search');
          }
          url.searchParams.delete('page'); // Reset to first page on new search
          window.location.href = url.toString();
        }, 500); // Debounce for 500ms
      });
      
      // Handle Enter key
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          clearTimeout(searchTimeout);
          const searchTerm = this.value.trim();
          const url = new URL(window.location.href);
          if (searchTerm) {
            url.searchParams.set('search', searchTerm);
          } else {
            url.searchParams.delete('search');
          }
          url.searchParams.delete('page');
          window.location.href = url.toString();
        }
      });
    }
    
    // Handle search button click
    const searchBtn = document.querySelector('#employeeSearch').parentElement.querySelector('button');
    if (searchBtn) {
      searchBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const searchTerm = searchInput.value.trim();
        const url = new URL(window.location.href);
        if (searchTerm) {
          url.searchParams.set('search', searchTerm);
        } else {
          url.searchParams.delete('search');
        }
        url.searchParams.delete('page');
        window.location.href = url.toString();
      });
    }
    
    // View employee
    window.viewEmployee = function(id) {
      console.log('View employee called with ID:', id);
      fetch(`/employees/${id}/view/`)
        .then(response => {
          console.log('Response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('Response data:', data);
          if (data.success && data.employee) {
            const emp = data.employee;
            
            // Update modal content
            const modal = document.getElementById('viewEmployeeModal');
            if (!modal) {
              alert('Modal not found!');
              return;
            }
            
            // Avatar and name
            const avatar = modal.querySelector('.avatar-lg span');
            const name = modal.querySelector('.col-md-4 h6');
            const code = modal.querySelector('.col-md-4 small');
            
            if (avatar) avatar.textContent = emp.initials || 'U';
            if (name) name.textContent = `${emp.first_name} ${emp.last_name}`;
            if (code) code.textContent = emp.emp_code || 'No Code';
            
            // Update all p tags directly
            const pTags = modal.querySelectorAll('.modal-body p.mb-0');
            if (pTags.length >= 7) {
              // Email
              pTags[0].textContent = emp.email || '-';
              // Phone
              pTags[1].textContent = emp.phone || '-';
              // Designation
              pTags[2].textContent = emp.designation || '-';
              // Department
              pTags[3].textContent = emp.department || '-';
              // Joining Date
              if (emp.joining_date) {
                try {
                  const joinDate = new Date(emp.joining_date);
                  pTags[4].textContent = joinDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                } catch (e) {
                  pTags[4].textContent = emp.joining_date;
                }
              } else {
                pTags[4].textContent = '-';
              }
              
              // Status badge
              const statusBadge = modal.querySelector('.col-sm-6:last-child .badge');
              if (statusBadge) {
                const statusText = emp.status === 'active' ? 'Active' : 
                                 emp.status === 'on_leave' ? 'On Leave' :
                                 emp.status === 'inactive' ? 'Inactive' :
                                 emp.status === 'terminated' ? 'Terminated' : emp.status || '-';
                statusBadge.textContent = statusText;
                statusBadge.className = 'badge ' + 
                  (emp.status === 'active' ? 'bg-success' :
                   emp.status === 'on_leave' ? 'bg-warning' :
                   emp.status === 'inactive' ? 'bg-secondary' :
                   emp.status === 'terminated' ? 'bg-danger' : 'bg-secondary');
              }
              
              // Address
              pTags[6].textContent = emp.address_current || emp.address_permanent || '-';
            }
            
            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
          } else {
            alert('Error loading employee details: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error loading employee details. Please check console for details.');
        });
    };
    
    // Edit employee
    window.editEmployee = function(id) {
      // Fetch employee data and populate form
      fetch(`/employees/${id}/view/`)
        .then(response => response.json())
        .then(data => {
          if (data.success && data.employee) {
            const emp = data.employee;
            
            // Populate form fields
            const form = document.getElementById('employeeForm');
            if (form) {
              // Set employee ID for updates
              const empIdField = document.getElementById('employee_id');
              if (empIdField) {
                empIdField.value = emp.id || '';
              }
              
              form.querySelector('[name="first_name"]').value = emp.first_name || '';
              form.querySelector('[name="last_name"]').value = emp.last_name || '';
              form.querySelector('[name="emp_code"]').value = emp.emp_code || '';
              form.querySelector('[name="email"]').value = emp.email || '';
              form.querySelector('[name="phone"]').value = emp.phone || '';
              
              if (emp.gender) form.querySelector('[name="gender"]').value = emp.gender;
              if (emp.dob) form.querySelector('[name="dob"]').value = emp.dob;
              if (emp.address_current) form.querySelector('[name="address_current"]').value = emp.address_current;
              if (emp.address_permanent) form.querySelector('[name="address_permanent"]').value = emp.address_permanent;
              
              if (emp.designation) form.querySelector('[name="designation"]').value = emp.designation;
              if (emp.department) form.querySelector('[name="department"]').value = emp.department;
              if (emp.manager) form.querySelector('[name="manager"]').value = emp.manager;
              if (emp.employment_type) form.querySelector('[name="employment_type"]').value = emp.employment_type;
              if (emp.location) form.querySelector('[name="location"]').value = emp.location;
              if (emp.joining_date) form.querySelector('[name="joining_date"]').value = emp.joining_date;
              if (emp.probation !== undefined) form.querySelector('[name="probation"]').value = emp.probation || '';
              
              // Payroll
              if (emp.ctc !== undefined) form.querySelector('[name="ctc"]').value = emp.ctc || '';
              if (emp.basic !== undefined) form.querySelector('[name="basic"]').value = emp.basic || '';
              if (emp.hra !== undefined) form.querySelector('[name="hra"]').value = emp.hra || '';
              if (emp.allowances !== undefined) form.querySelector('[name="allowances"]').value = emp.allowances || '';
              if (emp.deductions !== undefined) form.querySelector('[name="deductions"]').value = emp.deductions || '';
              if (emp.variable !== undefined) form.querySelector('[name="variable"]').value = emp.variable || '';
              if (emp.pay_cycle) form.querySelector('[name="pay_cycle"]').value = emp.pay_cycle;
              
              // Banking
              if (emp.bank_name) form.querySelector('[name="bank_name"]').value = emp.bank_name;
              if (emp.account_number) form.querySelector('[name="account_number"]').value = emp.account_number;
              if (emp.ifsc) form.querySelector('[name="ifsc"]').value = emp.ifsc;
              if (emp.upi) form.querySelector('[name="upi"]').value = emp.upi;
              if (emp.pan) form.querySelector('[name="pan"]').value = emp.pan;
              if (emp.aadhaar) form.querySelector('[name="aadhaar"]').value = emp.aadhaar;
              
              // Tax/IDs
              if (emp.uan) form.querySelector('[name="uan"]').value = emp.uan;
              if (emp.esic) form.querySelector('[name="esic"]').value = emp.esic;
              if (emp.gst) form.querySelector('[name="gst"]').value = emp.gst;
              
              // Emergency Contacts
              if (emp.emg_name1) form.querySelector('[name="emg_name1"]').value = emp.emg_name1;
              if (emp.emg_relation1) form.querySelector('[name="emg_relation1"]').value = emp.emg_relation1;
              if (emp.emg_phone1) form.querySelector('[name="emg_phone1"]').value = emp.emg_phone1;
              if (emp.emg_name2) form.querySelector('[name="emg_name2"]').value = emp.emg_name2;
              if (emp.emg_relation2) form.querySelector('[name="emg_relation2"]').value = emp.emg_relation2;
              if (emp.emg_phone2) form.querySelector('[name="emg_phone2"]').value = emp.emg_phone2;
              
              // Assets
              if (emp.asset_laptop) form.querySelector('[name="asset_laptop"]').value = emp.asset_laptop;
              if (emp.asset_phone) form.querySelector('[name="asset_phone"]').value = emp.asset_phone;
              if (emp.asset_other) form.querySelector('[name="asset_other"]').value = emp.asset_other;
              
              // Access
              if (emp.work_email) form.querySelector('[name="work_email"]').value = emp.work_email;
              if (emp.github) form.querySelector('[name="github"]').value = emp.github;
              if (emp.pm_tool) form.querySelector('[name="pm_tool"]').value = emp.pm_tool;
              if (emp.vpn) form.querySelector('[name="vpn"]').value = emp.vpn;
              if (emp.access_level) form.querySelector('[name="access_level"]').value = emp.access_level;
              
              // Notes
              if (emp.notes) form.querySelector('[name="notes"]').value = emp.notes;
              
              // Leave balances
              if (emp.annual_leave !== undefined) {
                form.querySelector('[name="annual_leave"]').value = emp.annual_leave;
                document.getElementById('annual_leave_display').textContent = emp.annual_leave;
              }
              if (emp.sick_leave !== undefined) {
                form.querySelector('[name="sick_leave"]').value = emp.sick_leave;
                document.getElementById('sick_leave_display').textContent = emp.sick_leave;
              }
              if (emp.personal_leave !== undefined) {
                form.querySelector('[name="personal_leave"]').value = emp.personal_leave;
                document.getElementById('personal_leave_display').textContent = emp.personal_leave;
              }
              if (emp.maternity_leave !== undefined) {
                form.querySelector('[name="maternity_leave"]').value = emp.maternity_leave;
                document.getElementById('maternity_leave_display').textContent = emp.maternity_leave;
              }
              if (emp.paternity_leave !== undefined) {
                form.querySelector('[name="paternity_leave"]').value = emp.paternity_leave;
                document.getElementById('paternity_leave_display').textContent = emp.paternity_leave;
              }
              if (emp.emergency_leave !== undefined) {
                form.querySelector('[name="emergency_leave"]').value = emp.emergency_leave;
                document.getElementById('emergency_leave_display').textContent = emp.emergency_leave;
              }
              
              // Scroll to top and show Personal tab
              window.scrollTo({ top: 0, behavior: 'smooth' });
              const personalTab = document.querySelector('#personal-tab');
              if (personalTab) {
                const tab = new bootstrap.Tab(personalTab);
                tab.show();
              }
              
              alert('Employee data loaded. Please review and update, then click "Save Employee" to update.');
            }
          } else {
            alert('Error loading employee data: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error loading employee data');
        });
    };
    
    // Delete employee
    window.deleteEmployee = function(id) {
      if (confirm('Are you sure you want to delete this employee? This action cannot be undone.')) {
        // Get CSRF token
        const csrftoken = getCookie('csrftoken');
        
        fetch(`/employees/${id}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert(data.message || 'Employee deleted successfully!');
              // Reload page to refresh list
              setTimeout(() => location.reload(), 500);
            } else {
              alert('Error: ' + (data.error || 'Failed to delete employee'));
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error deleting employee');
          });
      }
    };
    
    // Helper function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    
    // Save individual section
    window.saveSection = function(sectionName, buttonElement) {
      const form = document.getElementById('employeeForm');
      if (!form) {
        alert('Form not found!');
        return;
      }
      
      // Validate required fields based on section
      const messages = [];
      
      if (sectionName === 'personal') {
        const first = form.querySelector('[name="first_name"]')?.value.trim() || '';
        const last = form.querySelector('[name="last_name"]')?.value.trim() || '';
        const email = form.querySelector('[name="email"]')?.value.trim() || '';
        const phone = form.querySelector('[name="phone"]')?.value.trim() || '';
        if (!first) messages.push('First name is required');
        if (!last) messages.push('Last name is required');
        if (!email) messages.push('Email is required');
        if (!phone) messages.push('Phone is required');
      }
      
      if (messages.length > 0) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.innerHTML = '<strong>Please fix the following:</strong><ul class="mb-0">' + messages.map(m => `<li>${m}</li>`).join('') + '</ul><button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        const activeTab = document.querySelector(`#${sectionName}.tab-pane`);
        if (activeTab) {
          activeTab.querySelectorAll('.alert-danger, .alert-success').forEach(x => x.remove());
          const cardBody = activeTab.querySelector('.card-body');
          if (cardBody) {
            cardBody.prepend(alert);
            alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
        return;
      }
      
      // Get form data
      const formData = new FormData(form);
      
      // Ensure employee_id is included (important for updates)
      const empIdField = document.getElementById('employee_id');
      if (empIdField && empIdField.value) {
        formData.set('employee_id', empIdField.value);
        console.log('ðŸ“ Including employee_id for update:', empIdField.value);
      }
      
      // Log file inputs for document section
      if (sectionName === 'docs') {
        const docFields = ['doc_aadhaar', 'doc_pan', 'doc_bank', 'doc_experience', 
                          'doc_education', 'doc_prev_offer_relieve', 'doc_current_offer', 'doc_salary_slips'];
        docFields.forEach(fieldName => {
          const fileInput = form.querySelector(`[name="${fieldName}"]`);
          if (fileInput && fileInput.files && fileInput.files.length > 0) {
            console.log(`ðŸ“„ Document file selected - ${fieldName}:`, fileInput.files[0].name);
          }
        });
      }
      
      // Get CSRF token
      const csrftoken = getCookie('csrftoken');
      if (!csrftoken) {
        alert('CSRF token not found. Please refresh the page.');
        return;
      }
      
      // Show loading on save button
      const saveBtn = buttonElement || document.querySelector(`button[onclick*="saveSection('${sectionName}'"]`);
      if (!saveBtn) {
        alert('Save button not found!');
        return;
      }
      
      const originalBtnText = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
      
      // Submit via AJAX
      fetch(form.action || '/employees/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            // Success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `<strong>Success!</strong> ${data.message || 'Data saved successfully!'}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            const activeTab = document.querySelector(`#${sectionName}.tab-pane`);
            if (activeTab) {
              activeTab.querySelectorAll('.alert-success, .alert-danger').forEach(x => x.remove());
              const cardBody = activeTab.querySelector('.card-body');
              if (cardBody) {
                cardBody.prepend(alert);
                alert.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
              try {
                const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                bsAlert.close();
              } catch (e) {
                alert.remove();
              }
            }, 3000);
          } else {
            throw new Error(data.error || 'Failed to save data');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          const alert = document.createElement('div');
          alert.className = 'alert alert-danger alert-dismissible fade show';
          alert.innerHTML = `<strong>Error!</strong> ${error.message || 'Failed to save data. Please try again.'}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
          const activeTab = document.querySelector(`#${sectionName}.tab-pane`);
          if (activeTab) {
            activeTab.querySelectorAll('.alert-danger').forEach(x => x.remove());
            const cardBody = activeTab.querySelector('.card-body');
            if (cardBody) {
              cardBody.prepend(alert);
              alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        })
        .finally(() => {
          // Restore button
          if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnText;
          }
        });
    }
    
    // Show success/error messages
    {% if messages %}
      {% for message in messages %}
        alert('{{ message }}');
      {% endfor %}
    {% endif %}
  });
  
  // Toggle leave edit mode
  function toggleLeaveEdit() {
    const isEditMode = document.querySelector('.leave-days-input:not(.d-none)');
    const editMode = isEditMode === null;
    
    document.querySelectorAll('.leave-days-display').forEach(el => {
      el.classList.toggle('d-none', editMode);
    });
    
    document.querySelectorAll('.leave-days-input').forEach(el => {
      el.classList.toggle('d-none', !editMode);
    });
    
    document.querySelectorAll('.leave-edit-btn').forEach(el => {
      el.classList.toggle('d-none', !editMode);
    });
    
    const btn = document.getElementById('toggleLeaveEditBtn');
    if (btn) {
      if (editMode) {
        btn.innerHTML = '<i class="bi bi-x"></i> Cancel';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-outline-danger');
      } else {
        btn.innerHTML = '<i class="bi bi-pencil"></i> Edit Leaves';
        btn.classList.remove('btn-outline-danger');
        btn.classList.add('btn-outline-primary');
      }
    }
  }
  
  // Save individual leave days
  function saveLeaveDays(leaveType) {
    const input = document.getElementById(leaveType + '_input');
    const display = document.getElementById(leaveType + '_display');
    const btn = document.querySelector(`button[onclick*="${leaveType}"]`);
    const value = parseInt(input.value) || 0;
    
    if (value < 0) {
      alert('Leave days cannot be negative!');
      input.value = display.textContent;
      return;
    }
    
    // Update display
    display.textContent = value;
    
    // Update input value for form submission
    input.value = value;
    
    // Show success indicator
    if (btn) {
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="bi bi-check text-success"></i>';
      setTimeout(() => {
        btn.innerHTML = originalHTML;
      }, 1000);
    }
    
    // Note: Changes will be saved when the main employee form is submitted
  }
  
  // Initialize leave values from database if editing existing employee
  // This would be populated from server-side if editing
</script>
{% endblock%}