{% extends "dashboard/dashboard_base.html"%}
{% block title %}Projects - Sujata Associates{% endblock%}

{% block content %}
<div class="dashboard-header">
  <h1>Projects</h1>
  <p class="text-muted">Track projects, budgets, duration and allocations</p>
</div>

<style>
  html, body { overflow-x: hidden; }
  .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
  .kpi .value { font-size: 1.6rem; font-weight: 700; }
  .avatar { width: 28px; height: 28px; border-radius: 50%; background:#e9ecef; display:inline-flex; align-items:center; justify-content:center; font-size:.8rem; font-weight:600; }
  /* Icons-only actions on all viewports */
  .actions .btn-text { display: none; }
  .actions .btn { padding: .35rem .5rem; }
  @media (max-width: 992px){ .kpi-grid { grid-template-columns: 1fr; } }
  /* Improve table readability on small screens */
  @media (max-width: 576px){
    #projectTable td, #projectTable th { white-space: normal; }
    .actions .btn { padding: .25rem .45rem; }
    .avatar { width: 24px; height: 24px; font-size:.7rem; }
    .hide-xs { display: none; }
    /* Remove fixed width on Actions to allow wrap */
    #projectTable th[style] { width: auto !important; }
    .actions { min-width: 0; }
    .actions .btn-group { gap: .25rem; }
  }
  .table-responsive{ -webkit-overflow-scrolling: touch; }
  /* Strong mobile override to prevent right-side cut */
  @media (max-width: 768px){
    .main-content{ margin-left: 0 !important; padding: 0 !important; }
    .main-content > *{ padding: 0 1rem; }
    .card{ margin-left: 0; margin-right: 0; }
    .table-responsive{ overflow-x: auto; }
  }
  
  /* Pagination - Wrap on Mobile */
  .pagination {
    flex-wrap: wrap !important;
  }
  
  .pagination .page-item {
    margin-bottom: 0.25rem !important;
  }
  
  @media (max-width: 576px) {
    .pagination .page-link {
      padding: 0.5rem 0.75rem !important;
      font-size: 0.875rem !important;
    }
  }
</style>

<div class="kpi-grid mb-3">
  <div class="card kpi">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <div class="text-muted">Total Projects</div>
        <div class="value" id="kpiTotal">{{ status_counts.total }}</div>
      </div>
      <i class="bi bi-kanban fs-3 text-primary"></i>
    </div>
  </div>
  <div class="card kpi">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <div class="text-muted">Active</div>
        <div class="value" id="kpiProgress">{{ status_counts.active }}</div>
      </div>
      <i class="bi bi-hourglass-split fs-3 text-warning"></i>
    </div>
  </div>
  <div class="card kpi">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <div class="text-muted">Completed</div>
        <div class="value" id="kpiCompleted">{{ status_counts.completed }}</div>
      </div>
      <i class="bi bi-check2-circle fs-3 text-success"></i>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
    <h6 class="mb-0">Projects List</h6>
    <div class="d-flex gap-2 flex-wrap">
      <form method="get" class="d-flex gap-2 flex-wrap">
        <select name="status" class="form-select form-select-sm" style="width:150px;" onchange="this.form.submit()">
          <option value="">All Status</option>
          <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
          <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
          <option value="on_hold" {% if status_filter == 'on_hold' %}selected{% endif %}>On Hold</option>
          <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
        </select>
        <div class="input-group input-group-sm" style="width:260px;">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input name="search" type="text" class="form-control" placeholder="Search project name" value="{{ search_query }}">
        </div>
        <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-search"></i> Search</button>
        {% if search_query or status_filter %}
        <a href="{% url 'project_management' %}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-clockwise"></i> Reset</a>
        {% endif %}
      </form>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0" id="projectTable">
        <thead class="table-light">
          <tr>
            <th>Client Name</th>
            <th>Project</th>
            <th>Status</th>
            <th class="hide-xs">Budget</th>
            <th class="hide-xs">Duration</th>
            <th>Assigned To</th>
            <th style="width: 200px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% if client_onboarding_list %}
            {% for project in client_onboarding_list %}
            <tr>
              <td>
                <div class="fw-bold">{{ project.client_name }}</div>
                {% if project.company_name %}
                <small class="text-muted">{{ project.company_name }}</small>
                {% endif %}
              </td>
              <td>
                <div class="fw-bold">{{ project.project_name }}</div>
                {% if project.project_description %}
                <small class="text-muted">{{ project.project_description|truncatewords:10 }}</small>
                {% endif %}
              </td>
              <td>
                {% if project.status == 'completed' %}
                  <span class="badge bg-success-subtle text-success">Completed</span>
                {% elif project.status == 'active' %}
                  <span class="badge bg-primary-subtle text-primary">Active</span>
                {% elif project.status == 'pending' %}
                  <span class="badge bg-warning-subtle text-warning">Pending</span>
                {% elif project.status == 'on_hold' %}
                  <span class="badge bg-secondary-subtle text-secondary">On Hold</span>
                {% else %}
                  <span class="badge bg-light text-dark">{{ project.get_status_display }}</span>
                {% endif %}
              </td>
              <td class="hide-xs">
                ₹{{ project.project_cost|floatformat:2 }}
              </td>
              <td class="hide-xs">
                {{ project.project_duration }} {{ project.get_duration_unit_display }}
              </td>
              <td>
                {% if project.assigned_engineer %}
                <span class="avatar" title="{{ project.assigned_engineer }}">
                  {{ project.assigned_engineer|slice:":2"|upper }}
                </span>
                <small class="ms-2">{{ project.assigned_engineer }}</small>
                {% else %}
                <span class="text-muted">Unassigned</span>
                {% endif %}
              </td>
              <td class="actions">
                <div class="btn-group btn-group-sm flex-wrap">
                  <button class="btn btn-outline-primary" onclick="viewProject({{ project.id }})" title="View"><i class="bi bi-eye"></i></button>
                  <button class="btn btn-outline-secondary" onclick="editProject({{ project.id }})" title="Edit"><i class="bi bi-pencil"></i></button>
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="7" class="text-center py-4">
                <i class="bi bi-inbox fs-1 text-muted d-block mb-2"></i>
                <p class="text-muted">No projects found</p>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Pagination -->
  {% if client_onboarding_list.has_other_pages and total_projects > 10 %}
  <div class="card-footer">
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center mb-0 flex-wrap">
        {% if client_onboarding_list.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
              <i class="bi bi-chevron-double-left"></i>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ client_onboarding_list.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
              <i class="bi bi-chevron-left"></i>
            </a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link"><i class="bi bi-chevron-double-left"></i></span>
          </li>
          <li class="page-item disabled">
            <span class="page-link"><i class="bi bi-chevron-left"></i></span>
          </li>
        {% endif %}
        
        <li class="page-item active">
          <span class="page-link">Page {{ client_onboarding_list.number }} of {{ client_onboarding_list.paginator.num_pages }}</span>
        </li>
        
        {% if client_onboarding_list.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ client_onboarding_list.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
              <i class="bi bi-chevron-right"></i>
            </a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ client_onboarding_list.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
              <i class="bi bi-chevron-double-right"></i>
            </a>
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link"><i class="bi bi-chevron-right"></i></span>
          </li>
          <li class="page-item disabled">
            <span class="page-link"><i class="bi bi-chevron-double-right"></i></span>
          </li>
        {% endif %}
      </ul>
    </nav>
  </div>
  {% endif %}
</div>

<!-- View Project Modal -->
<div class="modal fade" id="viewProjectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-eye me-2"></i>Project Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <strong>Client Name:</strong>
            <p id="view-client-name">-</p>
          </div>
          <div class="col-md-6">
            <strong>Company Name:</strong>
            <p id="view-company-name">-</p>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6">
            <strong>Client Email:</strong>
            <p id="view-client-email">-</p>
          </div>
          <div class="col-md-6">
            <strong>Client Phone:</strong>
            <p id="view-client-phone">-</p>
          </div>
        </div>
        <hr>
        <div class="row mb-3">
          <div class="col-md-6">
            <strong>Project Name:</strong>
            <p id="view-project-name">-</p>
          </div>
          <div class="col-md-6">
            <strong>Status:</strong>
            <p id="view-status">-</p>
          </div>
        </div>
        <div class="mb-3">
          <strong>Project Description:</strong>
          <p id="view-project-description" class="text-muted">-</p>
        </div>
        <div class="row mb-3">
          <div class="col-md-4">
            <strong>Project Cost:</strong>
            <p id="view-project-cost">-</p>
          </div>
          <div class="col-md-4">
            <strong>Duration:</strong>
            <p id="view-duration">-</p>
          </div>
          <div class="col-md-4">
            <strong>Start Date:</strong>
            <p id="view-start-date">-</p>
          </div>
        </div>
        <hr>
        <div class="row mb-3">
          <div class="col-md-6">
            <strong>Assigned Engineer:</strong>
            <p id="view-assigned-engineer">-</p>
          </div>
        </div>
        <div class="row">
          <div class="col-md-6">
            <strong>Created At:</strong>
            <p id="view-created-at" class="text-muted small">-</p>
          </div>
          <div class="col-md-6">
            <strong>Last Updated:</strong>
            <p id="view-updated-at" class="text-muted small">-</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Project Modal -->
<div class="modal fade" id="editProjectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editProjectForm">
        <div class="modal-body">
          <input type="hidden" id="edit-project-id" name="project_id">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Client Name *</label>
              <input type="text" class="form-control" id="edit-client-name" name="client_name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Company Name</label>
              <input type="text" class="form-control" id="edit-company-name" name="company_name">
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Client Email</label>
              <input type="email" class="form-control" id="edit-client-email" name="client_email">
            </div>
            <div class="col-md-6">
              <label class="form-label">Client Phone</label>
              <input type="text" class="form-control" id="edit-client-phone" name="client_phone">
            </div>
          </div>
          <hr>
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Project Name *</label>
              <input type="text" class="form-control" id="edit-project-name" name="project_name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Status *</label>
              <select class="form-select" id="edit-status" name="status" required>
                <option value="active">Active</option>
                <option value="pending">Pending</option>
                <option value="on_hold">On Hold</option>
                <option value="completed">Completed</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Project Description</label>
            <textarea class="form-control" id="edit-project-description" name="project_description" rows="3"></textarea>
          </div>
          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label">Project Cost (₹) *</label>
              <input type="number" step="0.01" min="0" class="form-control" id="edit-project-cost" name="project_cost" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Duration *</label>
              <input type="number" min="1" class="form-control" id="edit-project-duration" name="project_duration" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Duration Unit *</label>
              <select class="form-select" id="edit-duration-unit" name="duration_unit" required>
                <option value="days">Days</option>
                <option value="weeks">Weeks</option>
                <option value="months">Months</option>
                <option value="years">Years</option>
              </select>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Assigned Engineer *</label>
              <input type="text" class="form-control" id="edit-assigned-engineer" name="assigned_engineer" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-control" id="edit-start-date" name="start_date">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // View project details
  function viewProject(id) {
    fetch(`/project-management/${id}/view/`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert('Error: ' + data.error);
          return;
        }

        // Populate modal with project data
        document.getElementById('view-client-name').textContent = data.client_name || '-';
        document.getElementById('view-company-name').textContent = data.company_name || '-';
        document.getElementById('view-client-email').textContent = data.client_email || '-';
        document.getElementById('view-client-phone').textContent = data.client_phone || '-';
        document.getElementById('view-project-name').textContent = data.project_name || '-';
        document.getElementById('view-project-description').textContent = data.project_description || '-';
        document.getElementById('view-project-cost').innerHTML = `<strong>₹${parseFloat(data.project_cost || 0).toFixed(2)}</strong>`;
        document.getElementById('view-duration').textContent = data.duration_display || '-';
        document.getElementById('view-assigned-engineer').textContent = data.assigned_engineer || '-';
        document.getElementById('view-start-date').textContent = data.start_date_display || '-';
        document.getElementById('view-created-at').textContent = data.created_at || '-';
        document.getElementById('view-updated-at').textContent = data.updated_at || '-';
        
        // Status badge
        let statusBadge = '';
        if (data.status === 'completed') {
          statusBadge = '<span class="badge bg-success-subtle text-success">Completed</span>';
        } else if (data.status === 'active') {
          statusBadge = '<span class="badge bg-primary-subtle text-primary">Active</span>';
        } else if (data.status === 'pending') {
          statusBadge = '<span class="badge bg-warning-subtle text-warning">Pending</span>';
        } else if (data.status === 'on_hold') {
          statusBadge = '<span class="badge bg-secondary-subtle text-secondary">On Hold</span>';
        } else {
          statusBadge = '<span class="badge bg-light text-dark">' + (data.status_display || '-') + '</span>';
        }
        document.getElementById('view-status').innerHTML = statusBadge;

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('viewProjectModal'));
        modal.show();
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error loading project details');
      });
  }

  // Edit project
  function editProject(id) {
    // Fetch project data and populate edit form
    fetch(`/project-management/${id}/view/`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert('Error: ' + data.error);
          return;
        }

        // Populate edit form with current data
        document.getElementById('edit-project-id').value = data.id;
        document.getElementById('edit-client-name').value = data.client_name || '';
        document.getElementById('edit-company-name').value = data.company_name || '';
        document.getElementById('edit-client-email').value = data.client_email || '';
        document.getElementById('edit-client-phone').value = data.client_phone || '';
        document.getElementById('edit-project-name').value = data.project_name || '';
        document.getElementById('edit-project-description').value = data.project_description || '';
        document.getElementById('edit-project-cost').value = parseFloat(data.project_cost || 0).toFixed(2);
        document.getElementById('edit-project-duration').value = data.project_duration || '';
        document.getElementById('edit-duration-unit').value = data.duration_unit || 'months';
        document.getElementById('edit-assigned-engineer').value = data.assigned_engineer || '';
        document.getElementById('edit-status').value = data.status || 'active';
        document.getElementById('edit-start-date').value = data.start_date || '';

        // Show edit modal
        const modal = new bootstrap.Modal(document.getElementById('editProjectModal'));
        modal.show();
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error loading project details for editing');
      });
  }

  // Handle edit form submission
  document.getElementById('editProjectForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const projectId = document.getElementById('edit-project-id').value;
    const formData = new FormData(this);
    
    // Get CSRF token
    const csrftoken = getCookie('csrftoken');
    formData.append('csrfmiddlewaretoken', csrftoken);
    
    fetch(`/project-management/${projectId}/update/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken
      },
      body: formData
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message || 'Project updated successfully!');
          const modal = bootstrap.Modal.getInstance(document.getElementById('editProjectModal'));
          modal.hide();
          // Reload page to show updated data
          setTimeout(() => location.reload(), 500);
        } else {
          alert(data.error || 'Failed to update project');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error updating project');
      });
  });

  // Helper function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Legacy code - keeping for modal if needed
  document.addEventListener('DOMContentLoaded', () => {
    // Demo employees
    const employees = [
      { id: 1, name: 'John Doe' },
      { id: 2, name: 'Jane Smith' },
      { id: 3, name: 'Mike Johnson' },
      { id: 4, name: 'Priya Sharma' }
    ];

    // Storage helpers
    function loadProjects(){
      try { return JSON.parse(localStorage.getItem('projects_demo') || '[]'); }
      catch { return []; }
    }
    function saveProjects(list){
      localStorage.setItem('projects_demo', JSON.stringify(list));
    }

    // Seed if empty
    if (loadProjects().length === 0){
      saveProjects([
        { id: 1, name: 'Website Revamp', status: 'IN_PROGRESS', budget: 150000, durationDays: 30, assignees: [1,2] },
        { id: 2, name: 'Mobile App MVP', status: 'COMPLETED', budget: 220000, durationDays: 45, assignees: [3] }
      ]);
    }

    // UI elements
    const statusFilter = document.getElementById('statusFilter');
    const searchBox = document.getElementById('searchBox');
    const tbody = document.querySelector('#projectTable tbody');
    const kpiTotal = document.getElementById('kpiTotal');
    const kpiProgress = document.getElementById('kpiProgress');
    const kpiCompleted = document.getElementById('kpiCompleted');
    const newProjectBtn = document.getElementById('newProjectBtn');

    // Modal elements
    const assignModalEl = document.getElementById('assignModal');
    const assignModal = new bootstrap.Modal(assignModalEl);
    const assignTitle = document.getElementById('assignTitle');
    const projNameInput = document.getElementById('projNameInput');
    const projBudgetInput = document.getElementById('projBudgetInput');
    const projDurationInput = document.getElementById('projDurationInput');
    const projStatusInput = document.getElementById('projStatusInput');
    const employeeSelect = document.getElementById('employeeSelect');
    const saveAssignBtn = document.getElementById('saveAssignBtn');
    let editingId = null;

    // Populate employees select
    function renderEmployeeOptions(selectedIds){
      employeeSelect.innerHTML = '';
      employees.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.id;
        opt.textContent = e.name;
        if (selectedIds && selectedIds.includes(e.id)) opt.selected = true;
        employeeSelect.appendChild(opt);
      });
    }

    function formatCurrency(n){
      if (n === undefined || n === null) return '—';
      return new Intl.NumberFormat(undefined, { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(n);
    }

    function nameInitials(name){
      return (name||'')
        .split(' ')
        .map(p => p[0])
        .join('')
        .slice(0,2)
        .toUpperCase();
    }

    function renderKPIs(list){
      kpiTotal.textContent = list.length;
      kpiProgress.textContent = list.filter(x => x.status === 'IN_PROGRESS').length;
      kpiCompleted.textContent = list.filter(x => x.status === 'COMPLETED').length;
    }

    function renderTable(){
      const list = loadProjects();
      renderKPIs(list);
      const q = (searchBox.value || '').toLowerCase();
      const filtered = list
        .filter(p => statusFilter.value === 'ALL' || p.status === statusFilter.value)
        .filter(p => !q || p.name.toLowerCase().includes(q));

      tbody.innerHTML = '';
      filtered.forEach(p => {
        const tr = document.createElement('tr');
        const assignees = p.assignees?.map(id => employees.find(e => e.id === id)?.name).filter(Boolean) || [];
        const avatars = assignees.length
          ? assignees.map(n => `<span class="avatar" title="${n}">${nameInitials(n)}</span>`).join(' ')
          : '<span class="text-muted">Unassigned</span>';
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.status === 'COMPLETED' ? '<span class="badge bg-success-subtle text-success">Completed</span>' : '<span class="badge bg-warning-subtle text-warning">In Progress</span>'}</td>
          <td class="hide-xs">${formatCurrency(p.budget)}</td>
          <td class="hide-xs">${p.durationDays ? p.durationDays + ' days' : '—'}</td>
          <td>${avatars}</td>
          <td class="actions">
            <div class="btn-group btn-group-sm flex-wrap">
              <button class="btn btn-outline-primary" data-action="assign" data-id="${p.id}" title="Assign"><i class="bi bi-person-plus"></i></button>
              <button class="btn btn-outline-secondary" data-action="edit" data-id="${p.id}" title="Edit"><i class="bi bi-pencil"></i></button>
              ${p.status !== 'COMPLETED' ? `<button class=\"btn btn-outline-success\" data-action=\"complete\" data-id=\"${p.id}\" title=\"Complete\"><i class=\"bi bi-check2\"></i></button>` : ''}
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Table actions
    tbody.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button[data-action]');
      if (!btn) return;
      const id = Number(btn.getAttribute('data-id'));
      const action = btn.getAttribute('data-action');
      const list = loadProjects();
      const proj = list.find(x => x.id === id);
      if (!proj) return;

      if (action === 'complete'){
        proj.status = 'COMPLETED';
        saveProjects(list); renderTable(); return;
      }

      if (action === 'assign' || action === 'edit'){
        editingId = id;
        assignTitle.textContent = action === 'assign' ? 'Assign Employees' : 'Edit Project';
        projNameInput.value = proj.name || '';
        projBudgetInput.value = proj.budget || '';
        projDurationInput.value = proj.durationDays || '';
        projStatusInput.value = proj.status || 'IN_PROGRESS';
        renderEmployeeOptions([...(proj.assignees||[])]);
        assignModal.show();
      }
    });

    // Add new project
    newProjectBtn.addEventListener('click', () => {
      editingId = null;
      assignTitle.textContent = 'New Project';
      projNameInput.value = '';
      projBudgetInput.value = '';
      projDurationInput.value = '';
      projStatusInput.value = 'IN_PROGRESS';
      renderEmployeeOptions([]);
      assignModal.show();
    });

    // Save modal
    saveAssignBtn.addEventListener('click', () => {
      const name = (projNameInput.value || '').trim();
      const budget = Number(projBudgetInput.value || '0');
      const durationDays = Number(projDurationInput.value || '0');
      const statusVal = projStatusInput.value || 'IN_PROGRESS';
      const assignees = Array.from(employeeSelect.selectedOptions).map(o => Number(o.value));
      if (!name){ alert('Please enter project name'); return; }
      const list = loadProjects();
      if (editingId){
        const p = list.find(x => x.id === editingId);
        if (p){ p.name = name; p.budget = budget; p.durationDays = durationDays; p.assignees = assignees; p.status = statusVal || 'IN_PROGRESS'; }
      } else {
        list.unshift({ id: Date.now(), name, budget, durationDays, assignees, status: statusVal || 'IN_PROGRESS' });
      }
      saveProjects(list);
      assignModal.hide();
      renderTable();
    });

    // Filters
    statusFilter.addEventListener('change', renderTable);
    searchBox.addEventListener('input', renderTable);

    // Initial render
    renderEmployeeOptions([]);
    renderTable();
  });
</script>
{% endblock %}


