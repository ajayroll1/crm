{% extends "employee/base.html" %}
{% block title %}Quotes - Sujata Associates{% endblock %}
{% block page_title %}{% endblock %}
{% block mobile_title %}{% endblock %}

{% block content %}
<!-- Display messages -->
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %}

<div class="dashboard-header d-flex align-items-center justify-content-between mb-4">
  <div>
    <h1>Quotes & Onboarding</h1>
    <p class="text-muted">Manage quotes and client onboarding</p>
  </div>
</div>

<style>
  .nav-tabs .nav-link { color: #000 !important; }
  .nav-tabs .nav-link.active { color: #000 !important; }
  .nav-tabs .nav-link:hover { color: #fff !important; background-color: var(--primary-color) !important; }

  /* Mobile Responsive Styles */
  @media (max-width: 768px) {
    .dashboard-header { flex-direction: column; align-items: flex-start !important; }
    .dashboard-header h1 { font-size: 1.5rem; }
    .form-row { flex-direction: column; }
    .form-row .col-md-6, .form-row .col-md-4, .form-row .col-md-3 { width: 100% !important; max-width: 100% !important; margin-bottom: 1rem; }
    
    /* Responsive Table - Convert to Card Layout */
    .table-responsive { overflow-x: visible; }
    .table thead { display: none; }
    .table, .table tbody, .table tr, .table td { display: block; width: 100%; }
    .table tr { border: 1px solid #dee2e6; margin-bottom: 1rem; border-radius: 0.5rem; padding: 0.75rem; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .table td { 
      border: none; 
      padding: 0.75rem 0; 
      position: relative; 
      padding-left: 45%; 
      text-align: right; 
      min-height: 2rem;
      display: flex; 
      align-items: center; 
      justify-content: flex-end;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .table td:before { 
      content: attr(data-label); 
      position: absolute; 
      left: 0; 
      width: 40%; 
      padding-right: 10px; 
      font-weight: 600; 
      color: #495057;
      text-align: left;
      display: flex;
      align-items: center;
    }
    .table td:last-child { border-bottom: 0; }
    
    /* Action buttons in table */
    .table td[data-label="Actions"] { 
      padding-left: 0; 
      padding-top: 1rem;
      justify-content: center;
    }
    .table td[data-label="Actions"]:before { display: none; }
    .table td .btn-group { 
      flex-direction: row; 
      width: 100%; 
      justify-content: center; 
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .table td .btn-group .btn { width: auto; flex: 1; min-width: 80px; }
    
    .btn-group { flex-direction: column; width: 100%; }
    .btn-group .btn { width: 100%; margin-bottom: 0.5rem; }
    .card { margin-bottom: 1rem; }
    .items-table { font-size: 0.8rem; }
    .items-table th, .items-table td { padding: 0.5rem; }
    
    /* Nav tabs - stack vertically */
    .nav-tabs { flex-direction: column; }
    .nav-tabs .nav-link { width: 100%; margin-bottom: 0.25rem; }
    
    /* Modal adjustments */
    .modal-dialog { margin: 0.5rem; }
    .modal-content { border-radius: 0.5rem; }
    
    /* Form adjustments */
    .row.mb-3 { margin-bottom: 0.75rem !important; }
    .col-md-6 { margin-bottom: 0.5rem; }
  }
  
  @media (max-width: 576px) {
    .dashboard-header h1 { font-size: 1.25rem; }
    .card-body { padding: 0.75rem; }
    .btn { padding: 0.5rem 1rem; font-size: 0.875rem; }
    .table td { 
      padding-left: 40%; 
      font-size: 0.875rem;
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
    }
    .table td:before { 
      width: 35%; 
      font-size: 0.8rem;
      padding-right: 8px;
    }
    .table tr { padding: 0.5rem; }
    .modal-body { padding: 1rem; }
    .modal-body .row { margin-bottom: 0.5rem !important; }
    .modal-body .col-md-6 { padding: 0.25rem 0; }
  }
  
  /* Extra small devices */
  @media (max-width: 375px) {
    .dashboard-header h1 { font-size: 1.1rem; }
    .card-body { padding: 0.5rem; }
    .btn { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
    .table td { 
      padding-left: 35%; 
      font-size: 0.8rem; 
      padding-top: 0.4rem;
      padding-bottom: 0.4rem;
    }
    .table td:before { 
      width: 30%; 
      font-size: 0.75rem; 
      padding-right: 5px;
    }
    .table tr { padding: 0.4rem; }
  }
</style>

<!-- Tabs: List | Create Quote | Onboarding -->
<ul class="nav nav-tabs mb-4" id="quotesTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab">
      <i class="bi bi-list-ul"></i> List
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create" type="button" role="tab">
      <i class="bi bi-plus-circle"></i> Create Quote
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="onboard-tab" data-bs-toggle="tab" data-bs-target="#onboard" type="button" role="tab">
      <i class="bi bi-person-plus"></i> Onboarding
    </button>
  </li>
</ul>

<div class="tab-content" id="quotesTabsContent">
  <!-- List Tab -->
  <div class="tab-pane fade show active" id="list" role="tabpanel">
    <div class="row">
      <!-- Quotes List -->
      <div class="col-12 col-lg-6 mb-4">
    <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Quotes</h5>
        </div>
          <div class="card-body">
        <div class="table-responsive">
              <table class="table table-hover">
                <thead>
              <tr>
                <th>Quote #</th>
                <th>Client</th>
                <th>Total</th>
                    <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
                <tbody>
              {% for quote in quotes %}
                  <tr>
                <td data-label="Quote #">{{ quote.quote_number }}</td>
                <td data-label="Client">{{ quote.client_name }}</td>
                    <td data-label="Total">₹{{ quote.total }}</td>
                <td data-label="Status"><span class="badge {{ quote.get_status_badge_class }}">{{ quote.status }}</span></td>
                <td data-label="Actions">
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="viewQuote({{ quote.id }})" title="View">
                          <i class="bi bi-eye"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="deleteQuote({{ quote.id }})" title="Delete">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                    <td colspan="5" class="text-center text-muted">No quotes found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Onboarding List -->
      <div class="col-12 col-lg-6 mb-4">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Onboarding</h5>
      </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Client</th>
                    <th>Project</th>
                    <th>Cost</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for onboard in onboardings %}
                  <tr>
                    <td data-label="Client">{{ onboard.client_name }}</td>
                    <td data-label="Project">{{ onboard.project_name }}</td>
                    <td data-label="Cost">₹{{ onboard.project_cost }}</td>
                    <td data-label="Status"><span class="badge {{ onboard.get_status_badge_class }}">{{ onboard.status }}</span></td>
                    <td data-label="Actions">
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="viewOnboard({{ onboard.id }})" title="View">
                          <i class="bi bi-eye"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="deleteOnboard({{ onboard.id }})" title="Delete">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                  {% empty %}
                  <tr>
                    <td colspan="5" class="text-center text-muted">No onboarding found</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Quote Tab -->
  <div class="tab-pane fade" id="create" role="tabpanel">
      <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Create Quote</h5>
        </div>
        <div class="card-body">
        <form id="quote-form" method="post" action="{% url 'employee_quotes' %}" enctype="multipart/form-data">
          {% csrf_token %}
          
          <div class="row mb-3">
            <div class="col-12 col-md-6 mb-2 mb-md-0">
              <label class="form-label">Client Name <span class="text-danger">*</span></label>
              <select class="form-select" name="client_name" id="create_client_name" required onchange="fillCreateClientDetails(this)">
                <option value="">Select Client (from Leads)</option>
                {% for lead in leads_for_quote %}
                  <option value="{{ lead.name }}"
                          data-company="{{ lead.company|default:'' }}"
                          data-email="{{ lead.email|default:'' }}"
                          data-phone="{{ lead.phone|default:'' }}"
                          {% if lead.has_sent %}disabled title="Already sent"{% endif %}>
                    {{ lead.name }}{% if lead.company %} - {{ lead.company }}{% endif %}{% if lead.has_sent %} (Already Sent){% endif %}
                  </option>
                {% endfor %}
              </select>
              <small class="text-muted">List pulled from Leads. If a quote was sent earlier, it is marked as “Already Sent”.</small>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Company</label>
              <input type="text" class="form-control" name="company" id="create_company">
            </div>
            </div>

          <div class="row mb-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" name="email" id="create_email">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-control" name="phone" id="create_phone">
            </div>
            </div>

          <div class="row mb-3">
            <div class="col-12 col-md-4">
              <label class="form-label">Quote Number</label>
              <input type="text" class="form-control" name="quote_number" placeholder="Auto-generated if empty">
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Owner <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="owner" required>
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Valid Until <span class="text-danger">*</span></label>
              <input type="date" class="form-control" name="valid_until" required>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Status</label>
              <select class="form-select" name="status">
                <option value="Draft">Draft</option>
                <option value="Sent" selected>Sent</option>
                <option value="Accepted">Accepted</option>
                <option value="Declined">Declined</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Currency</label>
              <select class="form-select" name="currency">
                <option value="INR" selected>INR (₹)</option>
                <option value="USD">USD ($)</option>
                <option value="EUR">EUR (€)</option>
              </select>
            </div>
          </div>

          <!-- Line Items -->
          <div class="mb-3">
            <label class="form-label">Line Items</label>
          <div class="table-responsive">
              <table class="table table-sm items-table">
                <thead>
                  <tr>
                    <th>Description</th>
                    <th>Qty</th>
                    <th>Unit Price</th>
                    <th>GST %</th>
                    <th>Amount</th>
                    <th>Action</th>
                </tr>
              </thead>
                <tbody id="items-tbody">
                  <tr>
                    <td><input type="text" class="form-control form-control-sm item-desc" placeholder="Item description"></td>
                    <td><input type="number" class="form-control form-control-sm item-qty" value="1" min="1"></td>
                    <td><input type="number" class="form-control form-control-sm item-price" step="0.01" placeholder="0.00"></td>
                    <td><input type="number" class="form-control form-control-sm item-gst" value="0" step="0.01"></td>
                    <td><input type="text" class="form-control form-control-sm item-amount" readonly></td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeItem(this)"><i class="bi bi-trash"></i></button></td>
                </tr>
                </tbody>
            </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addItem()">
              <i class="bi bi-plus"></i> Add Item
            </button>
          </div>

          <div class="row mb-3">
            <div class="col-12 col-md-4">
              <label class="form-label">Subtotal</label>
              <input type="text" class="form-control" name="subtotal" id="subtotal" readonly value="0.00">
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Discount</label>
              <input type="number" class="form-control" name="discount" id="discount" step="0.01" value="0.00" onchange="calculateTotal()">
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Total</label>
              <input type="text" class="form-control" name="total" id="total" readonly value="0.00">
          </div>
        </div>
          
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea class="form-control" name="notes" rows="3"></textarea>
        </div>
  </div>

          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">Terms & Conditions</label>
              <textarea class="form-control" name="terms" rows="3"></textarea>
        </div>
      </div>
          
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">Project PDF</label>
              <input type="file" class="form-control" name="project_pdf" accept=".pdf">
        </div>
      </div>
      
          <input type="hidden" name="items_data" id="items_data" value="[]">
          <button type="submit" name="quote_submit" class="btn btn-primary">
            <i class="bi bi-save"></i> Save Quote
          </button>
        </form>
      </div>
    </div>
    </div>

  <!-- Onboarding Tab -->
  <div class="tab-pane fade" id="onboard" role="tabpanel">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Client Onboarding</h5>
      </div>
      <div class="card-body">
        <form id="onboard-form" method="post" action="{% url 'employee_quotes' %}">
          {% csrf_token %}
          
          <div class="row mb-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Client Name <span class="text-danger">*</span></label>
              <select class="form-select" name="client_name" id="onboard_client_name" required onchange="fillClientDetails(this)">
                <option value="">Select Client</option>
                {% for client in available_clients %}
                  <option value="{{ client.0 }}" 
                          data-company="{{ client.1|default:'' }}" 
                          data-email="{{ client.2|default:'' }}" 
                          data-phone="{{ client.3|default:'' }}">
                    {{ client.0 }}{% if client.1 %} - {{ client.1 }}{% endif %}
                  </option>
                {% endfor %}
              </select>
              {% if not available_clients %}
                <small class="text-muted">No available clients from quotes. All clients are already onboarded.</small>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Company Name</label>
              <input type="text" class="form-control" name="company_name" id="onboard_company_name">
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" name="client_email" id="onboard_client_email">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Phone</label>
              <input type="tel" class="form-control" name="client_phone" id="onboard_client_phone">
            </div>
            </div>
          
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">Project Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="project_name" required>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">Project Description</label>
              <textarea class="form-control" name="project_description" rows="3"></textarea>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-12 col-md-4">
              <label class="form-label">Duration <span class="text-danger">*</span></label>
              <input type="number" class="form-control" name="project_duration" required min="1">
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Duration Unit</label>
              <select class="form-select" name="duration_unit">
                  <option value="days">Days</option>
                  <option value="weeks">Weeks</option>
                  <option value="months" selected>Months</option>
                  <option value="years">Years</option>
                </select>
              </div>
            <div class="col-12 col-md-4">
              <label class="form-label">Project Cost <span class="text-danger">*</span></label>
              <input type="number" class="form-control" name="project_cost" required step="0.01" min="0">
            </div>
            </div>
          
          <div class="row mb-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Assigned Engineer <span class="text-danger">*</span></label>
              <select class="form-select" name="assigned_engineer" id="assigned_engineer" required>
                <option value="">Select Engineer</option>
                {% for engineer in engineers %}
                  <option value="{{ engineer.name }}">
                    {{ engineer.name }}{% if engineer.designation %} ({{ engineer.designation }}){% endif %} - {{ engineer.project_count }} project{{ engineer.project_count|pluralize }}
                  </option>
                {% endfor %}
              </select>
              {% if not engineers %}
                <small class="text-muted">No engineers found in Engineering department.</small>
              {% endif %}
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-control" name="start_date">
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Status</label>
              <select class="form-select" name="status">
                <option value="active" selected>Active</option>
                <option value="pending">Pending</option>
                <option value="on_hold">On Hold</option>
                <option value="completed">Completed</option>
              </select>
            </div>
            </div>
          
          <button type="submit" name="onboard_submit" class="btn btn-primary">
            <i class="bi bi-save"></i> Save Onboarding
            </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- View Quote Modal -->
<div class="modal fade" id="viewQuoteModal" tabindex="-1" aria-labelledby="viewQuoteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewQuoteModalLabel">Quote Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6"><strong>Quote Number:</strong></div>
          <div class="col-md-6" id="view-quote-number">-</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Client Name:</strong></div>
          <div class="col-md-6" id="view-client-name">-</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Company:</strong></div>
          <div class="col-md-6" id="view-company">-</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Email:</strong></div>
          <div class="col-md-6" id="view-email">-</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Phone:</strong></div>
          <div class="col-md-6" id="view-phone">-</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Owner/Assignee:</strong></div>
          <div class="col-md-6" id="view-owner">-</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Status:</strong></div>
          <div class="col-md-6" id="view-status">-</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Currency:</strong></div>
          <div class="col-md-6" id="view-currency">-</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Valid Until:</strong></div>
          <div class="col-md-6" id="view-valid-until">-</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Subtotal:</strong></div>
          <div class="col-md-6" id="view-subtotal">-</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Discount:</strong></div>
          <div class="col-md-6" id="view-discount">-</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Total:</strong></div>
          <div class="col-md-6" id="view-total">-</div>
        </div>
        <hr>
        <div class="row mb-3">
          <div class="col-12"><strong>Quote Items:</strong></div>
          <div class="col-12 mt-2">
            <div class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead>
                  <tr>
                    <th>Description</th>
                    <th>Qty</th>
                    <th>Unit Price</th>
                    <th>GST %</th>
                    <th>Amount</th>
                  </tr>
                </thead>
                <tbody id="view-items-body">
                  <tr><td colspan="5" class="text-center text-muted">No items</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Notes:</strong></div>
          <div class="col-md-6" id="view-notes">-</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Terms & Conditions:</strong></div>
          <div class="col-md-6" id="view-terms">-</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Project PDF:</strong></div>
          <div class="col-md-6" id="view-project-pdf">-</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Created At:</strong></div>
          <div class="col-md-6" id="view-created-at">-</div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Updated At:</strong></div>
          <div class="col-md-6" id="view-updated-at">-</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
  
<!-- View Onboarding Modal -->
<div class="modal fade" id="viewOnboardModal" tabindex="-1" aria-labelledby="viewOnboardModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewOnboardModalLabel">Onboarding Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
        <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6"><strong>Client Name:</strong></div>
          <div class="col-md-6" id="view-onboard-client-name">-</div>
              </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Company Name:</strong></div>
          <div class="col-md-6" id="view-onboard-company-name">-</div>
              </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Client Email:</strong></div>
          <div class="col-md-6" id="view-onboard-client-email">-</div>
              </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Client Phone:</strong></div>
          <div class="col-md-6" id="view-onboard-client-phone">-</div>
              </div>
        <hr>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Project Name:</strong></div>
          <div class="col-md-6" id="view-onboard-project-name">-</div>
            </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Project Description:</strong></div>
          <div class="col-md-6" id="view-onboard-project-description">-</div>
          </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Project Duration:</strong></div>
          <div class="col-md-6" id="view-onboard-project-duration">-</div>
            </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Project Cost:</strong></div>
          <div class="col-md-6" id="view-onboard-project-cost">-</div>
            </div>
        <hr>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Assigned Engineer:</strong></div>
          <div class="col-md-6" id="view-onboard-assigned-engineer">-</div>
            </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Start Date:</strong></div>
          <div class="col-md-6" id="view-onboard-start-date">-</div>
                </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Status:</strong></div>
          <div class="col-md-6" id="view-onboard-status">-</div>
                </div>
        <hr>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Created At:</strong></div>
          <div class="col-md-6" id="view-onboard-created-at">-</div>
              </div>
        <div class="row mb-3">
          <div class="col-md-6"><strong>Updated At:</strong></div>
          <div class="col-md-6" id="view-onboard-updated-at">-</div>
          </div>
        </div>
        <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
    </div>
  </div>
</div>

<script>
// Quote form handling
let itemCount = 1;

function addItem() {
  const tbody = document.getElementById('items-tbody');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td><input type="text" class="form-control form-control-sm item-desc" placeholder="Item description"></td>
    <td><input type="number" class="form-control form-control-sm item-qty" value="1" min="1" onchange="calculateItemAmount(this)"></td>
    <td><input type="number" class="form-control form-control-sm item-price" step="0.01" placeholder="0.00" onchange="calculateItemAmount(this)"></td>
    <td><input type="number" class="form-control form-control-sm item-gst" value="0" step="0.01" onchange="calculateItemAmount(this)"></td>
    <td><input type="text" class="form-control form-control-sm item-amount" readonly></td>
    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeItem(this)"><i class="bi bi-trash"></i></button></td>
  `;
  tbody.appendChild(row);
  itemCount++;
}

function removeItem(btn) {
  if (document.querySelectorAll('#items-tbody tr').length > 1) {
    btn.closest('tr').remove();
    calculateTotal();
  }
}

function calculateItemAmount(input) {
  const row = input.closest('tr');
  const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
  const price = parseFloat(row.querySelector('.item-price').value) || 0;
  const gst = parseFloat(row.querySelector('.item-gst').value) || 0;
  const amount = (qty * price) * (1 + gst / 100);
  row.querySelector('.item-amount').value = amount.toFixed(2);
  calculateTotal();
}

function calculateTotal() {
      let subtotal = 0;
  document.querySelectorAll('.item-amount').forEach(input => {
    subtotal += parseFloat(input.value) || 0;
  });
  const discount = parseFloat(document.getElementById('discount').value) || 0;
  const total = subtotal - discount;
  document.getElementById('subtotal').value = subtotal.toFixed(2);
  document.getElementById('total').value = total.toFixed(2);
}

// Initialize item calculation listeners
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.item-qty, .item-price, .item-gst').forEach(input => {
    input.addEventListener('change', function() {
      calculateItemAmount(this);
    });
  });
  
  // Quote form submission
  document.getElementById('quote-form').addEventListener('submit', function(e) {
        const items = [];
    document.querySelectorAll('#items-tbody tr').forEach(row => {
      const desc = row.querySelector('.item-desc').value.trim();
          if (desc) {
            items.push({
              description: desc,
          quantity: parseInt(row.querySelector('.item-qty').value) || 1,
          unit_price: parseFloat(row.querySelector('.item-price').value) || 0,
          gst_percent: parseFloat(row.querySelector('.item-gst').value) || 0,
          amount: parseFloat(row.querySelector('.item-amount').value) || 0
        });
      }
    });
    document.getElementById('items_data').value = JSON.stringify(items);
  });
});

// View/Delete functions
function viewQuote(id) {
  fetch(`/employee/quotes/${id}/view/`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        alert('Error: ' + data.error);
        return;
      }
      
      // Populate modal with quote data
      document.getElementById('view-quote-number').textContent = data.quote_number || '-';
      document.getElementById('view-client-name').textContent = data.client_name || '-';
      document.getElementById('view-company').textContent = data.company || '-';
      document.getElementById('view-email').textContent = data.email || '-';
      document.getElementById('view-phone').textContent = data.phone || '-';
      document.getElementById('view-owner').textContent = data.owner || '-';
      document.getElementById('view-status').innerHTML = `<span class="badge bg-info">${data.status || '-'}</span>`;
      document.getElementById('view-currency').textContent = data.currency || '-';
      document.getElementById('view-valid-until').textContent = data.valid_until_display || '-';
      document.getElementById('view-subtotal').textContent = data.currency + ' ' + parseFloat(data.subtotal || 0).toFixed(2);
      document.getElementById('view-discount').textContent = data.currency + ' ' + parseFloat(data.discount || 0).toFixed(2);
      document.getElementById('view-total').innerHTML = `<strong>${data.currency} ${parseFloat(data.total || 0).toFixed(2)}</strong>`;
      document.getElementById('view-notes').textContent = data.notes || '-';
      document.getElementById('view-terms').textContent = data.terms || '-';
      document.getElementById('view-project-pdf').innerHTML = data.project_pdf 
        ? `<a href="${data.project_pdf}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-file-pdf"></i> View PDF</a>`
        : '-';
      document.getElementById('view-created-at').textContent = data.created_at || '-';
      document.getElementById('view-updated-at').textContent = data.updated_at || '-';
      
      // Populate items table
      const itemsBody = document.getElementById('view-items-body');
      itemsBody.innerHTML = '';
            if (data.items && data.items.length > 0) {
              data.items.forEach(item => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${item.description || '-'}</td>
            <td>${item.quantity || 1}</td>
            <td>${parseFloat(item.unit_price || 0).toFixed(2)}</td>
            <td>${parseFloat(item.gst_percent || 0).toFixed(2)}%</td>
            <td><strong>${parseFloat(item.amount || 0).toFixed(2)}</strong></td>
          `;
          itemsBody.appendChild(row);
        });
      } else {
        itemsBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No items</td></tr>';
      }
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('viewQuoteModal'));
            modal.show();
    })
    .catch(error => {
      console.error('Error fetching quote:', error);
      alert('Error loading quote details');
    });
}

function deleteQuote(id) {
  if (confirm('Are you sure you want to delete this quote?')) {
    fetch(`/employee/quotes/${id}/delete/`, {
        method: 'POST',
        headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    }).then(() => location.reload());
  }
}

function viewOnboard(id) {
  fetch(`/employee/quotes/onboard/${id}/view/`)
    .then(response => response.json())
        .then(data => {
      if (data.error) {
        alert('Error: ' + data.error);
        return;
      }
      
      // Populate modal with onboarding data
      document.getElementById('view-onboard-client-name').textContent = data.client_name || '-';
      document.getElementById('view-onboard-company-name').textContent = data.company_name || '-';
      document.getElementById('view-onboard-client-email').textContent = data.client_email || '-';
      document.getElementById('view-onboard-client-phone').textContent = data.client_phone || '-';
      document.getElementById('view-onboard-project-name').textContent = data.project_name || '-';
      document.getElementById('view-onboard-project-description').textContent = data.project_description || '-';
      document.getElementById('view-onboard-project-duration').textContent = data.duration_display || '-';
      document.getElementById('view-onboard-project-cost').innerHTML = `<strong>₹${parseFloat(data.project_cost || 0).toFixed(2)}</strong>`;
      document.getElementById('view-onboard-assigned-engineer').textContent = data.assigned_engineer || '-';
      document.getElementById('view-onboard-start-date').textContent = data.start_date_display || '-';
      document.getElementById('view-onboard-status').innerHTML = `<span class="badge bg-info">${data.status_display || '-'}</span>`;
      document.getElementById('view-onboard-created-at').textContent = data.created_at || '-';
      document.getElementById('view-onboard-updated-at').textContent = data.updated_at || '-';
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('viewOnboardModal'));
      modal.show();
    })
    .catch(error => {
      console.error('Error fetching onboarding:', error);
      alert('Error loading onboarding details');
    });
}

function deleteOnboard(id) {
  if (confirm('Are you sure you want to delete this onboarding?')) {
    fetch(`/employee/quotes/onboard/${id}/delete/`, {
        method: 'POST',
        headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    }).then(() => location.reload());
  }
}

// Auto-fill client details when client is selected from dropdown
function fillClientDetails(selectElement) {
  const selectedOption = selectElement.options[selectElement.selectedIndex];
  if (selectedOption && selectedOption.value) {
    // Get data attributes from selected option
    const company = selectedOption.getAttribute('data-company') || '';
    const email = selectedOption.getAttribute('data-email') || '';
    const phone = selectedOption.getAttribute('data-phone') || '';
    
    // Fill the form fields
    const companyField = document.getElementById('onboard_company_name');
    const emailField = document.getElementById('onboard_client_email');
    const phoneField = document.getElementById('onboard_client_phone');
    
    if (companyField) companyField.value = company;
    if (emailField) emailField.value = email;
    if (phoneField) phoneField.value = phone;
  } else {
    // Clear fields if no client is selected
    const companyField = document.getElementById('onboard_company_name');
    const emailField = document.getElementById('onboard_client_email');
    const phoneField = document.getElementById('onboard_client_phone');
    
    if (companyField) companyField.value = '';
    if (emailField) emailField.value = '';
    if (phoneField) phoneField.value = '';
  }
}

// Auto-fill create quote client details from Leads dropdown
function fillCreateClientDetails(selectElement) {
  const option = selectElement.options[selectElement.selectedIndex];
  if (!option || !option.value) {
    document.getElementById('create_company').value = '';
    document.getElementById('create_email').value = '';
    document.getElementById('create_phone').value = '';
    return;
  }
  document.getElementById('create_company').value = option.getAttribute('data-company') || '';
  document.getElementById('create_email').value = option.getAttribute('data-email') || '';
  document.getElementById('create_phone').value = option.getAttribute('data-phone') || '';
}
</script>
{% endblock %}

