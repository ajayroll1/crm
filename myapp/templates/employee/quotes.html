{% extends "employee/base.html" %}
{% load static %}

{% block title %}Quotations - Sujata Associates{% endblock %}
{% block page_title %}Quotations{% endblock %}
{% block mobile_title %}Quotes{% endblock %}

{% block content %}
<div class="dashboard-header mb-4">
  <h1>Quotations</h1>
  <p class="text-muted">Create professional quotes and manage them here</p>
</div>

<style>
  .nav-tabs .nav-link { color: #000 !important; }
  .nav-tabs .nav-link.active { color: #000 !important; }
  .nav-tabs .nav-link:hover { color: #fff !important; background-color: var(--primary-color) !important; }

  /* Mobile responsive table - convert to card layout */
  @media (max-width: 768px) {
    .quotes-table { border: 0; }
    .quotes-table thead { display: none; }
    .quotes-table tbody tr { display: block; margin: 0 0 1rem 0; border: 1px solid #eee; border-radius: 8px; background: #fff; }
    .quotes-table tbody tr td { display: flex; justify-content: space-between; align-items: center; gap: 1rem; padding: 0.5rem 1rem; border-bottom: 1px solid #f1f1f1; }
    .quotes-table tbody tr td:last-child { border-bottom: 0; }
    .quotes-table tbody tr td::before { content: attr(data-label); font-weight: 600; color: #666; }
    .quotes-table .btn { padding: .25rem .5rem; }
    .quotes-table tbody tr td[data-label="Actions"] { justify-content: space-between; gap: .5rem; }
    .quotes-table tbody tr td[data-label="Actions"] .btn-view { margin-left: auto; }
  }

  .currency { font-variant-numeric: tabular-nums; }
  .table tfoot th, .table tfoot td { border-top: 2px solid #e9ecef; }

  /* Create Quote - Line items mobile layout */
  @media (max-width: 768px) {
    #q-items thead { display: none; }
    #q-items tbody tr { display: block; border: 1px solid #eee; border-radius: 8px; margin-bottom: 1rem; background: #fff; }
    #q-items tbody tr td { display: flex; justify-content: space-between; align-items: center; gap: 1rem; padding: .5rem 1rem; border-bottom: 1px solid #f1f1f1; }
    #q-items tbody tr td:last-child { border-bottom: 0; }
    #q-items tbody tr td::before { content: attr(data-label); font-weight: 600; color: #666; }
    #q-items tbody input.form-control-sm { width: 60%; }
    #q-items tfoot { display: block; }
    #q-items tfoot tr { display: grid; grid-template-columns: 1fr 1fr; padding: .25rem 0; }
    #q-items tfoot td, #q-items tfoot th { border-top: 0; }
  }
</style>

<!-- Tabs: List | Create | Onboarding -->
<ul class="nav nav-tabs" id="quotesTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="q-list-tab" data-bs-toggle="tab" data-bs-target="#q-list" type="button" role="tab" aria-controls="q-list" aria-selected="true">
      <i class="bi bi-table"></i> List
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="q-create-tab" data-bs-toggle="tab" data-bs-target="#q-create" type="button" role="tab" aria-controls="q-create" aria-selected="false">
      <i class="bi bi-plus-circle"></i> Create Quote
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="q-onboard-tab" data-bs-toggle="tab" data-bs-target="#q-onboard" type="button" role="tab" aria-controls="q-onboard" aria-selected="false">
      <i class="bi bi-person-check"></i> Onboarding
    </button>
  </li>
  <li class="nav-item ms-auto d-none d-md-block">
    <button class="nav-link" id="q-print" type="button"><i class="bi bi-printer"></i> Print</button>
  </li>
  <li class="nav-item d-none d-md-block">
    <button class="nav-link" id="q-export" type="button"><i class="bi bi-download"></i> Export CSV</button>
  </li>
  
</ul>

<div class="tab-content pt-3" id="quotesTabsContent">
  <!-- List Tab -->
  <div class="tab-pane fade show active" id="q-list" role="tabpanel" aria-labelledby="q-list-tab">
    <div class="card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="card-title mb-0">All Quotations</h5>
        <div class="d-flex gap-2">
          <input id="q-search" class="form-control form-control-sm" style="max-width: 220px;" type="search" placeholder="Search quotes...">
          <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#q-filterModal"><i class="bi bi-funnel"></i> Filter</button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 quotes-table">
            <thead class="table-light">
              <tr>
                <th>Quote #</th>
                <th>Client</th>
                <th>Company</th>
                <th>Owner</th>
                <th>Status</th>
                <th>Total</th>
                <th>Valid Until</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="q-tbody">
              {% for quote in quotes %}
              <tr data-valid="{{ quote.valid_until|date:'Y-m-d' }}" data-total="{{ quote.total }}" data-status="{{ quote.status }}">
                <td data-label="Quote #">{{ quote.quote_number }}</td>
                <td data-label="Client">{{ quote.client_name }}</td>
                <td data-label="Company">{{ quote.company|default:"N/A" }}</td>
                <td data-label="Owner">{{ quote.owner }}</td>
                <td data-label="Status"><span class="badge {{ quote.get_status_badge_class }}">{{ quote.status }}</span></td>
                <td data-label="Total" class="currency">₹{{ quote.total|floatformat:0 }}</td>
                <td data-label="Valid Until">{{ quote.valid_until|date:"d-M-Y" }}</td>
                <td data-label="Actions">
                  <button class="btn btn-sm btn-outline-primary btn-view"><i class="bi bi-eye"></i></button>
                  <button class="btn btn-sm btn-outline-primary btn-edit"><i class="bi bi-pencil"></i></button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="8" class="text-center text-muted py-4">
                  <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                  No quotes found. Create your first quote!
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Tab -->
  <div class="tab-pane fade" id="q-create" role="tabpanel" aria-labelledby="q-create-tab">
    <form id="q-form" method="post" enctype="multipart/form-data" novalidate>
      {% csrf_token %}
      <div class="card">
        <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-2">
          <h5 class="card-title mb-0">Create quotation</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Client name<span class="text-danger">*</span></label>
              <input type="text" name="client" class="form-control" placeholder="Client full name" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Company</label>
              <input type="text" name="company" class="form-control" placeholder="Company name">
            </div>
            <div class="col-md-4">
              <label class="form-label">Owner (assignee)<span class="text-danger">*</span></label>
              <input type="text" name="owner" class="form-control" placeholder="Assigned to" required>
            </div>

            <div class="col-md-4">
              <label class="form-label">Email</label>
              <input type="email" name="email" class="form-control" placeholder="name@example.com">
            </div>
            <div class="col-md-4">
              <label class="form-label">Phone</label>
              <input type="tel" name="phone" class="form-control" placeholder="e.g. +91 98765 43210">
            </div>
            <div class="col-md-4">
              <label class="form-label">Valid Until<span class="text-danger">*</span></label>
              <input type="date" name="valid_until" class="form-control" required>
            </div>

            <div class="col-md-4">
              <label class="form-label">Quote #</label>
              <input type="text" name="quote_no" class="form-control" placeholder="Auto or custom e.g. Q-1003">
            </div>
            <div class="col-md-4">
              <label class="form-label">Status</label>
              <select name="status" class="form-select">
                <option>Draft</option>
                <option selected>Sent</option>
                <option>Accepted</option>
                <option>Declined</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Currency</label>
              <select name="currency" class="form-select">
                <option selected>INR (₹)</option>
                <option>USD ($)</option>
                <option>EUR (€)</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Project Details (PDF)</label>
              <input type="file" name="project_pdf" class="form-control" accept="application/pdf">
              <div class="form-text">Upload a single PDF (max 10MB).</div>
            </div>
          </div>

          <hr class="my-4">

          <!-- Line Items -->
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h6 class="mb-0">Line items</h6>
            <button class="btn btn-sm btn-outline-primary" type="button" id="q-add-item"><i class="bi bi-plus-lg"></i> Add item</button>
          </div>
          <div class="table-responsive">
            <table class="table align-middle" id="q-items">
              <thead class="table-light">
                <tr>
                  <th style="min-width: 240px;">Item</th>
                  <th style="width: 120px;">Qty</th>
                  <th style="width: 140px;">Unit Price</th>
                  <th style="width: 140px;">GST %</th>
                  <th style="width: 160px;">Amount</th>
                  <th style="width: 60px;"></th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td colspan="4" class="text-end">Subtotal</td>
                  <td><span id="q-subtotal" class="currency">₹0</span></td>
                  <td></td>
                </tr>
                <tr>
                  <td colspan="4" class="text-end">Discount</td>
                  <td>
                    <div class="input-group input-group-sm">
                      <input type="number" step="0.01" min="0" value="0" id="q-discount" class="form-control" aria-label="Discount">
                      <span class="input-group-text">₹</span>
                    </div>
                  </td>
                  <td></td>
                </tr>
                <tr>
                  <td colspan="4" class="text-end fw-semibold">Grand Total</td>
                  <td class="fw-semibold"><span id="q-total" class="currency">₹0</span></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-md-6">
              <label class="form-label">Notes</label>
              <textarea name="notes" class="form-control" rows="3" placeholder="Visible to client"></textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">Terms & Conditions</label>
              <textarea name="terms" class="form-control" rows="3" placeholder="Payment, delivery, warranty, etc."></textarea>
            </div>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button class="btn btn-outline-secondary" type="reset"><i class="bi bi-x-circle"></i> Reset</button>
          <button class="btn btn-primary" type="submit" name="quote_submit" id="q-submit"><i class="bi bi-save"></i> Save Quote</button>
        </div>
        <!-- Hidden fields for financial data -->
        <input type="hidden" name="subtotal" id="hidden-subtotal" value="0">
        <input type="hidden" name="total" id="hidden-total" value="0">
        <input type="hidden" name="items_data" id="hidden-items-data" value="[]">
      </div>
    </form>
  </div>

  <!-- Onboarding Tab -->
  <div class="tab-pane fade" id="q-onboard" role="tabpanel" aria-labelledby="q-onboard-tab">
    <!-- Onboarded Clients List -->
    <div class="card mb-4">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="card-title mb-0">Onboarded Clients</h5>
        <div class="d-flex gap-2">
          <input id="onboard-search" class="form-control form-control-sm" style="max-width: 220px;" type="search" placeholder="Search clients...">
          <button class="btn btn-sm btn-success" onclick="document.getElementById('onboard-form-section').scrollIntoView({behavior: 'smooth'})">
            <i class="bi bi-plus-lg"></i> Add Client
          </button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0" id="onboard-table">
            <thead class="table-light">
              <tr>
                <th>Client Name</th>
                <th>Project Name</th>
                <th>Duration</th>
                <th>Cost</th>
                <th>Assigned Engineer</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for onboard in onboardings %}
              <tr>
                <td>
                  <div class="fw-bold">{{ onboard.client_name }}</div>
                  <small class="text-muted">{{ onboard.company_name|default:"N/A" }}</small>
                </td>
                <td>{{ onboard.project_name }}</td>
                <td>{{ onboard.get_duration_display_text|title }}</td>
                <td class="currency">₹{{ onboard.project_cost|floatformat:0 }}</td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 30px; height: 30px; font-size: 12px;">
                      {{ onboard.assigned_engineer|slice:":2"|upper }}
                    </div>
                    <span>{{ onboard.assigned_engineer }}</span>
                  </div>
                </td>
                <td><span class="badge {{ onboard.get_status_badge_class }}">{{ onboard.get_status_display }}</span></td>
                <td>
                  <button class="btn btn-sm btn-outline-primary" title="View"><i class="bi bi-eye"></i></button>
                  <button class="btn btn-sm btn-outline-secondary" title="Edit"><i class="bi bi-pencil"></i></button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" class="text-center text-muted py-4">
                  <i class="bi bi-person-plus fs-1 d-block mb-2"></i>
                  No clients onboarded yet. Start onboarding!
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Onboarding Form -->
    <div class="card" id="onboard-form-section">
      <div class="card-header">
        <h5 class="card-title mb-0">Onboard New Client</h5>
      </div>
      <div class="card-body">
        <form id="onboard-form" method="post">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Client Name<span class="text-danger">*</span></label>
              <input type="text" name="client_name" class="form-control" placeholder="Enter client name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Company Name</label>
              <input type="text" name="company_name" class="form-control" placeholder="Enter company name">
            </div>
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input type="email" name="client_email" class="form-control" placeholder="client@example.com">
            </div>
            <div class="col-md-6">
              <label class="form-label">Phone</label>
              <input type="tel" name="client_phone" class="form-control" placeholder="+91 98765 43210">
            </div>
            <div class="col-md-12">
              <label class="form-label">Project Name<span class="text-danger">*</span></label>
              <input type="text" name="project_name" class="form-control" placeholder="Enter project name" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Project Duration<span class="text-danger">*</span></label>
              <div class="input-group">
                <input type="number" name="project_duration" class="form-control" placeholder="Enter duration" min="1" required>
                <select class="form-select" name="duration_unit" style="max-width: 120px;">
                  <option value="days">Days</option>
                  <option value="weeks">Weeks</option>
                  <option value="months" selected>Months</option>
                  <option value="years">Years</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Project Cost (₹)<span class="text-danger">*</span></label>
              <input type="number" name="project_cost" class="form-control" placeholder="Enter cost" min="0" step="0.01" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Assign to Engineer<span class="text-danger">*</span></label>
              <select class="form-select" name="assigned_engineer" required>
                <option value="">Select Engineer</option>
                <option value="amit_kumar">Amit Kumar</option>
                <option value="priya_verma">Priya Verma</option>
                <option value="rajesh_patel">Rajesh Patel</option>
                <option value="john_doe">John Doe</option>
                <option value="sarah_johnson">Sarah Johnson</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Start Date</label>
              <input type="date" name="start_date" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Status</label>
              <select class="form-select" name="status">
                <option value="active" selected>Active</option>
                <option value="pending">Pending</option>
                <option value="on_hold">On Hold</option>
                <option value="completed">Completed</option>
              </select>
            </div>
            <div class="col-md-12">
              <label class="form-label">Project Description</label>
              <textarea name="project_description" class="form-control" rows="3" placeholder="Enter project details and requirements..."></textarea>
            </div>
          </div>
          <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="reset" class="btn btn-outline-secondary">
              <i class="bi bi-x-circle"></i> Reset
            </button>
            <button type="submit" name="onboard_submit" class="btn btn-success">
              <i class="bi bi-check-circle"></i> Onboard Client
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- View Quote Modal -->
<div class="modal fade" id="q-viewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-receipt"></i> Quote Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3" id="q-details"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
  
<!-- Filter Modal -->
<div class="modal fade" id="q-filterModal" tabindex="-1" aria-labelledby="q-filterLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="q-filterLabel"><i class="bi bi-funnel"></i> Filter Quotes by Valid Until</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="q-filterForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Filter Type</label>
            <div class="d-flex flex-wrap gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="filter_type" id="qft_date" value="date" checked>
                <label class="form-check-label" for="qft_date">Date</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="filter_type" id="qft_month" value="month">
                <label class="form-check-label" for="qft_month">Month</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="filter_type" id="qft_year" value="year">
                <label class="form-check-label" for="qft_year">Year</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="filter_type" id="qft_between" value="between">
                <label class="form-check-label" for="qft_between">Between</label>
              </div>
            </div>
          </div>
          <div class="row g-3">
            <div class="col-12" data-ft="date">
              <label class="form-label">Select date</label>
              <input type="date" name="single_date" class="form-control">
            </div>
            <div class="col-12 d-none" data-ft="month">
              <label class="form-label">Select month</label>
              <input type="month" name="month" class="form-control">
            </div>
            <div class="col-12 d-none" data-ft="year">
              <label class="form-label">Select year</label>
              <input type="number" name="year" class="form-control" min="2000" max="2100" placeholder="e.g. 2025">
            </div>
            <div class="col-12 d-none" data-ft="between">
              <div class="row g-3">
                <div class="col-6">
                  <label class="form-label">From</label>
                  <input type="date" name="from_date" class="form-control">
                </div>
                <div class="col-6">
                  <label class="form-label">To</label>
                  <input type="date" name="to_date" class="form-control">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Apply</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Elements
    const qTable = document.querySelector('.quotes-table');
    const qTableWrapper = document.querySelector('#q-list .card .table-responsive');
    const qSearch = document.getElementById('q-search');
    const qFilterForm = document.getElementById('q-filterForm');
    const qCreateTabBtn = document.getElementById('q-create-tab');
    const qForm = document.getElementById('q-form');
    const qItemsBody = document.querySelector('#q-items tbody');
    const qSubtotalEl = document.getElementById('q-subtotal');
    const qTotalEl = document.getElementById('q-total');
    const qDiscountEl = document.getElementById('q-discount');
    const qExport = document.getElementById('q-export');
    const qPrint = document.getElementById('q-print');
    const qSend = document.getElementById('q-send');

    function updateTableScrollQuotes() {
      if (!qTable || !qTableWrapper) return;
      const visibleRows = Array.from(qTable.querySelectorAll('tbody tr')).filter(r => r.style.display !== 'none');
      if (visibleRows.length > 10) {
        qTableWrapper.style.maxHeight = '480px';
        qTableWrapper.style.overflowY = 'auto';
      } else {
        qTableWrapper.style.maxHeight = '';
        qTableWrapper.style.overflowY = '';
      }
    }
    updateTableScrollQuotes();

    // Search filter
    if (qSearch) {
      qSearch.addEventListener('input', function () {
        const term = qSearch.value.toLowerCase();
        const rows = qTable.querySelectorAll('tbody tr');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(term) ? '' : 'none';
        });
        updateTableScrollQuotes();
      });
    }

    // Filter modal logic: toggle sections
    (function setupFilterSections(){
      const form = qFilterForm;
      if (!form) return;
      const radios = form.querySelectorAll('input[name="filter_type"]');
      const sections = form.querySelectorAll('[data-ft]');
      function updateSections(){
        const selected = form.querySelector('input[name="filter_type"]:checked').value;
        sections.forEach(sec => sec.classList.toggle('d-none', sec.getAttribute('data-ft') !== selected));
      }
      radios.forEach(r => r.addEventListener('change', updateSections));
      updateSections();
    })();

    // Apply filter
    if (qFilterForm) {
      qFilterForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const type = qFilterForm.querySelector('[name="filter_type"]:checked').value;
        const date = qFilterForm.querySelector('[name="single_date"]').value;
        const month = qFilterForm.querySelector('[name="month"]').value;
        const year = qFilterForm.querySelector('[name="year"]').value;
        const from = qFilterForm.querySelector('[name="from_date"]').value;
        const to = qFilterForm.querySelector('[name="to_date"]').value;

        const rows = qTable.querySelectorAll('tbody tr');
        rows.forEach(row => {
          const validStr = row.getAttribute('data-valid');
          if (!validStr) { row.style.display = ''; return; }
          const valid = new Date(validStr);
          let show = true;
          if (type === 'date' && date) {
            const d = new Date(date);
            show = valid.getFullYear() === d.getFullYear() && valid.getMonth() === d.getMonth() && valid.getDate() === d.getDate();
          } else if (type === 'month' && month) {
            const [y, m] = month.split('-').map(n => parseInt(n, 10));
            show = valid.getFullYear() === y && (valid.getMonth() + 1) === m;
          } else if (type === 'year' && year) {
            const y = parseInt(year, 10);
            show = valid.getFullYear() === y;
          } else if (type === 'between' && from && to) {
            const f = new Date(from);
            const t = new Date(to);
            show = valid >= new Date(f.setHours(0,0,0,0)) && valid <= new Date(t.setHours(23,59,59,999));
          }
          row.style.display = show ? '' : 'none';
        });

        const modalEl = document.getElementById('q-filterModal');
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.hide();
        updateTableScrollQuotes();
      });
    }

    // CSV Export
    if (qExport) {
      qExport.addEventListener('click', function(){
        const rows = Array.from(qTable.querySelectorAll('tbody tr')).filter(r => r.style.display !== 'none');
        const header = ['Quote #','Client','Company','Owner','Status','Total','Valid Until'];
        const data = rows.map(r => [
          r.querySelector('[data-label="Quote #"]').innerText.trim(),
          r.querySelector('[data-label="Client"]').innerText.trim(),
          r.querySelector('[data-label="Company"]').innerText.trim(),
          r.querySelector('[data-label="Owner"]').innerText.trim(),
          r.querySelector('[data-label="Status"]').innerText.trim(),
          r.querySelector('[data-label="Total"]').innerText.trim(),
          r.querySelector('[data-label="Valid Until"]').innerText.trim(),
        ]);
        const csv = [header, ...data].map(row => row.map(v => '"' + v.replaceAll('"','""') + '"').join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'quotations.csv'; a.click();
        URL.revokeObjectURL(url);
      });
    }

    // Print
    if (qPrint) {
      qPrint.addEventListener('click', function(){
        window.print();
      });
    }

    // View/Edit actions
    function getQuoteRowData(tr){
      return {
        no: tr.querySelector('[data-label="Quote #"]').textContent.trim(),
        client: tr.querySelector('[data-label="Client"]').textContent.trim(),
        company: tr.querySelector('[data-label="Company"]').textContent.trim(),
        owner: tr.querySelector('[data-label="Owner"]').textContent.trim(),
        status: tr.querySelector('[data-label="Status"]').innerText.trim(),
        total: tr.querySelector('[data-label="Total"]').textContent.trim(),
        valid: tr.querySelector('[data-label="Valid Until"]').textContent.trim(),
        validIso: tr.getAttribute('data-valid')
      };
    }

    if (qTable) {
      qTable.addEventListener('click', function(e){
        const btnView = e.target.closest('.btn-view');
        const btnEdit = e.target.closest('.btn-edit');
        const tr = e.target.closest('tr');
        if (!tr) return;
        const data = getQuoteRowData(tr);
        if (btnView) {
          const c = document.getElementById('q-details');
          if (c) {
            c.innerHTML = `
              <div class="col-md-6"><strong>Quote #:</strong> ${data.no}</div>
              <div class="col-md-6"><strong>Client:</strong> ${data.client}</div>
              <div class="col-md-6"><strong>Company:</strong> ${data.company}</div>
              <div class="col-md-6"><strong>Owner:</strong> ${data.owner}</div>
              <div class="col-md-6"><strong>Status:</strong> ${data.status}</div>
              <div class="col-md-6"><strong>Total:</strong> ${data.total}</div>
              <div class="col-md-6"><strong>Valid Until:</strong> ${data.valid}</div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('q-viewModal'));
            modal.show();
          }
        }

        if (btnEdit && qCreateTabBtn && qForm) {
          const tab = new bootstrap.Tab(qCreateTabBtn); tab.show();
          qForm.querySelector('[name="quote_no"]').value = data.no || '';
          qForm.querySelector('[name="client"]').value = data.client || '';
          qForm.querySelector('[name="company"]').value = data.company || '';
          qForm.querySelector('[name="owner"]').value = data.owner || '';
          const statusSel = qForm.querySelector('[name="status"]');
          const statuses = ['Draft','Sent','Accepted','Declined'];
          statusSel.value = statuses.find(s => data.status.includes(s)) || 'Sent';
          if (data.validIso) qForm.querySelector('[name="valid_until"]').value = data.validIso;
          qForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }

    // Helpers for numbers
    function parseNum(v){ const n = parseFloat(String(v).replace(/[^0-9.-]/g,'')); return isNaN(n) ? 0 : n; }
    function formatINR(n){ try { return new Intl.NumberFormat('en-IN',{ style:'currency', currency:'INR', maximumFractionDigits:2 }).format(n); } catch { return `₹${n.toFixed(2)}`; } }

    // Line item row template
    function createItemRow(){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td data-label="Item">
          <input type="text" class="form-control form-control-sm" name="item_desc" placeholder="Description" required>
        </td>
        <td data-label="Qty">
          <input type="number" class="form-control form-control-sm" name="item_qty" min="1" step="1" value="1" required>
        </td>
        <td data-label="Unit Price">
          <input type="number" class="form-control form-control-sm" name="item_price" min="0" step="0.01" value="0" required>
        </td>
        <td data-label="GST %">
          <input type="number" class="form-control form-control-sm" name="item_tax" min="0" max="28" step="0.01" value="0" placeholder="GST %">
        </td>
        <td class="currency" data-label="Amount"><span class="item_amount">₹0</span></td>
        <td class="text-end" data-label="Remove">
          <button type="button" class="btn btn-sm btn-outline-danger q-remove-item"><i class="bi bi-x"></i></button>
        </td>`;
      return tr;
    }

    function recalcTotals(){
      let subtotal = 0;
      const rows = qItemsBody.querySelectorAll('tr');
      rows.forEach(row => {
        let qty = parseNum(row.querySelector('[name="item_qty"]').value);
        let price = parseNum(row.querySelector('[name="item_price"]').value);
        let tax = parseNum(row.querySelector('[name="item_tax"]').value); // GST %
        // clamp values to sane ranges
        qty = Math.max(1, Math.floor(qty));
        price = Math.max(0, price);
        tax = Math.min(28, Math.max(0, tax));
        row.querySelector('[name="item_qty"]').value = qty;
        row.querySelector('[name="item_price"]').value = price;
        row.querySelector('[name="item_tax"]').value = tax;
        const base = qty * price;
        const amount = base + (base * tax / 100);
        row.querySelector('.item_amount').textContent = formatINR(amount);
        subtotal += amount;
      });
      qSubtotalEl.textContent = formatINR(subtotal);
      let discount = parseNum(qDiscountEl.value);
      // discount cannot exceed subtotal
      if (discount > subtotal) {
        discount = subtotal;
        qDiscountEl.value = subtotal.toFixed(2);
      }
      const total = Math.max(0, subtotal - discount);
      qTotalEl.textContent = formatINR(total);
      
      // Update hidden fields
      document.getElementById('hidden-subtotal').value = subtotal.toFixed(2);
      document.getElementById('hidden-total').value = total.toFixed(2);
    }

    // Send Email via mailto
    if (qSend) {
      qSend.addEventListener('click', function(){
        if (!qForm) return;
        // basic validation reuse
        const client = qForm.querySelector('[name="client"]').value.trim();
        const owner = qForm.querySelector('[name="owner"]').value.trim();
        const validUntil = qForm.querySelector('[name="valid_until"]').value.trim();
        const email = qForm.querySelector('[name="email"]').value.trim();
        const phone = qForm.querySelector('[name="phone"]').value.trim();
        let messages = [];
        if (!client) messages.push('Client name is required');
        if (!owner) messages.push('Owner is required');
        if (!validUntil) messages.push('Valid Until is required');
        if (!email && !phone) messages.push('Either Email or Phone is required');
        if (email) {
          const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
          if (!emailOk) messages.push('Enter a valid email');
        }
        const hasItem = Array.from(qItemsBody.querySelectorAll('[name="item_desc"]')).some(i => i.value.trim());
        if (!hasItem) messages.push('Add at least one line item');
        if (messages.length) {
          const alert = document.createElement('div');
          alert.className = 'alert alert-danger';
          alert.innerHTML = '<strong>Please fix the following:</strong><ul class="mb-0">' + messages.map(m => `<li>${m}</li>`).join('') + '</ul>';
          qForm.querySelectorAll('.alert-danger').forEach(x => x.remove());
          qForm.querySelector('.card-body').prepend(alert);
          alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }

        // Build email content
        const quoteNo = qForm.querySelector('[name="quote_no"]').value.trim() || 'New Quote';
        const currency = qForm.querySelector('[name="currency"]').value;
        const status = qForm.querySelector('[name="status"]').value;
        const notes = qForm.querySelector('[name="notes"]').value.trim();
        const terms = qForm.querySelector('[name="terms"]').value.trim();

        // Collect items
        const items = Array.from(qItemsBody.querySelectorAll('tr')).map(row => {
          const desc = row.querySelector('[name="item_desc"]').value.trim();
          const qty = row.querySelector('[name="item_qty"]').value.trim();
          const price = row.querySelector('[name="item_price"]').value.trim();
          const gst = row.querySelector('[name="item_tax"]').value.trim();
          const amount = row.querySelector('.item_amount').textContent.trim();
          return `- ${desc} | Qty: ${qty} | Price: ${price} | GST: ${gst}% | Amount: ${amount}`;
        }).filter(Boolean);

        const subject = encodeURIComponent(`Quotation ${quoteNo} - ${client}`);
        const lines = [
          `Dear ${client},`,
          '',
          `Please find your quotation below:`,
          '',
          `Quote #: ${quoteNo}`,
          `Status: ${status}`,
          `Valid Until: ${validUntil}`,
          '',
          'Items:',
          ...items,
          '',
          `Subtotal: ${qSubtotalEl.textContent}`,
          `Discount: ₹${(parseNum(qSubtotalEl.textContent) - parseNum(qTotalEl.textContent)).toFixed(2)}`,
          `Grand Total: ${qTotalEl.textContent}`,
          '',
          (notes ? `Notes: ${notes}` : ''),
          (terms ? `Terms: ${terms}` : ''),
          '',
          'Regards,',
          owner
        ].filter(Boolean);
        const body = encodeURIComponent(lines.join('\n'));
        const to = email || '';
        window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
      });
    }

    // Add first row by default
    if (qItemsBody) {
      qItemsBody.appendChild(createItemRow());
      recalcTotals();
      qItemsBody.addEventListener('input', function(e){
        if (e.target.matches('[name="item_qty"], [name="item_price"], [name="item_tax"]')) recalcTotals();
      });
      qItemsBody.addEventListener('click', function(e){
        if (e.target.closest('.q-remove-item')) {
          const row = e.target.closest('tr');
          row.remove();
          if (qItemsBody.querySelectorAll('tr').length === 0) qItemsBody.appendChild(createItemRow());
          recalcTotals();
        }
      });
      document.getElementById('q-add-item').addEventListener('click', function(){
        qItemsBody.appendChild(createItemRow());
        recalcTotals();
      });
      qDiscountEl.addEventListener('input', recalcTotals);
    }

    // Client-side validation and form submission
    if (qForm) {
      qForm.addEventListener('submit', function(e){
        e.preventDefault();
        
        const client = qForm.querySelector('[name="client"]').value.trim();
        const owner = qForm.querySelector('[name="owner"]').value.trim();
        const validUntil = qForm.querySelector('[name="valid_until"]').value.trim();
        const email = qForm.querySelector('[name="email"]').value.trim();
        const phone = qForm.querySelector('[name="phone"]').value.trim();
        let messages = [];
        if (!client) messages.push('Client name is required');
        if (!owner) messages.push('Owner is required');
        if (!validUntil) messages.push('Valid Until is required');
        if (!email && !phone) messages.push('Either Email or Phone is required');
        if (email) {
          const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
          if (!emailOk) messages.push('Enter a valid email');
        }
        if (phone) {
          const phoneOk = /^[0-9+\-()\s]{7,20}$/.test(phone);
          if (!phoneOk) messages.push('Enter a valid phone number');
        }
        // Ensure at least one non-empty item description
        const hasItem = Array.from(qItemsBody.querySelectorAll('[name="item_desc"]')).some(i => i.value.trim());
        if (!hasItem) messages.push('Add at least one line item');

        // Validate Project PDF (client-only)
        const pdf = qForm.querySelector('[name="project_pdf"]').files[0];
        if (pdf) {
          const isPdf = pdf.type === 'application/pdf' || (pdf.name || '').toLowerCase().endsWith('.pdf');
          const sizeOk = pdf.size <= 10 * 1024 * 1024; // 10MB
          if (!isPdf) messages.push('Project Details must be a PDF');
          if (!sizeOk) messages.push('Project PDF must be ≤ 10MB');
        }

        // Valid Until must be today or future
        if (validUntil) {
          const today = new Date(); today.setHours(0,0,0,0);
          const v = new Date(validUntil); v.setHours(0,0,0,0);
          if (v < today) messages.push('Valid Until cannot be in the past');
        }

        if (messages.length) {
          const alert = document.createElement('div');
          alert.className = 'alert alert-danger';
          alert.innerHTML = '<strong>Please fix the following:</strong><ul class="mb-0">' + messages.map(m => `<li>${m}</li>`).join('') + '</ul>';
          qForm.querySelectorAll('.alert-danger').forEach(x => x.remove());
          qForm.querySelector('.card-body').prepend(alert);
          alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }

        // Collect items data
        const items = [];
        qItemsBody.querySelectorAll('tr').forEach(row => {
          const desc = row.querySelector('[name="item_desc"]').value.trim();
          if (desc) {
            items.push({
              description: desc,
              quantity: row.querySelector('[name="item_qty"]').value,
              unit_price: row.querySelector('[name="item_price"]').value,
              gst_percent: row.querySelector('[name="item_tax"]').value,
              amount: parseNum(row.querySelector('.item_amount').textContent)
            });
          }
        });
        
        // Update hidden items data field
        document.getElementById('hidden-items-data').value = JSON.stringify(items);
        
        // Submit form
        qForm.submit();
      });
    }

    // Onboarding Section - Search functionality
    const onboardSearch = document.getElementById('onboard-search');
    const onboardTable = document.getElementById('onboard-table');
    
    if (onboardSearch && onboardTable) {
      onboardSearch.addEventListener('input', function() {
        const term = onboardSearch.value.toLowerCase();
        const rows = onboardTable.querySelectorAll('tbody tr');
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(term) ? '' : 'none';
        });
      });
    }

    // Onboarding Form Validation (form will submit to backend)
    const onboardForm = document.getElementById('onboard-form');
    if (onboardForm) {
      onboardForm.addEventListener('submit', function(e) {
        const clientName = onboardForm.querySelector('[name="client_name"]').value.trim();
        const projectName = onboardForm.querySelector('[name="project_name"]').value.trim();
        const projectDuration = onboardForm.querySelector('[name="project_duration"]').value;
        const projectCost = onboardForm.querySelector('[name="project_cost"]').value;
        const assignedEngineer = onboardForm.querySelector('[name="assigned_engineer"]').value;
        
        if (!clientName || !projectName || !projectDuration || !projectCost || !assignedEngineer) {
          e.preventDefault();
          alert('Please fill in all required fields!');
          return;
        }
        
        // Form is valid, allow submission to backend
      });
    }
  });
</script>
{% endblock %}

