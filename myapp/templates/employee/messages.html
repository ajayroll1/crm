{% extends "employee/base.html" %}
{% load static %}

{% block title %}Messages - Sujata Associates{% endblock %}
{% block page_title %}Messages{% endblock %}
{% block mobile_title %}Messages{% endblock %}
{% block notification_count %}0{% endblock %}
{% block mobile_notification_count %}0{% endblock %}

{% block notifications %}
  <li><h6 class="dropdown-header">Notifications</h6></li>
  <li><hr class="dropdown-divider"></li>
  <li><a class="dropdown-item text-center text-muted small" href="#">No notifications</a></li>
{% endblock %}

{% block mobile_notifications %}
  <li><h6 class="dropdown-header">Notifications</h6></li>
  <li><hr class="dropdown-divider"></li>
  <li><a class="dropdown-item text-center text-muted small" href="#">No notifications</a></li>
{% endblock %}

{% block content %}
<!-- Display messages -->
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show welcome-alert" role="alert" data-auto-hide="true">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %}

<div class="row">
  <!-- Contacts List -->
  <div class="col-lg-4 col-md-5 mb-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Contacts</h5>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newMessageModal">
          <i class="bi bi-plus-circle me-1"></i>New Message
        </button>
      </div>
      <div class="card-body p-0">
        <div class="input-group p-3 border-bottom">
          <span class="input-group-text bg-light border-0">
            <i class="bi bi-search"></i>
          </span>
          <input type="text" class="form-control border-0 bg-light" id="searchContacts" placeholder="Search contacts...">
        </div>
        <div class="contacts-list" style="max-height: 600px; overflow-y: auto;">
          {% if contacts and contacts|length > 0 %}
            {% for contact in contacts %}
              <div class="contact-item p-3 border-bottom cursor-pointer {% if selected_contact_id == contact.id %}active{% endif %}" 
                   onclick="selectContact('{{ contact.id }}', '{{ contact.name|escapejs }}', '{{ contact.role|escapejs }}')"
                   data-contact-id="{{ contact.id }}">
                <div class="d-flex align-items-center">
                  <div class="contact-avatar me-3">
                    {% if contact.first_name %}{{ contact.first_name|first|upper }}{% else %}{{ contact.name|first|upper }}{% endif %}
                  </div>
                  <div class="flex-grow-1">
                    <div class="fw-bold">{{ contact.name }}</div>
                    <div class="small text-muted">
                      {% if contact.designation %}{{ contact.designation }}{% endif %}
                      {% if contact.department %} - {{ contact.department }}{% endif %}
                      {% if not contact.designation and not contact.department %}{{ contact.role }}{% endif %}
                    </div>
                  </div>
                  {% if contact.unread_count > 0 %}
                    <span class="badge bg-primary rounded-pill unread-badge" 
                          id="badge-{{ contact.id }}" 
                          data-count="{{ contact.unread_count }}">{{ contact.unread_count }}</span>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-5 text-muted">
              <i class="bi bi-people display-4 d-block mb-3"></i>
              <p>No contacts available</p>
              <small class="text-muted">Total contacts: {{ contacts|length|default:0 }}</small>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Messages Area -->
  <div class="col-lg-8 col-md-7 mb-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center" id="messageHeader">
        <div>
          <h5 class="mb-0" id="selectedContactName">Select a contact to start messaging</h5>
          <small class="text-muted" id="selectedContactRole"></small>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-secondary" id="refreshMessages" onclick="refreshMessages()" style="display: none;">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
      </div>
      <div class="card-body p-0">
        <!-- Messages Container -->
        <div class="messages-container" id="messagesContainer" style="height: 500px; overflow-y: auto; padding: 1rem;">
          <div class="text-center py-5 text-muted" id="noMessagesPlaceholder">
            <i class="bi bi-chat-dots display-4 d-block mb-3"></i>
            <p>Select a contact to view messages</p>
          </div>
          <div id="messagesList" style="display: none;"></div>
        </div>
        
        <!-- Message Input -->
        <div class="message-input p-3 border-top" id="messageInput" style="display: none;">
          <!-- File Preview Area -->
          <div id="filePreview" class="mb-2" style="display: none;">
            <div class="d-flex align-items-center gap-2 p-2 bg-light rounded">
              <span id="fileName" class="flex-grow-1"></span>
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFilePreview()">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>
          <form id="sendMessageForm" enctype="multipart/form-data">
            <div class="input-group">
              <!-- Hidden file inputs -->
              <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
              <input type="file" id="attachmentInput" accept="*/*" style="display: none;" onchange="handleAttachmentSelect(event)">
              
              <!-- Action buttons -->
              <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('imageInput').click()" title="Attach Image">
                <i class="bi bi-image"></i>
              </button>
              <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('attachmentInput').click()" title="Attach File">
                <i class="bi bi-paperclip"></i>
              </button>
              
              <input type="text" class="form-control" id="messageText" placeholder="Type your message...">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-send"></i> Send
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Message Modal -->
<div class="modal fade" id="newMessageModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle me-2"></i>New Message
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="newMessageForm">
          <div class="mb-3">
            <label class="form-label">To</label>
            <select class="form-select" id="recipientSelect" required>
              <option value="">Select recipient...</option>
              {% if contacts and contacts|length > 0 %}
                {% for contact in contacts %}
                  <option value="{{ contact.id }}">
                    {{ contact.first_name|default:contact.name }} {{ contact.last_name|default:"" }}
                    {% if contact.designation %} - {{ contact.designation }}{% endif %}
                    {% if contact.department %} ({{ contact.department }}){% endif %}
                  </option>
                {% endfor %}
              {% else %}
                <option value="" disabled>No contacts available (Contacts: {{ contacts|length|default:0 }})</option>
              {% endif %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Message</label>
            <textarea class="form-control" id="newMessageText" rows="4" placeholder="Type your message..."></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Attachments (Optional)</label>
            <div class="d-flex gap-2">
              <input type="file" id="newMessageImage" accept="image/*" class="form-control form-control-sm">
              <input type="file" id="newMessageAttachment" accept="*/*" class="form-control form-control-sm">
            </div>
            <small class="text-muted">You can attach an image or file</small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="sendNewMessage()">
          <i class="bi bi-send me-1"></i>Send Message
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .contact-item {
    transition: background-color 0.2s;
    cursor: pointer;
  }
  
  .contact-item:hover {
    background-color: #f8f9fa;
  }
  
  .contact-item.active {
    background-color: #e3f2fd;
    border-left: 3px solid var(--primary-color);
  }
  
  .contact-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.1rem;
  }
  
  .message-item {
    margin-bottom: 0.5rem;
    display: flex;
    align-items: flex-end;
    gap: 0.5rem;
    width: 100%;
    padding: 0.25rem 0.5rem;
  }
  
  /* Sent messages - Right side (WhatsApp style) */
  .message-item.sent {
    flex-direction: row-reverse;
    justify-content: flex-end;
    margin-left: auto;
  }
  
  /* Received messages - Left side */
  .message-item.received {
    justify-content: flex-start;
    margin-right: auto;
  }
  
  .message-bubble {
    max-width: 70%;
    min-width: 100px;
    padding: 0.6rem 0.8rem;
    border-radius: 7.5px;
    word-wrap: break-word;
    position: relative;
    display: inline-block;
  }
  
  .message-image img {
    border: 1px solid #e5e5e5;
    border-radius: 7.5px;
  }
  
  .message-attachment a {
    transition: background-color 0.2s;
    border-radius: 7.5px;
  }
  
  .message-attachment a:hover {
    background-color: #e9ecef !important;
  }
  
  /* Sent message bubble - Right side (Green background like WhatsApp) */
  .message-item.sent .message-bubble {
    background: #dcf8c6;
    color: #111;
    border-bottom-right-radius: 2px;
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
    margin-left: auto;
  }
  
  /* Received message bubble - Left side (White background) */
  .message-item.received .message-bubble {
    background: #ffffff;
    color: #111;
    border-bottom-left-radius: 2px;
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
    border: 1px solid #e5e5e5;
    margin-right: auto;
  }
  
  .message-text {
    font-size: 0.95rem;
    line-height: 1.4;
    margin-bottom: 0.25rem;
  }
  
  .message-sender-info {
    font-size: 0.75rem;
    opacity: 0.7;
  }
  
  .message-time {
    font-size: 0.65rem;
    color: #667781;
    margin-top: 0.25rem;
    text-align: right;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.25rem;
    opacity: 0.8;
  }
  
  .message-item.sent .message-time {
    color: #667781;
    text-align: right;
    justify-content: flex-end;
  }
  
  .message-item.received .message-time {
    text-align: left;
    justify-content: flex-start;
    color: #667781;
  }
  
  /* WhatsApp-style checkmarks for sent messages */
  .message-item.sent .message-time::before {
    content: '✓✓';
    font-size: 0.7rem;
    opacity: 0.6;
    margin-right: 0.15rem;
  }
  
  .message-item.received .message-time::before {
    display: none;
  }
  
  .messages-container {
    background: #f8f9fa;
  }
  
  .message-input {
    background: white;
  }
  
  /* Remove blue border on focus from input field */
  #messageText:focus,
  #messageText:active,
  #newMessageText:focus,
  #newMessageText:active {
    outline: none !important;
    border-color: #dee2e6 !important;
    box-shadow: none !important;
  }
  
  #messageText,
  #newMessageText {
    border: 1px solid #dee2e6 !important;
  }
  
  #messageText:focus,
  #newMessageText:focus {
    border-color: #dee2e6 !important;
    box-shadow: 0 0 0 0.2rem transparent !important;
  }
  
  .cursor-pointer {
    cursor: pointer;
  }
  
  .contacts-list::-webkit-scrollbar,
  .messages-container::-webkit-scrollbar {
    width: 6px;
  }
  
  .contacts-list::-webkit-scrollbar-track,
  .messages-container::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  
  .contacts-list::-webkit-scrollbar-thumb,
  .messages-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
  }
  
  .contacts-list::-webkit-scrollbar-thumb:hover,
  .messages-container::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
  
  @media (max-width: 768px) {
    .col-lg-4, .col-lg-8 {
      margin-bottom: 1rem;
    }
    
    .messages-container {
      height: 400px !important;
    }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  let selectedContactId = null;
  let selectedContactName = null;
  let selectedContactRole = null;
  
  // Lazy loading state
  let messagesCache = {};
  let lastRefreshTime = {};
  let isLoadingMessages = false;
  let isLoadingOlderMessages = false;
  let oldestMessageIds = {}; // Track oldest message ID per contact
  let hasMoreMessages = {}; // Track if more messages available per contact
  
  // Select contact
  function selectContact(contactId, contactName, contactRole) {
    selectedContactId = contactId;
    selectedContactName = contactName;
    selectedContactRole = contactRole;
    
    // Hide unread badge for this contact
    const badge = document.getElementById(`badge-${contactId}`);
    if (badge) {
      badge.style.display = 'none';
      // Store in localStorage that this contact was clicked
      localStorage.setItem(`contact_clicked_${contactId}`, Date.now().toString());
      // Store current count
      const currentCount = parseInt(badge.getAttribute('data-count') || '0');
      localStorage.setItem(`contact_count_${contactId}`, currentCount.toString());
    }
    
    // Update UI
    document.getElementById('selectedContactName').textContent = contactName;
    document.getElementById('selectedContactRole').textContent = contactRole;
    document.getElementById('noMessagesPlaceholder').style.display = 'none';
    document.getElementById('messagesList').style.display = 'block';
    document.getElementById('messageInput').style.display = 'block';
    document.getElementById('refreshMessages').style.display = 'block';
    
    // Update active state
    document.querySelectorAll('.contact-item').forEach(item => {
      item.classList.remove('active');
    });
    const clickedItem = event.currentTarget || document.querySelector(`[data-contact-id="${contactId}"]`);
    if (clickedItem) {
      clickedItem.classList.add('active');
    }
    
    // Load messages
    loadMessages(contactId);
  }
  
  // Load messages for selected contact (with caching)
  function loadMessages(contactId, forceRefresh = false) {
    if (isLoadingMessages) return;
    isLoadingMessages = true;
    
    const messagesList = document.getElementById('messagesList');
    
    // Check cache first
    if (!forceRefresh && messagesCache[contactId]) {
      const cachedData = messagesCache[contactId];
      const cacheAge = Date.now() - cachedData.timestamp;
      // Use cache if less than 5 seconds old
      if (cacheAge < 5000) {
        displayMessages(cachedData.messages, contactId, false);
        isLoadingMessages = false;
        return;
      }
    }
    
    messagesList.innerHTML = '<div class="text-center py-3 text-muted"><small>Loading messages...</small></div>';
    
    fetch(`{% url 'employee_get_messages' %}?receiver_id=${contactId}&limit=50`, {
      credentials: 'include'  // Include cookies/session
    })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          // Cache the messages
          messagesCache[contactId] = {
            messages: data.messages || [],
            timestamp: Date.now()
          };
          
          // Track pagination state
          if (data.messages && data.messages.length > 0) {
            oldestMessageIds[contactId] = data.oldest_message_id;
            hasMoreMessages[contactId] = data.has_more || false;
          } else {
            oldestMessageIds[contactId] = null;
            hasMoreMessages[contactId] = false;
          }
          
          // Display messages (append mode for initial load)
          displayMessages(data.messages || [], contactId, false);
        } else {
          // API returned success:false - no messages available
          messagesList.innerHTML = `
            <div class="text-center py-5">
              <i class="bi bi-chat-dots display-4 text-muted d-block mb-3"></i>
              <p class="text-muted mb-0">No conversation done yet</p>
              <small class="text-muted">Start the conversation by sending a message!</small>
            </div>
          `;
          oldestMessageIds[contactId] = null;
          hasMoreMessages[contactId] = false;
        }
        isLoadingMessages = false;
      })
      .catch(error => {
        console.error('Error loading messages:', error);
        // On error, show "No conversation done yet" instead of error message
        messagesList.innerHTML = `
          <div class="text-center py-5">
            <i class="bi bi-chat-dots display-4 text-muted d-block mb-3"></i>
            <p class="text-muted mb-0">No conversation done yet</p>
            <small class="text-muted">Start the conversation by sending a message!</small>
          </div>
        `;
        isLoadingMessages = false;
      });
  }
  
  // Load older messages (lazy loading on scroll up)
  function loadOlderMessages(contactId) {
    if (isLoadingOlderMessages || !hasMoreMessages[contactId] || !oldestMessageIds[contactId]) {
      return;
    }
    
    isLoadingOlderMessages = true;
    const messagesList = document.getElementById('messagesList');
    const messagesContainer = document.getElementById('messagesContainer');
    
    // Save current scroll position and height
    const scrollHeight = messagesContainer.scrollHeight;
    const scrollTop = messagesContainer.scrollTop;
    
    // Show loading indicator at top
    const loadingIndicator = document.createElement('div');
    loadingIndicator.id = 'loadingOlderMessages';
    loadingIndicator.className = 'text-center py-2 text-muted';
    loadingIndicator.innerHTML = '<small><i class="bi bi-arrow-repeat spin"></i> Loading older messages...</small>';
    messagesList.insertBefore(loadingIndicator, messagesList.firstChild);
    
    // Fetch older messages
    fetch(`{% url 'employee_get_messages' %}?receiver_id=${contactId}&limit=50&before_id=${oldestMessageIds[contactId]}`, {
      credentials: 'include'
    })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        // Remove loading indicator
        const indicator = document.getElementById('loadingOlderMessages');
        if (indicator) indicator.remove();
        
        if (data.success && data.messages && data.messages.length > 0) {
          // Update pagination state
          oldestMessageIds[contactId] = data.oldest_message_id;
          hasMoreMessages[contactId] = data.has_more || false;
          
          // Prepend older messages
          prependMessages(data.messages, contactId);
          
          // Restore scroll position (maintain scroll position relative to content)
          const newScrollHeight = messagesContainer.scrollHeight;
          const heightDifference = newScrollHeight - scrollHeight;
          messagesContainer.scrollTop = scrollTop + heightDifference;
          
          // Update cache
          if (messagesCache[contactId]) {
            messagesCache[contactId].messages = [...data.messages, ...messagesCache[contactId].messages];
            messagesCache[contactId].timestamp = Date.now();
          }
        } else {
          // No more messages
          hasMoreMessages[contactId] = false;
        }
        isLoadingOlderMessages = false;
      })
      .catch(error => {
        console.error('Error loading older messages:', error);
        const indicator = document.getElementById('loadingOlderMessages');
        if (indicator) indicator.remove();
        isLoadingOlderMessages = false;
      });
  }
  
  // Prepend messages to the top (for lazy loading)
  function prependMessages(messages, contactId) {
    const messagesList = document.getElementById('messagesList');
    let messagesHTML = '';
    let lastDate = null;
    
    messages.forEach(msg => {
      // Same logic as displayMessages but in reverse order
      const messageDate = new Date(msg.created_at || new Date());
      const currentDate = messageDate.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      // Add date separator if needed
      if (lastDate !== currentDate) {
        messagesHTML += `<div class="date-separator text-center my-3"><small class="text-muted">${currentDate}</small></div>`;
        lastDate = currentDate;
      }
      
      // Build message content (same as displayMessages)
      let messageContent = '';
      
      if (msg.image_url) {
        messageContent += `
          <div class="message-image mb-2">
            <a href="${msg.image_url}" target="_blank">
              <img src="${msg.image_url}" alt="Image" class="img-fluid rounded" style="max-width: 300px; cursor: pointer;">
            </a>
          </div>
        `;
      }
      
      if (msg.attachment_url) {
        const attachmentName = escapeHtml(msg.attachment_name || 'Download');
        messageContent += `
          <div class="message-attachment mb-2">
            <a href="${msg.attachment_url}" download class="d-flex align-items-center gap-2 p-2 bg-light rounded text-decoration-none text-dark">
              <i class="bi bi-file-earmark"></i>
              <span class="flex-grow-1">${attachmentName}</span>
              <i class="bi bi-download"></i>
            </a>
          </div>
        `;
      }
      
      if (msg.message && msg.message.trim()) {
        messageContent += `<div class="message-text">${escapeHtml(msg.message)}</div>`;
      }
      
      const messageTime = new Date(msg.created_at);
      const timeStr = messageTime.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
      });
      
      const messageId = msg.id || Date.now();
      const isSender = msg.is_sender === true || msg.is_sender === 'true' || msg.is_sender === 1 || msg.is_sender === '1';
      
      const msgHTML = `
        <div class="message-item ${isSender ? 'sent' : 'received'}" data-date="${currentDate}" data-id="${messageId}" data-is-sender="${isSender}">
          <div class="message-bubble">
            ${messageContent}
            ${msg.sender_designation || msg.sender_department ? `
              <div class="message-sender-info small text-muted mt-1">
                ${escapeHtml(msg.sender_designation || '')}${msg.sender_department ? ` - ${escapeHtml(msg.sender_department)}` : ''}
              </div>
            ` : ''}
            <div class="message-time">${timeStr}</div>
          </div>
        </div>
      `;
      
      messagesHTML += msgHTML;
    });
    
    // Prepend to messages list
    const existingMessages = messagesList.innerHTML;
    messagesList.innerHTML = messagesHTML + existingMessages;
  }
  
  // Display messages function (separated for reusability)
  function displayMessages(messages, contactId, append = false) {
    const messagesList = document.getElementById('messagesList');
    
    if (messages.length === 0) {
      // No messages yet - show friendly message
      messagesList.innerHTML = `
        <div class="text-center py-5">
          <i class="bi bi-chat-dots display-4 text-muted d-block mb-3"></i>
          <p class="text-muted mb-0">No conversation done yet</p>
          <small class="text-muted">Start the conversation by sending a message!</small>
        </div>
      `;
    } else {
      // Show messages in WhatsApp-like style
      // Clear existing messages but preserve structure
      const existingMessages = messagesList.querySelectorAll('.message-item');
      const existingMessageIds = Array.from(existingMessages).map(el => el.getAttribute('data-id'));
      
      // Build new messages HTML
      let messagesHTML = '';
      let lastDate = null;
      
      messages.forEach(msg => {
              const messageDate = new Date(msg.created_at);
              const currentDate = messageDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              });
              
              // Show date separator if date changed
              if (lastDate !== currentDate) {
                const dateSeparator = `
                  <div class="text-center my-3">
                    <span class="badge bg-light text-muted px-3 py-1">${currentDate}</span>
                  </div>
                `;
                messagesList.innerHTML += dateSeparator;
                lastDate = currentDate;
              }
              
              // Message bubble
              let messageContent = '';
              
              // Add image if exists
              if (msg.image_url) {
                const imageUrl = escapeHtml(msg.image_url);
                messageContent += `
                  <div class="message-image mb-2">
                    <img src="${imageUrl}" alt="Image" class="img-fluid rounded" style="max-width: 300px; max-height: 300px; cursor: pointer;" onclick="window.open('${imageUrl}', '_blank')">
                  </div>
                `;
              }
              
              // Add attachment if exists
              if (msg.attachment_url) {
                const attachmentName = escapeHtml(msg.attachment_name || 'Attachment');
                const attachmentUrl = escapeHtml(msg.attachment_url);
                messageContent += `
                  <div class="message-attachment mb-2">
                    <a href="${attachmentUrl}" target="_blank" class="d-flex align-items-center gap-2 p-2 bg-light rounded text-decoration-none text-dark">
                      <i class="bi bi-file-earmark"></i>
                      <span class="flex-grow-1">${attachmentName}</span>
                      <i class="bi bi-download"></i>
                    </a>
                  </div>
                `;
              }
              
              // Add message text if exists
              if (msg.message && msg.message.trim()) {
                messageContent += `<div class="message-text">${escapeHtml(msg.message)}</div>`;
              }
              
              // Format time for display
              const messageTime = new Date(msg.created_at);
              const timeStr = messageTime.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
              });
              
              // Ensure is_sender is properly set - use the value from backend
              const messageId = msg.id || Date.now();
              
              // Force is_sender to be boolean - ensure it's true if msg.is_sender is true
              // This is critical to keep sent messages on right side after refresh
              let isSender = msg.is_sender === true || msg.is_sender === 'true' || msg.is_sender === 1 || msg.is_sender === '1';
              
              // Additional check: If message is in our sent messages cache, mark as sent
              // This helps when backend doesn't correctly identify sender
              if (!isSender && messagesCache && messagesCache[contactId]) {
                const cachedMessage = messagesCache[contactId].messages.find(m => m.id === messageId);
                if (cachedMessage && cachedMessage.is_sender === true) {
                  isSender = true;
                  console.log(`Message ${messageId} found in cache as SENT - marking as sent`);
                }
              }
              
              // Debug log to verify is_sender value
              if (isSender) {
                console.log(`Message ${messageId} marked as SENT (right side) - is_sender: ${msg.is_sender}`);
              } else {
                console.log(`Message ${messageId} marked as RECEIVED (left side) - is_sender: ${msg.is_sender}`);
              }
              
              // Build message HTML with proper class (sent = right, received = left)
              const msgHTML = `
                <div class="message-item ${isSender ? 'sent' : 'received'}" data-date="${currentDate}" data-id="${messageId}" data-is-sender="${isSender}">
                  <div class="message-bubble">
                    ${messageContent}
                    ${msg.sender_designation || msg.sender_department ? `
                      <div class="message-sender-info small text-muted mt-1">
                        ${escapeHtml(msg.sender_designation || '')}${msg.sender_department ? ` - ${escapeHtml(msg.sender_department)}` : ''}
                      </div>
                    ` : ''}
                    <div class="message-time">${timeStr}</div>
                  </div>
                </div>
              `;
              
              // Add to messages HTML
              messagesHTML += msgHTML;
      });
      
      // Replace all messages at once (prevents flickering and position shifts)
      messagesList.innerHTML = messagesHTML;
      
      // Scroll to bottom
      setTimeout(() => {
        const container = document.getElementById('messagesContainer');
        container.scrollTop = container.scrollHeight;
      }, 100);
    }
  }
  
  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Add message to chat immediately (WhatsApp-like instant display)
  function addMessageToChat(messageData, isSender = true) {
    const messagesList = document.getElementById('messagesList');
    const messagesContainer = document.getElementById('messagesContainer');
    
    // Force isSender to true for sent messages to keep them on right side
    if (isSender) {
      messageData.is_sender = true;
    }
    
    // Hide "no messages" placeholder if visible
    document.getElementById('noMessagesPlaceholder').style.display = 'none';
    messagesList.style.display = 'block';
    
    // Check if message already exists (prevent duplicates)
    const messageId = messageData.id || Date.now();
    const existingMsg = messagesList.querySelector(`[data-id="${messageId}"]`);
    if (existingMsg) {
      // Message already exists, don't add again
      return;
    }
    
    // Get current date for date separator
    const messageDate = new Date(messageData.created_at || new Date());
    const currentDate = messageDate.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
    
    // Check if we need to add date separator
    const lastMessage = messagesList.lastElementChild;
    let needsDateSeparator = false;
    
    if (lastMessage && lastMessage.classList.contains('date-separator')) {
      // Already has a date separator, check if date is different
      const lastDateText = lastMessage.textContent.trim();
      if (lastDateText !== currentDate) {
        needsDateSeparator = true;
      }
    } else if (messagesList.children.length > 0) {
      // Check last message date
      const lastMsgElement = Array.from(messagesList.children).reverse().find(el => 
        el.classList.contains('message-item')
      );
      if (lastMsgElement) {
        const lastMsgDate = lastMsgElement.getAttribute('data-date');
        if (lastMsgDate !== currentDate) {
          needsDateSeparator = true;
        }
      }
    } else {
      // First message, always add date separator
      needsDateSeparator = true;
    }
    
    // Add date separator if needed
    if (needsDateSeparator) {
      const dateSeparator = document.createElement('div');
      dateSeparator.className = 'text-center my-3 date-separator';
      dateSeparator.innerHTML = `<span class="badge bg-light text-muted px-3 py-1">${currentDate}</span>`;
      messagesList.appendChild(dateSeparator);
    }
    
    // Build message content
    let messageContent = '';
    
    // Add image if exists
    if (messageData.image_url) {
      const imageUrl = escapeHtml(messageData.image_url);
      messageContent += `
        <div class="message-image mb-2">
          <img src="${imageUrl}" alt="Image" class="img-fluid rounded" style="max-width: 300px; max-height: 300px; cursor: pointer;" onclick="window.open('${imageUrl}', '_blank')">
        </div>
      `;
    }
    
    // Add attachment if exists
    if (messageData.attachment_url) {
      const attachmentName = escapeHtml(messageData.attachment_name || 'Attachment');
      const attachmentUrl = escapeHtml(messageData.attachment_url);
      messageContent += `
        <div class="message-attachment mb-2">
          <a href="${attachmentUrl}" target="_blank" class="d-flex align-items-center gap-2 p-2 bg-light rounded text-decoration-none text-dark">
            <i class="bi bi-file-earmark"></i>
            <span class="flex-grow-1">${attachmentName}</span>
            <i class="bi bi-download"></i>
          </a>
        </div>
      `;
    }
    
    // Add message text if exists
    if (messageData.message && messageData.message.trim()) {
      messageContent += `<div class="message-text">${escapeHtml(messageData.message)}</div>`;
    }
    
    // Format time
    const messageTime = new Date(messageData.created_at || new Date());
    const timeStr = messageTime.toLocaleTimeString('en-US', { 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: true 
    });
    
    // Create message element with proper WhatsApp-style alignment
    // Force 'sent' class for sent messages to keep them on right side
    const messageClass = (isSender || messageData.is_sender) ? 'sent' : 'received';
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-item ${messageClass}`;
    messageDiv.setAttribute('data-date', currentDate);
    messageDiv.setAttribute('data-id', messageId);
    messageDiv.setAttribute('data-is-sender', isSender || messageData.is_sender ? 'true' : 'false');
    
    messageDiv.innerHTML = `
      <div class="message-bubble">
        ${messageContent}
        <div class="message-time">${timeStr}</div>
      </div>
    `;
    
    messagesList.appendChild(messageDiv);
    
    // Update cache with new message
    if (messagesCache[selectedContactId]) {
      messagesCache[selectedContactId].messages.push({
        ...messageData,
        is_sender: isSender || messageData.is_sender
      });
      messagesCache[selectedContactId].timestamp = Date.now();
    }
    
    // Scroll to bottom with smooth animation
    setTimeout(() => {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 100);
  }
  
  // Refresh messages (with force refresh)
  function refreshMessages(forceRefresh = false) {
    if (selectedContactId) {
      loadMessages(selectedContactId, forceRefresh);
    }
  }
  
  // Send new message
  function sendNewMessage() {
    const recipientId = document.getElementById('recipientSelect').value;
    const messageText = document.getElementById('newMessageText').value;
    const imageFile = document.getElementById('newMessageImage').files[0];
    const attachmentFile = document.getElementById('newMessageAttachment').files[0];
    
    if (!recipientId || (!messageText.trim() && !imageFile && !attachmentFile)) {
      alert('Please select a recipient and enter a message or attach a file/image');
      return;
    }
    
    const formData = new FormData();
    formData.append('receiver_id', recipientId);
    if (messageText.trim()) {
      formData.append('message', messageText);
    }
    if (imageFile) {
      formData.append('image', imageFile);
    }
    if (attachmentFile) {
      formData.append('attachment', attachmentFile);
    }
    
    fetch('{% url "employee_send_message" %}', {
      method: 'POST',
      body: formData,
      credentials: 'include',  // Include cookies/session
      headers: {
        'X-CSRFToken': getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Close modal and reset form
          const modal = bootstrap.Modal.getInstance(document.getElementById('newMessageModal'));
          modal.hide();
          document.getElementById('newMessageForm').reset();
          
          // If recipient is selected, switch to that contact
          if (recipientId) {
            const option = document.getElementById('recipientSelect').options[document.getElementById('recipientSelect').selectedIndex];
            const optionText = option.text.trim();
            // Extract name (before first -)
            const contactName = optionText.split(' - ')[0].trim();
            // Extract role/designation (between - and () or after -)
            let contactRole = '';
            if (optionText.includes('(')) {
              contactRole = optionText.split('(')[0].split(' - ').slice(1).join(' - ').trim();
            } else if (optionText.includes(' - ')) {
              contactRole = optionText.split(' - ').slice(1).join(' - ').trim();
            }
            selectContact(recipientId, contactName, contactRole || 'Employee');
            
            // Immediately show the sent message
            if (data.message) {
              setTimeout(() => {
                addMessageToChat(data.message, true);
              }, 100);
            }
          }
        } else {
          alert('Error: ' + (data.error || 'Failed to send message'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error sending message. Please try again.');
      });
  }
  
  // Helper: get CSRF token from cookie
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  
  // File handling variables
  let selectedImageFile = null;
  let selectedAttachmentFile = null;
  
  // Handle image selection
  function handleImageSelect(event) {
    const file = event.target.files[0];
    if (file) {
      // Clear attachment if image is selected
      selectedAttachmentFile = null;
      document.getElementById('attachmentInput').value = '';
      
      selectedImageFile = file;
      document.getElementById('filePreview').style.display = 'block';
      document.getElementById('fileName').innerHTML = `<i class="bi bi-image me-2"></i>${file.name}`;
    }
  }
  
  // Handle attachment selection
  function handleAttachmentSelect(event) {
    const file = event.target.files[0];
    if (file) {
      // Clear image if attachment is selected
      selectedImageFile = null;
      document.getElementById('imageInput').value = '';
      
      selectedAttachmentFile = file;
      document.getElementById('filePreview').style.display = 'block';
      document.getElementById('fileName').innerHTML = `<i class="bi bi-paperclip me-2"></i>${file.name}`;
    }
  }
  
  // Clear file preview
  function clearFilePreview() {
    selectedImageFile = null;
    selectedAttachmentFile = null;
    document.getElementById('imageInput').value = '';
    document.getElementById('attachmentInput').value = '';
    document.getElementById('filePreview').style.display = 'none';
  }
  
  // Send message form handler
  document.getElementById('sendMessageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!selectedContactId) {
      alert('Please select a contact first');
      return;
    }
    
    const messageText = document.getElementById('messageText').value;
    
    // At least one of message, image, or attachment must be provided
    if (!messageText.trim() && !selectedImageFile && !selectedAttachmentFile) {
      alert('Please enter a message or attach a file/image');
      return;
    }
    
    const formData = new FormData();
    formData.append('receiver_id', selectedContactId);
    if (messageText.trim()) {
      formData.append('message', messageText);
    }
    if (selectedImageFile) {
      formData.append('image', selectedImageFile);
    }
    if (selectedAttachmentFile) {
      formData.append('attachment', selectedAttachmentFile);
    }
    
    fetch('{% url "employee_send_message" %}', {
      method: 'POST',
      body: formData,
      credentials: 'include',  // Include cookies/session
      headers: {
        'X-CSRFToken': getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
      }
    })
      .then(response => {
        // Check if response is ok
        if (!response.ok) {
          // If unauthorized, suggest refreshing
          if (response.status === 401) {
            return response.json().then(data => {
              throw new Error(data.error || 'Authentication failed. Please refresh the page.');
            });
          }
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          // Immediately add the sent message to the chat (WhatsApp-like instant display)
          if (data.message) {
            // Mark as sent message (is_sender = true) so it stays on right side
            data.message.is_sender = true;
            addMessageToChat(data.message, true);
          }
          
          // Clear input and files
          document.getElementById('messageText').value = '';
          clearFilePreview();
          
          // Don't reload immediately - the message is already added
          // Only reload if needed after a longer delay (10 seconds) to sync with server
          // This prevents the message from shifting to left side
          setTimeout(() => {
            // Only reload if message not already in list
            const messageId = data.message?.id;
            if (messageId) {
              const existingMsg = document.querySelector(`[data-id="${messageId}"]`);
              if (!existingMsg) {
                loadMessages(selectedContactId);
              }
            }
          }, 10000); // 10 seconds delay instead of 500ms
        } else {
          alert('Error: ' + (data.error || 'Failed to send message'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        const errorMsg = error.message || 'Error sending message. Please try again.';
        alert(errorMsg);
        
        // If authentication error, suggest refreshing
        if (errorMsg.includes('Authentication') || errorMsg.includes('not authenticated')) {
          if (confirm('Session expired. Would you like to refresh the page?')) {
            window.location.reload();
          }
        }
      });
  });
  
  // Search contacts - search by first name, last name, designation, and department
  document.getElementById('searchContacts').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('.contact-item').forEach(item => {
      const contactText = item.textContent.toLowerCase();
      // Search in full text which includes name, designation, and department
      if (contactText.includes(searchTerm)) {
        item.style.display = '';
      } else {
        item.style.display = 'none';
      }
    });
  });
  
  // Auto-refresh messages every 30 seconds (reduced frequency)
  setInterval(() => {
    if (selectedContactId) {
      const now = Date.now();
      const lastRefresh = lastRefreshTime[selectedContactId] || 0;
      // Only refresh if last refresh was more than 30 seconds ago
      if (now - lastRefresh > 30000) {
        refreshMessages();
        lastRefreshTime[selectedContactId] = now;
      }
    }
  }, 30000); // 30 seconds instead of 5 seconds
  
  // Lazy loading: Detect scroll to top and load older messages
  let scrollThrottle = null;
  const messagesContainer = document.getElementById('messagesContainer');
  
  if (messagesContainer) {
    messagesContainer.addEventListener('scroll', function() {
      // Throttle scroll events (only check every 200ms)
      if (scrollThrottle) {
        clearTimeout(scrollThrottle);
      }
      
      scrollThrottle = setTimeout(() => {
        // Check if scrolled to top (within 100px from top)
        if (messagesContainer.scrollTop < 100 && selectedContactId) {
          // Load older messages if available
          if (hasMoreMessages[selectedContactId] && !isLoadingOlderMessages) {
            loadOlderMessages(selectedContactId);
          }
        }
      }, 200); // Throttle to 200ms
    });
  }
  
  // Hide badges for contacts that were already clicked
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.unread-badge').forEach(badge => {
      const contactId = badge.id.replace('badge-', '');
      const clickedTime = localStorage.getItem(`contact_clicked_${contactId}`);
      
      // If contact was clicked and badge count hasn't increased, hide it
      if (clickedTime) {
        const lastCount = parseInt(localStorage.getItem(`contact_count_${contactId}`) || '0');
        const currentCount = parseInt(badge.getAttribute('data-count') || '0');
        
        // Only show badge if new messages arrived (count increased)
        if (currentCount <= lastCount) {
          badge.style.display = 'none';
        } else {
          // New messages arrived - show badge and update count
          badge.style.display = 'inline-block';
          localStorage.setItem(`contact_count_${contactId}`, currentCount.toString());
        }
      } else {
        // First time - store the count
        localStorage.setItem(`contact_count_${contactId}`, badge.getAttribute('data-count') || '0');
      }
    });
    
    // Auto-hide welcome alert after 3 seconds
    const welcomeAlerts = document.querySelectorAll('.welcome-alert[data-auto-hide="true"]');
    welcomeAlerts.forEach(alert => {
      setTimeout(() => {
        // Use Bootstrap's alert dismiss functionality
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
      }, 3000); // 3 seconds
    });
  });
  
  // CSS for loading spinner animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .spin {
      animation: spin 1s linear infinite;
      display: inline-block;
    }
  `;
  document.head.appendChild(style);
</script>
{% endblock %}


