{% extends "employee/base.html" %}
{% load static %}

{% block title %}Check In/Out - Sujata Associates{% endblock %}
{% block page_title %}Check In/Out{% endblock %}
{% block mobile_title %}Attendance{% endblock %}

{% block content %}
<!-- Current Status Card -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card status-card">
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-md-8">
            <div class="d-flex align-items-center">
              <div class="me-4">
                <div class="status-indicator" id="statusIndicator">
                  <div class="status-circle" id="statusCircle"></div>
                  <div class="status-text" id="statusText">Not Checked In</div>
                </div>
              </div>
              <div>
                <h4 class="mb-1">Current Status</h4>
                <p class="text-muted mb-0">Track your daily attendance and working hours</p>
              </div>
            </div>
          </div>
          <div class="col-md-4 text-md-end">
            <div class="d-flex flex-column align-items-md-end">
              <div class="mb-2">
                <div class="fw-bold text-primary" id="currentDate">{{ "now"|date:"l, F d, Y" }}</div>
                <div class="text-muted small" id="currentTime">{{ "now"|date:"g:i A" }}</div>
              </div>
              <div class="d-flex gap-2 flex-wrap justify-content-md-end">
                <button class="btn btn-success btn-lg" id="checkInBtn" onclick="openCheckInModal()">
                  <i class="bi bi-box-arrow-in-right me-2"></i>Check In
                </button>
                <button class="btn btn-danger btn-lg" id="checkOutBtn" onclick="openCheckOutModal()" disabled>
                  <i class="bi bi-box-arrow-right me-2"></i>Check Out
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Attendance Records Table -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Attendance Records</h5>
        <div class="d-flex gap-2 flex-wrap">
          <input type="date" class="form-control form-control-sm" id="filterDate" style="width: auto;">
          <button class="btn btn-sm refresh-btn" onclick="refreshTable()">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
          </button>
      </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover" id="attendanceTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Date</th>
                <th>Check In Time</th>
                <th>Check In Photo</th>
                <th>Check Out Time</th>
                <th>Check Out Photo</th>
                <th>Work Hours</th>
              </tr>
            </thead>
            <tbody id="attendanceTableBody">
              <!-- Records will be populated here -->
            </tbody>
          </table>
          <div class="text-center py-4 d-none" id="emptyState">
            <i class="bi bi-inbox display-4 text-muted"></i>
            <p class="text-muted mt-2">No attendance records found</p>
          </div>
        </div>
        <!-- Pagination Controls -->
        <div class="d-flex justify-content-between align-items-center mt-3 d-none" id="paginationContainer">
          <div class="text-muted small">
            <span id="paginationInfo">Showing 0 - 0 of 0 records</span>
            </div>
          <nav aria-label="Page navigation">
            <ul class="pagination pagination-sm mb-0" id="paginationList">
              <!-- Pagination buttons will be populated here -->
            </ul>
          </nav>
            </div>
          </div>
        </div>
          </div>
</div>

<!-- Check In Modal -->
<div class="modal fade" id="checkInModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-box-arrow-in-right me-2"></i>Check In
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="checkInForm">
          <div class="mb-3">
            <label class="form-label">Capture Photo *</label>
            <div class="photo-capture-container">
              <div class="camera-preview" id="checkInCameraPreview">
                <div class="camera-placeholder">
                  <i class="bi bi-camera display-1 text-muted"></i>
                  <p class="text-muted">Click to capture photo</p>
                </div>
              </div>
              <div class="camera-controls mt-3">
                <button type="button" class="btn btn-outline-primary" onclick="startCamera('checkIn')">
                  <i class="bi bi-camera me-2"></i>Open Camera
                </button>
                <button type="button" class="btn btn-outline-success" onclick="capturePhoto('checkIn')" id="checkInCaptureBtn" disabled>
                  <i class="bi bi-camera-fill me-2"></i>Capture Photo
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="retakePhoto('checkIn')" id="checkInRetakeBtn" disabled>
                  <i class="bi bi-arrow-clockwise me-2"></i>Retake
                </button>
              </div>
              <input type="hidden" id="checkInPhotoData" required>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Check In Time</label>
            <div class="location-info">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-clock text-primary me-2"></i>
                <span id="checkInTimeText">{{ "now"|date:"g:i A" }}</span>
              </div>
              <div class="d-flex align-items-center">
                <i class="bi bi-calendar text-primary me-2"></i>
                <span id="checkInDateText">{{ "now"|date:"F d, Y" }}</span>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="submitCheckIn()">
          <i class="bi bi-check-circle me-2"></i>Check In
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Check Out Modal -->
<div class="modal fade" id="checkOutModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-box-arrow-right me-2"></i>Check Out
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="checkOutForm">
          <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Check In Time:</strong> <span id="checkInTimeDisplay">--:--</span>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Capture Photo *</label>
            <div class="photo-capture-container">
              <div class="camera-preview" id="checkOutCameraPreview">
                <div class="camera-placeholder">
                  <i class="bi bi-camera display-1 text-muted"></i>
                  <p class="text-muted">Click to capture photo</p>
                </div>
              </div>
              <div class="camera-controls mt-3">
                <button type="button" class="btn btn-outline-primary" onclick="startCamera('checkOut')">
                  <i class="bi bi-camera me-2"></i>Open Camera
                </button>
                <button type="button" class="btn btn-outline-success" onclick="capturePhoto('checkOut')" id="checkOutCaptureBtn" disabled>
                  <i class="bi bi-camera-fill me-2"></i>Capture Photo
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="retakePhoto('checkOut')" id="checkOutRetakeBtn" disabled>
                  <i class="bi bi-arrow-clockwise me-2"></i>Retake
                </button>
              </div>
              <input type="hidden" id="checkOutPhotoData" required>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Check Out Time</label>
            <div class="location-info">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-clock text-primary me-2"></i>
                <span id="checkOutTimeText">{{ "now"|date:"g:i A" }}</span>
              </div>
              <div class="d-flex align-items-center">
                <i class="bi bi-calendar text-primary me-2"></i>
                <span id="checkOutDateText">{{ "now"|date:"F d, Y" }}</span>
            </div>
          </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="submitCheckOut()">
          <i class="bi bi-check-circle me-2"></i>Check Out
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .status-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  
  .status-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: #dc3545;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.5rem;
    position: relative;
    animation: pulse 2s infinite;
  }
  
  .status-circle.checked-in {
    background: #28a745;
    animation: none;
  }
  
  .status-circle::before {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 2px solid currentColor;
    opacity: 0.3;
    animation: ripple 2s infinite;
  }
  
  .status-text {
    font-weight: 600;
    color: #dc3545;
    font-size: 0.9rem;
  }
  
  .status-text.checked-in {
    color: #28a745;
  }
  
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  @keyframes ripple {
    0% { transform: scale(1); opacity: 0.3; }
    100% { transform: scale(1.5); opacity: 0; }
  }
  
  /* Camera and Photo Capture Styles */
  .photo-capture-container {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    background: #f8f9fa;
  }
  
  .camera-preview {
    width: 100%;
    height: 250px;
    border-radius: 8px;
    overflow: hidden;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  
  .camera-placeholder {
    text-align: center;
    color: #6c757d;
  }
  
  .camera-preview video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .camera-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .camera-controls {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  .location-info {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid var(--primary-color);
  }
  
  /* Table Styles */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  .table thead th {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    font-weight: 600;
    padding: 1rem;
    white-space: nowrap;
  }
  
  .table tbody td {
    padding: 1rem;
    vertical-align: middle;
  }
  
  .photo-thumbnail {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 8px;
    border: 2px solid #dee2e6;
    cursor: pointer;
    transition: transform 0.2s;
    display: inline-block;
    vertical-align: middle;
  }
  
  .photo-thumbnail:hover {
    transform: scale(1.1);
  }
  
  /* Photo column styling */
  .table thead th:nth-child(4),
  .table thead th:nth-child(6) {
    text-align: center;
    min-width: 80px;
  }
  
  .table tbody td:nth-child(4),
  .table tbody td:nth-child(6) {
    text-align: center;
  }
  
  .work-hours {
    font-weight: 600;
    color: var(--primary-color);
    font-size: 1.1rem;
  }
  
  /* Refresh Button Styling */
  .refresh-btn {
    background-color: white;
    color: black;
    border: 1px solid #dee2e6;
  }
  
  .refresh-btn:hover {
    background-color: #f8f9fa;
    color: black;
    border-color: #adb5bd;
  }
  
  /* Check In/Out Button Styling - Dark Colors */
  .btn-success#checkInBtn,
  .btn-success[onclick*="submitCheckIn"] {
    background-color: #155724 !important;
    border-color: #155724 !important;
    color: white !important;
  }
  
  .btn-success#checkInBtn:hover,
  .btn-success[onclick*="submitCheckIn"]:hover {
    background-color: #0e3d16 !important;
    border-color: #0e3d16 !important;
  }
  
  .btn-danger#checkOutBtn,
  .btn-danger[onclick*="submitCheckOut"] {
    background-color: #721c24 !important;
    border-color: #721c24 !important;
    color: white !important;
  }
  
  .btn-danger#checkOutBtn:hover,
  .btn-danger[onclick*="submitCheckOut"]:hover {
    background-color: #4a1318 !important;
    border-color: #4a1318 !important;
  }
  
  /* Table Responsive Improvements */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  /* Mobile Responsive Styles */
  @media (max-width: 768px) {
    .status-card .row.align-items-center {
      flex-direction: column;
      text-align: center;
    }
    
    .status-card .col-md-8,
    .status-card .col-md-4 {
      width: 100%;
      margin-bottom: 1rem;
    }
    
    .status-card .text-md-end {
      text-align: center !important;
    }
    
    .status-card .justify-content-md-end {
      justify-content: center !important;
    }
    
    .status-indicator {
      margin-bottom: 1rem;
    }
    
    .status-circle {
      width: 50px;
      height: 50px;
    }
    
    .camera-preview {
      height: 200px;
    }
    
    .camera-controls {
      flex-direction: column;
    }
    
    .camera-controls .btn {
      width: 100%;
      margin-bottom: 0.5rem;
    }
    
    /* Table Mobile Improvements */
    .table-responsive {
      border-radius: 8px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      max-width: 100%;
    }
    
    .table {
      min-width: 600px;
      margin-bottom: 0;
    }
    
    .table thead th {
      font-size: 0.75rem;
      padding: 0.6rem 0.4rem;
      white-space: nowrap;
      position: sticky;
      top: 0;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      z-index: 10;
    }
    
    .table tbody td {
      font-size: 0.75rem;
      padding: 0.6rem 0.4rem;
      white-space: nowrap;
    }
    
    .table tbody td:nth-child(1) {
      font-weight: 600;
  }
  
    .photo-thumbnail {
      width: 45px;
      height: 45px;
      border-radius: 6px;
      display: inline-block;
      object-fit: cover;
    vertical-align: middle;
    }
    
    /* Ensure photos are always visible on mobile */
    .table thead th:nth-child(4),
    .table tbody td:nth-child(4),
    .table thead th:nth-child(6),
    .table tbody td:nth-child(6) {
      display: table-cell !important;
    }
    
    /* Photo column headers styling */
    .table thead th:nth-child(4),
    .table thead th:nth-child(6) {
      text-align: center;
      min-width: 60px;
    }
    
    .table tbody td:nth-child(4),
    .table tbody td:nth-child(6) {
      text-align: center;
    }
    
    .work-hours {
      font-size: 0.85rem;
    font-weight: 600;
  }
  
    /* Card Header Mobile */
    .card-header .d-flex {
      flex-direction: column;
      gap: 0.75rem;
      align-items: flex-start !important;
    }
    
    .card-header .form-control-sm {
      width: 100%;
      margin-bottom: 0.5rem;
    }
    
    .card-header .refresh-btn {
      width: 100%;
      padding: 0.5rem;
    }
    
    .card-header {
      padding: 1rem;
    }
    
    .card-header .d-flex {
      flex-direction: column;
      gap: 0.5rem;
      align-items: flex-start !important;
    }
    
    .card-header .form-control-sm {
      width: 100%;
    }
    
    .modal-dialog {
      margin: 0.5rem;
      max-width: calc(100% - 1rem);
    }
    
    .modal-footer {
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .modal-footer .btn {
      width: 100%;
      margin: 0;
    }
  }
  
  @media (max-width: 576px) {
    .status-circle {
      width: 40px;
      height: 40px;
    }
    
    .status-text {
      font-size: 0.8rem;
    }
    
    .btn-lg {
      font-size: 0.9rem;
      padding: 0.5rem 1rem;
    }
    
    .camera-preview {
      height: 150px;
    }
    
    /* Table Extra Small Screen Improvements */
    .table {
      min-width: 550px;
    }
    
    .table thead th {
      font-size: 0.7rem;
      padding: 0.5rem 0.3rem;
    }
    
    .table tbody td {
      font-size: 0.7rem;
      padding: 0.5rem 0.3rem;
    }
    
    .photo-thumbnail {
      width: 35px;
      height: 35px;
    }
    
    .work-hours {
      font-size: 0.75rem;
    }
    
    /* Hide less important columns on very small screens - keep Name, Date, Photos, Check Out Time, Work Hours */
    /* Hide Check In Time (column 3) to make space for photos */
    .table thead th:nth-child(3),
    .table tbody td:nth-child(3) {
      display: none;
    }
    
    /* Make photos smaller but visible on mobile */
    .photo-thumbnail {
      display: inline-block !important;
      width: 35px !important;
      height: 35px !important;
      object-fit: cover;
    }
    
    .modal-dialog {
      margin: 0.25rem;
      max-width: calc(100% - 0.5rem);
    }
    
    .modal-body {
      padding: 1rem;
    }
    
    .modal-footer {
      padding: 1rem;
    }
  }
  
  /* Ensure no horizontal overflow */
  @media (max-width: 768px) {
    .main-content {
      overflow-x: hidden;
    }
    
    .row {
      margin-left: 0;
      margin-right: 0;
    }
    
    .row > * {
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
    
    /* Card body padding for mobile */
    .card-body {
      padding: 0.75rem;
    }
    
    /* Better table container on mobile */
    .card .card-body {
      padding: 0.75rem 0.5rem;
    }
    
    .table-responsive {
      margin: 0 -0.5rem;
      padding: 0 0.5rem;
      position: relative;
      border-radius: 8px;
    }
    
  /* Smooth scrolling for table */
  .table-responsive::-webkit-scrollbar {
    height: 6px;
  }
  
  .table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
  }
  
  .table-responsive::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
  }
  
  .table-responsive::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
  
  /* Pagination Styles */
  .pagination {
    gap: 0.25rem;
  }
  
  .pagination .page-link {
    border-radius: 6px;
    padding: 0.4rem 0.75rem;
    font-size: 0.875rem;
    border: 1px solid #dee2e6;
    color: var(--primary-color);
  }
  
  .pagination .page-item.active .page-link {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
  }
  
  .pagination .page-item.disabled .page-link {
    color: #6c757d;
    background-color: #fff;
    border-color: #dee2e6;
    cursor: not-allowed;
  }
  
  .pagination .page-link:hover:not(.disabled) {
    background-color: #f8f9fa;
    border-color: #adb5bd;
  }
  
  @media (max-width: 768px) {
    .pagination {
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .pagination .page-link {
      padding: 0.35rem 0.6rem;
      font-size: 0.8rem;
    }
    
    #paginationContainer {
      flex-direction: column;
      gap: 1rem;
    }
    
    #paginationContainer .small {
      text-align: center;
      width: 100%;
    }
  }
  
  @media (max-width: 576px) {
    .pagination .page-link {
      padding: 0.3rem 0.5rem;
      font-size: 0.75rem;
    }
    
    /* Hide some page numbers on very small screens */
    .pagination .page-item:not(.active):not(.disabled):not(:first-child):not(:last-child):not(:nth-child(2)):not(:nth-last-child(2)) {
      display: none;
    }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  // Global variables
  let currentStream = null;
  let currentCameraType = null;
  let isCheckedIn = false;
  let checkInTime = null;
  let currentCheckInRecord = null;
  let attendanceRecords = [];
  let currentPage = 1;
  let totalPages = 1;
  let totalCount = 0;
  const recordsPerPage = 10;
  
  // Employee data (from backend context)
  const loggedInEmployee = { 
    name: '{{ employee_name|default:"Guest User" }}',
    isCheckedIn: {{ is_checked_in|yesno:"true,false" }},
    checkInTime: '{{ check_in_time|default:"" }}'
  };
  
  // Update initial state
  if (loggedInEmployee.isCheckedIn) {
    isCheckedIn = true;
    if (loggedInEmployee.checkInTime) {
      checkInTime = new Date(loggedInEmployee.checkInTime);
    }
  }
  
  
  // Update UI based on check-in status
  function updateUI() {
    const statusCircle = document.getElementById('statusCircle');
    const statusText = document.getElementById('statusText');
    const checkInBtn = document.getElementById('checkInBtn');
    const checkOutBtn = document.getElementById('checkOutBtn');
    
    if (isCheckedIn) {
      statusCircle.classList.add('checked-in');
      statusText.classList.add('checked-in');
      statusText.textContent = 'Checked In';
      checkInBtn.disabled = true;
      checkOutBtn.disabled = false;
      } else {
      statusCircle.classList.remove('checked-in');
      statusText.classList.remove('checked-in');
      statusText.textContent = 'Not Checked In';
      checkInBtn.disabled = false;
      checkOutBtn.disabled = true;
    }
  }
  
  // Update clock
  function updateClock() {
    const now = new Date();
    document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: true
    });
    
    document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }
  
  setInterval(updateClock, 1000);
  updateClock();
  
  // Calculate work hours with hours, minutes, and seconds
  function calculateWorkHours(checkInTimeStr, checkOutTimeStr) {
    if (!checkInTimeStr || !checkOutTimeStr) return '--';
    
    const checkIn = new Date(checkInTimeStr);
    const checkOut = new Date(checkOutTimeStr);
    const diffMs = checkOut - checkIn;
    
    const totalSeconds = Math.floor(diffMs / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    
    return `${hours}h ${minutes}m ${seconds}s`;
  }
  
  // Format date
  function formatDate(dateStr) {
    if (!dateStr) return '--';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
  }
  
  // Format time
  function formatTime(dateStr) {
    if (!dateStr) return '--';
    const date = new Date(dateStr);
    return date.toLocaleTimeString('en-US', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
  }
  
  // Load attendance records from backend with pagination
  async function loadAttendanceRecords(page = 1) {
    try {
      currentPage = page;
      const filterDate = document.getElementById('filterDate').value;
      const params = new URLSearchParams();
      if (filterDate) {
        params.append('date', filterDate);
      }
      params.append('page', currentPage);
      params.append('per_page', recordsPerPage);
      if (!loggedInEmployee.name || loggedInEmployee.name === 'Guest User') {
        params.append('employee_name', loggedInEmployee.name);
      }
      
      const response = await fetch(`{% url "employee_attendance_records" %}?${params}`);
      const data = await response.json();
      
      if (data.success) {
        attendanceRecords = data.records;
        if (data.pagination) {
          totalPages = data.pagination.total_pages;
          totalCount = data.pagination.total_count;
          currentPage = data.pagination.current_page;
        }
        renderTable();
        renderPagination();
      } else {
        console.error('Error loading records:', data.error);
        attendanceRecords = [];
        totalPages = 1;
        totalCount = 0;
        renderTable();
        renderPagination();
      }
    } catch (error) {
      console.error('Error fetching records:', error);
      attendanceRecords = [];
      totalPages = 1;
      totalCount = 0;
      renderTable();
      renderPagination();
    }
  }
  
  // Render attendance table
  function renderTable() {
    const tbody = document.getElementById('attendanceTableBody');
    const emptyState = document.getElementById('emptyState');
    
    tbody.innerHTML = '';
    
    if (attendanceRecords.length === 0) {
      emptyState.classList.remove('d-none');
      return;
    }
    
    emptyState.classList.add('d-none');
    
    attendanceRecords.forEach(record => {
      const tr = document.createElement('tr');
      
      const checkInPhoto = record.check_in_photo 
        ? `<img src="${record.check_in_photo}" alt="Check In" class="photo-thumbnail" onclick="showPhotoModal('${record.check_in_photo}')">`
        : '--';
      
      const checkOutPhoto = record.check_out_photo 
        ? `<img src="${record.check_out_photo}" alt="Check Out" class="photo-thumbnail" onclick="showPhotoModal('${record.check_out_photo}')">`
        : '--';
      
      let workHours = '--';
      if (record.work_hours) {
        workHours = record.work_hours.formatted || calculateWorkHours(record.check_in_time, record.check_out_time);
      } else if (record.check_in_time && record.check_out_time) {
        workHours = calculateWorkHours(record.check_in_time, record.check_out_time);
      }
      
      tr.innerHTML = `
        <td>${record.employee_name || loggedInEmployee.name}</td>
        <td>${formatDate(record.date)}</td>
        <td>${formatTime(record.check_in_time)}</td>
        <td>${checkInPhoto}</td>
        <td>${formatTime(record.check_out_time)}</td>
        <td>${checkOutPhoto}</td>
        <td class="work-hours">${workHours}</td>
      `;
      
      tbody.appendChild(tr);
    });
  }
  
  // Show photo modal
  function showPhotoModal(photoSrc) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Photo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <img src="${photoSrc}" class="img-fluid" alt="Photo">
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    modal.addEventListener('hidden.bs.modal', () => {
      document.body.removeChild(modal);
    });
  }
  
  // Refresh table
  function refreshTable() {
    loadAttendanceRecords(1);
  }
  
  // Render pagination controls
  function renderPagination() {
    const paginationContainer = document.getElementById('paginationContainer');
    const paginationList = document.getElementById('paginationList');
    const paginationInfo = document.getElementById('paginationInfo');
    
    // Show pagination only if more than 10 records
    if (totalCount > recordsPerPage) {
      paginationContainer.classList.remove('d-none');
      
      // Calculate display info
      const start = (currentPage - 1) * recordsPerPage + 1;
      const end = Math.min(currentPage * recordsPerPage, totalCount);
      paginationInfo.textContent = `Showing ${start} - ${end} of ${totalCount} records`;
      
      // Generate pagination buttons
      paginationList.innerHTML = '';
      
      // Previous button
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); loadAttendanceRecords(${currentPage - 1})">Previous</a>`;
      paginationList.appendChild(prevLi);
      
      // Page number buttons
      const maxButtons = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxButtons - 1);
      
      if (endPage - startPage < maxButtons - 1) {
        startPage = Math.max(1, endPage - maxButtons + 1);
      }
      
      // First page
      if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); loadAttendanceRecords(1)">1</a>`;
        paginationList.appendChild(firstLi);
        
        if (startPage > 2) {
          const ellipsisLi = document.createElement('li');
          ellipsisLi.className = 'page-item disabled';
          ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
          paginationList.appendChild(ellipsisLi);
        }
      }
      
      // Page numbers
      for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); loadAttendanceRecords(${i})">${i}</a>`;
        paginationList.appendChild(pageLi);
      }
      
      // Last page
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsisLi = document.createElement('li');
          ellipsisLi.className = 'page-item disabled';
          ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
          paginationList.appendChild(ellipsisLi);
        }
        
        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); loadAttendanceRecords(${totalPages})">${totalPages}</a>`;
        paginationList.appendChild(lastLi);
      }
      
      // Next button
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); loadAttendanceRecords(${currentPage + 1})">Next</a>`;
      paginationList.appendChild(nextLi);
    } else {
      paginationContainer.classList.add('d-none');
      if (totalCount > 0) {
        paginationInfo.textContent = `Showing all ${totalCount} records`;
      } else {
        paginationInfo.textContent = '';
      }
    }
  }
  
  // Open check-in modal
  function openCheckInModal() {
    const modal = new bootstrap.Modal(document.getElementById('checkInModal'));
    modal.show();
    
    // Update time display
    const now = new Date();
    document.getElementById('checkInTimeText').textContent = now.toLocaleTimeString('en-US', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
    document.getElementById('checkInDateText').textContent = now.toLocaleDateString('en-US', {
      month: 'long',
      day: 'numeric',
      year: 'numeric'
    });
  }
  
  // Open check-out modal
  function openCheckOutModal() {
    const modal = new bootstrap.Modal(document.getElementById('checkOutModal'));
    modal.show();
    
    // Update check-in time display
    if (checkInTime) {
      document.getElementById('checkInTimeDisplay').textContent = checkInTime.toLocaleTimeString('en-US', {
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
      });
    }
      
    // Update time display
      const now = new Date();
    document.getElementById('checkOutTimeText').textContent = now.toLocaleTimeString('en-US', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
    document.getElementById('checkOutDateText').textContent = now.toLocaleDateString('en-US', {
      month: 'long',
      day: 'numeric',
      year: 'numeric'
    });
  }
  
  // Start camera
  function startCamera(type) {
    currentCameraType = type;
    const preview = document.getElementById(type + 'CameraPreview');
    const captureBtn = document.getElementById(type + 'CaptureBtn');
    
    navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: 'user',
        width: { ideal: 640 },
        height: { ideal: 480 }
      } 
    })
    .then(stream => {
      currentStream = stream;
      const video = document.createElement('video');
      video.srcObject = stream;
      video.autoplay = true;
      video.muted = true;
      video.playsInline = true;
      
      preview.innerHTML = '';
      preview.appendChild(video);
      
      captureBtn.disabled = false;
    })
    .catch(err => {
      console.error('Error accessing camera:', err);
      alert('Camera access denied or not available');
    });
  }
  
  // Capture photo
  function capturePhoto(type) {
    const preview = document.getElementById(type + 'CameraPreview');
    const video = preview.querySelector('video');
    const captureBtn = document.getElementById(type + 'CaptureBtn');
    const retakeBtn = document.getElementById(type + 'RetakeBtn');
    const photoData = document.getElementById(type + 'PhotoData');
    
    if (video) {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      const imageData = canvas.toDataURL('image/jpeg', 0.8);
      photoData.value = imageData;
      
      // Replace video with captured image
      const img = document.createElement('img');
      img.src = imageData;
      preview.innerHTML = '';
      preview.appendChild(img);
      
      // Stop camera
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }
      
      captureBtn.disabled = true;
      retakeBtn.disabled = false;
    }
  }
  
  // Retake photo
  function retakePhoto(type) {
    const preview = document.getElementById(type + 'CameraPreview');
    const captureBtn = document.getElementById(type + 'CaptureBtn');
    const retakeBtn = document.getElementById(type + 'RetakeBtn');
    const photoData = document.getElementById(type + 'PhotoData');
    
    preview.innerHTML = `
      <div class="camera-placeholder">
        <i class="bi bi-camera display-1 text-muted"></i>
        <p class="text-muted">Click to capture photo</p>
      </div>
    `;
    
    photoData.value = '';
    captureBtn.disabled = true;
    retakeBtn.disabled = true;
    
    startCamera(type);
  }
  
  // Submit check-in
  async function submitCheckIn() {
    const photoData = document.getElementById('checkInPhotoData').value;
    
    if (!photoData) {
      alert('Please capture a photo first');
      return;
    }
    
    try {
      const formData = new URLSearchParams();
      formData.append('photo', photoData);
      if (!loggedInEmployee.name || loggedInEmployee.name === 'Guest User') {
        formData.append('employee_name', loggedInEmployee.name);
      }
      
      const response = await fetch('{% url "employee_attendance_check_in" %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: formData
      });
      
      const data = await response.json();
      
      if (data.success) {
        isCheckedIn = true;
        checkInTime = new Date(data.check_in_time);
        updateUI();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('checkInModal'));
    modal.hide();
        
        // Reset form
        document.getElementById('checkInForm').reset();
        document.getElementById('checkInCameraPreview').innerHTML = `
          <div class="camera-placeholder">
            <i class="bi bi-camera display-1 text-muted"></i>
            <p class="text-muted">Click to capture photo</p>
          </div>
        `;
        
        // Reload records
        await loadAttendanceRecords();
        alert('Check-in successful!');
      } else {
        alert('Error: ' + (data.error || 'Failed to check in'));
      }
    } catch (error) {
      console.error('Error checking in:', error);
      alert('Error checking in. Please try again.');
    }
  }
  
  // Submit check-out
  async function submitCheckOut() {
    const photoData = document.getElementById('checkOutPhotoData').value;
    
    if (!photoData) {
      alert('Please capture a photo first');
      return;
    }
    
    try {
      const formData = new URLSearchParams();
      formData.append('photo', photoData);
      if (!loggedInEmployee.name || loggedInEmployee.name === 'Guest User') {
        formData.append('employee_name', loggedInEmployee.name);
      }
      
      const response = await fetch('{% url "employee_attendance_check_out" %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: formData
      });
      
      const data = await response.json();
      
      if (data.success) {
        isCheckedIn = false;
        checkInTime = null;
        updateUI();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('checkOutModal'));
    modal.hide();
        
        // Reset form
        document.getElementById('checkOutForm').reset();
        document.getElementById('checkOutCameraPreview').innerHTML = `
          <div class="camera-placeholder">
            <i class="bi bi-camera display-1 text-muted"></i>
            <p class="text-muted">Click to capture photo</p>
          </div>
        `;
        
        // Reload records
        await loadAttendanceRecords();
        
        const workHours = data.work_hours ? data.work_hours.formatted : '--';
        alert('Check-out successful! Work hours: ' + workHours);
      } else {
        alert('Error: ' + (data.error || 'Failed to check out'));
      }
    } catch (error) {
      console.error('Error checking out:', error);
      alert('Error checking out. Please try again.');
    }
  }
  
  // Helper: get CSRF token from cookie
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    updateUI();
    loadAttendanceRecords();
    
    // Set filter date to today
    const today = new Date().toISOString().slice(0, 10);
    document.getElementById('filterDate').value = today;
    
    // Filter date change handler - reset to page 1
    document.getElementById('filterDate').addEventListener('change', () => {
      loadAttendanceRecords(1);
    });
  });
</script>
{% endblock %}
