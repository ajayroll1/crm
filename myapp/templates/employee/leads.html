{% extends "employee/base.html" %}
{% block title %}Leads -Sujata Associates {% endblock %}

{% block content %}
<!-- Display messages -->
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %}
<div class="dashboard-header d-flex align-items-center justify-content-between">
  <div>
    <h1>Leads</h1>
    <p class="text-muted">Add new leads and manage them here</p>
  </div>
  <div class="d-flex gap-2">
    <a href="{% url 'lead_export' %}" class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> Export</a>
    <a href="{% url 'leads_import_export' %}" class="btn btn-outline-primary btn-sm"><i class="bi bi-upload"></i> Import</a>
  </div>
</div>

<!-- Local style override: keep tab text black by default and when active -->
<style>
  .nav-tabs .nav-link { color: #000 !important; }
  .nav-tabs .nav-link.active { color: #000 !important; }
  .nav-tabs .nav-link:hover { color: #fff !important; background-color: var(--primary-color) !important; }

  /* Mobile responsive table - convert to card layout */
  @media (max-width: 768px) {
    .leads-table { border: 0; }
    .leads-table thead { display: none; }
    .leads-table tbody tr { display: block; margin: 0 0 1rem 0; border: 1px solid #eee; border-radius: 8px; background: #fff; }
    .leads-table tbody tr td { display: flex; justify-content: space-between; align-items: center; gap: 1rem; padding: 0.5rem 1rem; border-bottom: 1px solid #f1f1f1; }
    .leads-table tbody tr td:last-child { border-bottom: 0; }
    .leads-table tbody tr td::before { content: attr(data-label); font-weight: 600; color: #666; }
    .leads-table .btn { padding: .25rem .5rem; }
    /* Actions row: keep label on left and icons on right under Due */
    .leads-table tbody tr td[data-label="Actions"] { justify-content: space-between; gap: .5rem; }
    /* Push only the first action (view) to the far right; edit follows next to it */
    .leads-table tbody tr td[data-label="Actions"] .btn-view { margin-left: auto; }
  }
</style>

<!-- Tabs: List | Create -->
<ul class="nav nav-tabs" id="leadsTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab" aria-controls="list" aria-selected="true">
      <i class="bi bi-table"></i> List
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create" type="button" role="tab" aria-controls="create" aria-selected="false">
      <i class="bi bi-plus-circle"></i> Create Lead
    </button>
  </li>
</ul>

<div class="tab-content pt-3" id="leadsTabsContent">
  <!-- List Tab -->
  <div class="tab-pane fade show active" id="list" role="tabpanel" aria-labelledby="list-tab">
    <div class="card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="card-title mb-0">All Leads ({{ total_leads }})</h5>
        <div class="d-flex gap-2">
          <form method="GET" class="d-flex">
            <input class="form-control form-control-sm" style="max-width: 220px;" type="search" name="search" placeholder="Search leads..." value="{{ search_query }}">
            <button class="btn btn-sm btn-outline-primary" type="submit"><i class="bi bi-search"></i></button>
          </form>
          <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filterModal"><i class="bi bi-funnel"></i> Filter</button>
          <a href="{% url 'lead_export' %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> Export</a>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 leads-table">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Company</th>
                <th>Owner</th>
                <th>Priority</th>
                <th>Next Action</th>
                <th>Due</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for lead in leads %}
              <tr data-due="{% if lead.get_full_due_datetime %}{{ lead.get_full_due_datetime|date:'c' }}{% endif %}">
                <td data-label="Name">{{ lead.name }}</td>
                <td data-label="Email">{{ lead.email|default:"-" }}</td>
                <td data-label="Phone">{{ lead.phone|default:"-" }}</td>
                <td data-label="Company">{{ lead.company|default:"-" }}</td>
                <td data-label="Owner">{{ lead.owner }}</td>
                <td data-label="Priority">
                  <span class="badge {{ lead.get_priority_badge_class }}">{{ lead.priority }}</span>
                </td>
                <td data-label="Next Action">{{ lead.next_action|default:"-" }}</td>
                <td data-label="Due">
                  {% if lead.get_full_due_datetime %}
                    {{ lead.get_full_due_datetime|date:"d-M-Y H:i" }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Actions">
                  <button class="btn btn-sm btn-outline-primary btn-view" data-bs-toggle="modal" data-bs-target="#viewLeadModal" data-lead-id="{{ lead.id }}">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-primary btn-edit" data-bs-toggle="modal" data-bs-target="#editLeadModal" data-lead-id="{{ lead.id }}">
                    <i class="bi bi-pencil"></i>
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="9" class="text-center text-muted py-4">
                  <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                  No leads found. <a href="#create" data-bs-toggle="tab">Create your first lead</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Pagination -->
      {% if leads.has_other_pages %}
        <div class="card-footer">
          <nav aria-label="Leads pagination">
            <ul class="pagination pagination-sm justify-content-center mb-0">
              {% if leads.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">First</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ leads.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">Previous</a>
                </li>
              {% endif %}
              
              <li class="page-item active">
                <span class="page-link">
                  Page {{ leads.number }} of {{ leads.paginator.num_pages }}
                </span>
              </li>
              
              {% if leads.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ leads.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">Next</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ leads.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">Last</a>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Create Tab -->
  <div class="tab-pane fade" id="create" role="tabpanel" aria-labelledby="create-tab">
    <form id="createLeadForm" method="post" novalidate>
      {% csrf_token %}
      
      <!-- Display form errors -->
      {% if form.errors %}
        <div class="alert alert-danger">
          <strong>Please fix the following errors:</strong>
          <ul class="mb-0">
            {% for field, errors in form.errors.items %}
              {% for error in errors %}
                <li>{{ field|title }}: {{ error }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
        </div>
      {% endif %}
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Add a new lead</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name<span class="text-danger">*</span></label>
              {{ form.name }}
              {% if form.name.errors %}
                <div class="text-danger small">{{ form.name.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-3">
              <label class="form-label">Email</label>
              {{ form.email }}
              {% if form.email.errors %}
                <div class="text-danger small">{{ form.email.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-3">
              <label class="form-label">Phone</label>
              {{ form.phone }}
              {% if form.phone.errors %}
                <div class="text-danger small">{{ form.phone.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="col-md-4">
              <label class="form-label">Company</label>
              {{ form.company }}
              {% if form.company.errors %}
                <div class="text-danger small">{{ form.company.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label">Source<span class="text-danger">*</span></label>
              {{ form.source }}
              {% if form.source.errors %}
                <div class="text-danger small">{{ form.source.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label">Priority</label>
              {{ form.priority }}
              {% if form.priority.errors %}
                <div class="text-danger small">{{ form.priority.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="col-md-8">
              <label class="form-label">Use-case (1–2 lines)<span class="text-danger">*</span></label>
              {{ form.use_case }}
              {% if form.use_case.errors %}
                <div class="text-danger small">{{ form.use_case.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label">Owner (assignee)<span class="text-danger">*</span></label>
              {{ form.owner }}
              {% if form.owner.errors %}
                <div class="text-danger small">{{ form.owner.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="col-md-4">
              <label class="form-label">Next Action</label>
              {{ form.next_action }}
              {% if form.next_action.errors %}
                <div class="text-danger small">{{ form.next_action.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label">Due Date</label>
              {{ form.due_date }}
              {% if form.due_date.errors %}
                <div class="text-danger small">{{ form.due_date.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label">Due Time</label>
              {{ form.due_time }}
              {% if form.due_time.errors %}
                <div class="text-danger small">{{ form.due_time.errors.0 }}</div>
              {% endif %}
            </div>
          </div>

          <!-- Optional fields toggle -->
          <div class="mt-4">
            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#optionalFields" aria-expanded="false" aria-controls="optionalFields">
              <i class="bi bi-sliders"></i> Optional fields
            </button>
          </div>

          <div class="collapse mt-3" id="optionalFields">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Website</label>
                {{ form.website }}
                {% if form.website.errors %}
                  <div class="text-danger small">{{ form.website.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Industry</label>
                {{ form.industry }}
                {% if form.industry.errors %}
                  <div class="text-danger small">{{ form.industry.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label">City</label>
                {{ form.city }}
                {% if form.city.errors %}
                  <div class="text-danger small">{{ form.city.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label">Country</label>
                {{ form.country }}
                {% if form.country.errors %}
                  <div class="text-danger small">{{ form.country.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label">Budget</label>
                {{ form.budget }}
                {% if form.budget.errors %}
                  <div class="text-danger small">{{ form.budget.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Decision Timeline</label>
                {{ form.timeline }}
                {% if form.timeline.errors %}
                  <div class="text-danger small">{{ form.timeline.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Tags</label>
                {{ form.tags }}
                {% if form.tags.errors %}
                  <div class="text-danger small">{{ form.tags.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="col-12">
                <label class="form-label">Notes</label>
                {{ form.notes }}
                {% if form.notes.errors %}
                  <div class="text-danger small">{{ form.notes.errors.0 }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="reset" class="btn btn-outline-secondary">Reset</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save Lead</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- View Lead Modal -->
<div class="modal fade" id="viewLeadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-person-badge"></i> Lead Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3" id="leadDetails">
          <!-- Lead details will be populated here by JavaScript -->
        </div>
        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-outline-primary btn-sm" id="ld-change-stage"><i class="bi bi-arrow-left-right"></i> Change Stage</button>
          <button class="btn btn-outline-primary btn-sm" id="ld-assign-owner"><i class="bi bi-person-check"></i> Assign</button>
          <button class="btn btn-outline-primary btn-sm" id="ld-schedule"><i class="bi bi-calendar-event"></i> Schedule</button>
          <button class="btn btn-outline-primary btn-sm" id="ld-add-note"><i class="bi bi-journal-plus"></i> Add Note</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Lead Modal -->
<div class="modal fade" id="editLeadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Edit Lead</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editLeadForm" method="post">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name<span class="text-danger">*</span></label>
              <input type="text" name="name" id="edit_name" class="form-control" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Email</label>
              <input type="email" name="email" id="edit_email" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Phone</label>
              <input type="tel" name="phone" id="edit_phone" class="form-control">
            </div>

            <div class="col-md-4">
              <label class="form-label">Company</label>
              <input type="text" name="company" id="edit_company" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Source<span class="text-danger">*</span></label>
              <select name="source" id="edit_source" class="form-select" required>
                <option value="">Select source</option>
                <option value="Website">Website</option>
                <option value="Referral">Referral</option>
                <option value="Cold Call">Cold Call</option>
                <option value="Social">Social</option>
                <option value="Event">Event</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Priority</label>
              <select name="priority" id="edit_priority" class="form-select">
                <option value="Low">Low</option>
                <option value="Med">Medium</option>
                <option value="High">High</option>
              </select>
            </div>

            <div class="col-md-8">
              <label class="form-label">Use-case<span class="text-danger">*</span></label>
              <textarea name="use_case" id="edit_use_case" class="form-control" rows="2" required></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label">Owner<span class="text-danger">*</span></label>
              <input type="text" name="owner" id="edit_owner" class="form-control" required>
            </div>

            <div class="col-md-4">
              <label class="form-label">Next Action</label>
              <select name="next_action" id="edit_next_action" class="form-select">
                <option value="">None</option>
                <option value="Call">Call</option>
                <option value="Email">Email</option>
                <option value="Demo">Demo</option>
                <option value="Meeting">Meeting</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Due Date</label>
              <input type="date" name="due_date" id="edit_due_date" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Due Time</label>
              <input type="time" name="due_time" id="edit_due_time" class="form-control">
            </div>
          </div>

          <!-- Optional fields toggle -->
          <div class="mt-4">
            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#editOptionalFields" aria-expanded="false" aria-controls="editOptionalFields">
              <i class="bi bi-sliders"></i> Optional fields
            </button>
          </div>

          <div class="collapse mt-3" id="editOptionalFields">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Website</label>
                <input type="url" name="website" id="edit_website" class="form-control" placeholder="https://...">
              </div>
              <div class="col-md-6">
                <label class="form-label">Industry</label>
                <input type="text" name="industry" id="edit_industry" class="form-control" placeholder="e.g. BFSI, Retail">
              </div>
              <div class="col-md-4">
                <label class="form-label">City</label>
                <input type="text" name="city" id="edit_city" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Country</label>
                <input type="text" name="country" id="edit_country" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Budget</label>
                <input type="text" name="budget" id="edit_budget" class="form-control" placeholder="e.g. 1–2 Lakh">
              </div>
              <div class="col-md-6">
                <label class="form-label">Decision Timeline</label>
                <input type="text" name="timeline" id="edit_timeline" class="form-control" placeholder="e.g. 2 months">
              </div>
              <div class="col-md-6">
                <label class="form-label">Tags</label>
                <input type="text" name="tags" id="edit_tags" class="form-control" placeholder="Comma separated e.g. BFSI, Enterprise">
              </div>
              <div class="col-12">
                <label class="form-label">Notes</label>
                <textarea name="notes" id="edit_notes" class="form-control" rows="3"></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Lead</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filterModalLabel"><i class="bi bi-funnel"></i> Filter Leads by Due</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="filterForm" method="post" action="{% url 'lead_filter' %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Filter Type</label>
            <div class="d-flex flex-wrap gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="filter_type" id="ft_date" value="date" checked>
                <label class="form-check-label" for="ft_date">Date</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="filter_type" id="ft_month" value="month">
                <label class="form-check-label" for="ft_month">Month</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="filter_type" id="ft_year" value="year">
                <label class="form-check-label" for="ft_year">Year</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="filter_type" id="ft_between" value="between">
                <label class="form-check-label" for="ft_between">Between</label>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-12" data-ft="date">
              <label class="form-label">Select date</label>
              <input type="date" name="single_date" class="form-control">
            </div>
            <div class="col-12 d-none" data-ft="month">
              <label class="form-label">Select month</label>
              <input type="month" name="month" class="form-control">
            </div>
            <div class="col-12 d-none" data-ft="year">
              <label class="form-label">Select year</label>
              <input type="number" name="year" class="form-control" min="2000" max="2100" placeholder="e.g. 2025">
            </div>
            <div class="col-12 d-none" data-ft="between">
              <div class="row g-3">
                <div class="col-6">
                  <label class="form-label">From</label>
                  <input type="date" name="from_date" class="form-control">
                </div>
                <div class="col-6">
                  <label class="form-label">To</label>
                  <input type="date" name="to_date" class="form-control">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Apply Filter</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('filterForm');
      if (!form) return;
      const typeRadios = form.querySelectorAll('input[name="filter_type"]');
      const sections = form.querySelectorAll('[data-ft]');
      function updateSections() {
        const selected = form.querySelector('input[name="filter_type"]:checked').value;
        sections.forEach(sec => {
          sec.classList.toggle('d-none', sec.getAttribute('data-ft') !== selected);
        });
      }
      typeRadios.forEach(r => r.addEventListener('change', updateSections));
      updateSections();
    });
  </script>
</div>
<!-- Client-side validation and modal functionality -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Global modal cleanup function
    function cleanupModals() {
      // Remove all modal backdrops
      document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
      // Remove modal-open class from body
      document.body.classList.remove('modal-open');
      // Reset body styles
      document.body.style.paddingRight = '';
      document.body.style.overflow = '';
      document.body.style.paddingLeft = '';
    }

    // Clean up on page load
    cleanupModals();

    // Clean up on any modal hide event
    document.addEventListener('hidden.bs.modal', function() {
      cleanupModals();
    });
    // Create Lead Form Validation
    const form = document.getElementById('createLeadForm');
    if (form) {
      form.addEventListener('submit', function (e) {
        const name = form.querySelector('[name="name"]').value.trim();
        const source = form.querySelector('[name="source"]').value.trim();
        const useCase = form.querySelector('[name="use_case"]').value.trim();
        const owner = form.querySelector('[name="owner"]').value.trim();
        const email = form.querySelector('[name="email"]').value.trim();
        const phone = form.querySelector('[name="phone"]').value.trim();

        let messages = [];
        if (!name) messages.push('Name is required');
        if (!source) messages.push('Source is required');
        if (!useCase) messages.push('Use-case is required');
        if (!owner) messages.push('Owner is required');
        if (!email && !phone) messages.push('Either Email or Phone is required');

        if (email) {
          const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
          if (!emailOk) messages.push('Enter a valid email');
        }

        if (phone) {
          const phoneOk = /^[0-9+\-()\s]{7,20}$/.test(phone);
          if (!phoneOk) messages.push('Enter a valid phone number');
        }

        if (messages.length) {
          e.preventDefault();
          const alert = document.createElement('div');
          alert.className = 'alert alert-danger';
          alert.innerHTML = '<strong>Please fix the following:</strong><ul class="mb-0">' + messages.map(m => `<li>${m}</li>`).join('') + '</ul>';

          // Remove any old alerts
          form.querySelectorAll('.alert-danger').forEach(x => x.remove());
          form.querySelector('.card-body').prepend(alert);
          alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });
    }

    // View Lead Modal - Fetch complete data when button clicked
    const viewButtons = document.querySelectorAll('.btn-view');
    viewButtons.forEach(button => {
      button.addEventListener('click', function() {
        const leadId = this.getAttribute('data-lead-id');
        
        // Show loading state
        const leadDetails = document.getElementById('leadDetails');
        leadDetails.innerHTML = `
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading lead details...</p>
          </div>
        `;

        // Fetch complete lead data from server
        fetch(`/leads/${leadId}/get-data/`)
          .then(response => {
            if (response.ok) {
              return response.json();
            } else {
              throw new Error('Server response not ok');
            }
          })
          .then(data => {
            // Populate modal with complete data
            leadDetails.innerHTML = `
              <div class="col-md-6"><strong>Name:</strong> ${data.name || '-'}</div>
              <div class="col-md-6"><strong>Email:</strong> ${data.email || '-'}</div>
              <div class="col-md-6"><strong>Phone:</strong> ${data.phone || '-'}</div>
              <div class="col-md-6"><strong>Company:</strong> ${data.company || '-'}</div>
              <div class="col-md-6"><strong>Source:</strong> ${data.source || '-'}</div>
              <div class="col-md-6"><strong>Priority:</strong> <span class="badge ${data.priority === 'High' ? 'bg-danger' : data.priority === 'Low' ? 'bg-success' : 'bg-warning text-dark'}">${data.priority || '-'}</span></div>
              <div class="col-md-6"><strong>Owner:</strong> ${data.owner || '-'}</div>
              <div class="col-md-6"><strong>Use Case:</strong> ${data.use_case || '-'}</div>
              <div class="col-md-6"><strong>Next Action:</strong> ${data.next_action || '-'}</div>
              <div class="col-md-6"><strong>Due Date:</strong> ${data.due_date || '-'}</div>
              <div class="col-md-6"><strong>Due Time:</strong> ${data.due_time || '-'}</div>
              <div class="col-md-6"><strong>Website:</strong> ${data.website ? `<a href="${data.website}" target="_blank" class="text-primary">${data.website}</a>` : '-'}</div>
              <div class="col-md-6"><strong>Industry:</strong> ${data.industry || '-'}</div>
              <div class="col-md-6"><strong>City:</strong> ${data.city || '-'}</div>
              <div class="col-md-6"><strong>Country:</strong> ${data.country || '-'}</div>
              <div class="col-md-6"><strong>Budget:</strong> ${data.budget || '-'}</div>
              <div class="col-md-6"><strong>Timeline:</strong> ${data.timeline || '-'}</div>
              <div class="col-md-6"><strong>Tags:</strong> ${data.tags || '-'}</div>
              <div class="col-12"><strong>Notes:</strong> <div class="mt-1 p-2 bg-light rounded">${data.notes || 'No notes available'}</div></div>
              <div class="col-md-6"><strong>Created:</strong> ${data.created_at || '-'}</div>
              <div class="col-md-6"><strong>Updated:</strong> ${data.updated_at || '-'}</div>
            `;
          })
          .catch(error => {
            console.error('Error fetching lead data:', error);
            leadDetails.innerHTML = `
              <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Error loading lead data!</strong><br>
                Please try again or contact support if the problem persists.
              </div>
            `;
          });
      });
    });

    // Fix modal backdrop issues
    const viewModal = document.getElementById('viewLeadModal');
    if (viewModal) {
      // Clean up modal when hidden
      viewModal.addEventListener('hidden.bs.modal', function () {
        // Remove any backdrop
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        // Remove modal-open class from body
        document.body.classList.remove('modal-open');
        // Reset body padding
        document.body.style.paddingRight = '';
        // Reset body overflow
        document.body.style.overflow = '';
      });

      // Clean up modal when shown
      viewModal.addEventListener('shown.bs.modal', function () {
        // Ensure proper modal display
        document.body.classList.add('modal-open');
      });
    }

    // Edit Lead Modal - Populate form when button clicked
    const editButtons = document.querySelectorAll('.btn-edit');
    editButtons.forEach(button => {
      button.addEventListener('click', function() {
        const leadId = this.getAttribute('data-lead-id');
        const row = this.closest('tr');
        
        // Get data from table row
        const leadData = {
          name: row.querySelector('[data-label="Name"]').textContent.trim(),
          email: row.querySelector('[data-label="Email"]').textContent.trim(),
          phone: row.querySelector('[data-label="Phone"]').textContent.trim(),
          company: row.querySelector('[data-label="Company"]').textContent.trim(),
          owner: row.querySelector('[data-label="Owner"]').textContent.trim(),
          priority: row.querySelector('[data-label="Priority"]').textContent.trim(),
          nextAction: row.querySelector('[data-label="Next Action"]').textContent.trim(),
          due: row.querySelector('[data-label="Due"]').textContent.trim()
        };

        // Fetch complete lead data from server
        fetch(`/leads/${leadId}/get-data/`)
          .then(response => {
            if (response.ok) {
              return response.json();
            } else {
              throw new Error('Server response not ok');
            }
          })
          .then(data => {
            // Populate all form fields with complete data
            document.getElementById('edit_name').value = data.name || '';
            document.getElementById('edit_email').value = data.email || '';
            document.getElementById('edit_phone').value = data.phone || '';
            document.getElementById('edit_company').value = data.company || '';
            document.getElementById('edit_owner').value = data.owner || '';
            document.getElementById('edit_source').value = data.source || '';
            document.getElementById('edit_priority').value = data.priority || 'Med';
            document.getElementById('edit_next_action').value = data.next_action || '';
            document.getElementById('edit_use_case').value = data.use_case || '';
            
            // Set due date and time
            if (data.due_date) {
              document.getElementById('edit_due_date').value = data.due_date;
            }
            if (data.due_time) {
              document.getElementById('edit_due_time').value = data.due_time;
            }
            
            // Populate optional fields
            document.getElementById('edit_website').value = data.website || '';
            document.getElementById('edit_industry').value = data.industry || '';
            document.getElementById('edit_city').value = data.city || '';
            document.getElementById('edit_country').value = data.country || '';
            document.getElementById('edit_budget').value = data.budget || '';
            document.getElementById('edit_timeline').value = data.timeline || '';
            document.getElementById('edit_tags').value = data.tags || '';
            document.getElementById('edit_notes').value = data.notes || '';
            
            // Show optional fields section
            const optionalFields = document.getElementById('editOptionalFields');
            if (optionalFields) {
              optionalFields.style.display = 'block';
            }
          })
          .catch(error => {
            console.error('Error fetching lead data:', error);
            // Fallback to table data if server request fails
            document.getElementById('edit_name').value = leadData.name;
            document.getElementById('edit_email').value = leadData.email === '-' ? '' : leadData.email;
            document.getElementById('edit_phone').value = leadData.phone === '-' ? '' : leadData.phone;
            document.getElementById('edit_company').value = leadData.company === '-' ? '' : leadData.company;
            document.getElementById('edit_owner').value = leadData.owner;
            
            // Fix priority selection
            const priorityText = leadData.priority.trim();
            if (priorityText.includes('High')) {
              document.getElementById('edit_priority').value = 'High';
            } else if (priorityText.includes('Low')) {
              document.getElementById('edit_priority').value = 'Low';
            } else {
              document.getElementById('edit_priority').value = 'Med';
            }
            
            document.getElementById('edit_next_action').value = leadData.nextAction === '-' ? '' : leadData.nextAction;
            
            // Parse due date and time
            if (leadData.due && leadData.due !== '-') {
              const dueParts = leadData.due.split(' ');
              if (dueParts.length === 2) {
                const datePart = dueParts[0];
                const timePart = dueParts[1];
                
                const dateObj = new Date(datePart);
                if (!isNaN(dateObj.getTime())) {
                  const year = dateObj.getFullYear();
                  const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                  const day = String(dateObj.getDate()).padStart(2, '0');
                  document.getElementById('edit_due_date').value = `${year}-${month}-${day}`;
                }
                
                document.getElementById('edit_due_time').value = timePart;
              }
            } else {
              document.getElementById('edit_due_date').value = '';
              document.getElementById('edit_due_time').value = '';
            }
          });
        
        // Set form action to edit URL
        document.getElementById('editLeadForm').action = `/leads/${leadId}/edit/`;
      });
    });

    // Edit Lead Form Submission
    const editForm = document.getElementById('editLeadForm');
    if (editForm) {
      editForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form data
        const formData = new FormData(this);
        
        // Send AJAX request
        fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
        .then(response => {
          if (response.ok) {
            // Close modal and reload page
            const modal = bootstrap.Modal.getInstance(document.getElementById('editLeadModal'));
            modal.hide();
            location.reload();
          } else {
            alert('Error updating lead. Please try again.');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error updating lead. Please try again.');
        });
      });
    }

    // Fix edit modal backdrop issues
    const editModal = document.getElementById('editLeadModal');
    if (editModal) {
      // Clean up modal when hidden
      editModal.addEventListener('hidden.bs.modal', function () {
        // Remove any backdrop
        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
        // Remove modal-open class from body
        document.body.classList.remove('modal-open');
        // Reset body padding
        document.body.style.paddingRight = '';
        // Reset body overflow
        document.body.style.overflow = '';
      });

      // Clean up modal when shown
      editModal.addEventListener('shown.bs.modal', function () {
        // Ensure proper modal display
        document.body.classList.add('modal-open');
      });
    }

    // Filtering logic for All Leads table
    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
      filterForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const type = filterForm.querySelector('[name="filter_type"]:checked').value;
        const date = filterForm.querySelector('[name="single_date"]').value; // format YYYY-MM-DD
        const month = filterForm.querySelector('[name="month"]').value; // format YYYY-MM
        const year = filterForm.querySelector('[name="year"]').value;   // format YYYY
        const from = filterForm.querySelector('[name="from_date"]').value;
        const to = filterForm.querySelector('[name="to_date"]').value;

        const rows = document.querySelectorAll('.leads-table tbody tr');
        rows.forEach(row => {
          const dueIso = row.getAttribute('data-due');
          if (!dueIso) { row.style.display = ''; return; }
          const due = new Date(dueIso);
          let show = true;

          if (type === 'date' && date) {
            const d = new Date(date);
            show = due.getFullYear() === d.getFullYear() && due.getMonth() === d.getMonth() && due.getDate() === d.getDate();
          } else if (type === 'month' && month) {
            const [y, m] = month.split('-').map(n => parseInt(n, 10));
            show = due.getFullYear() === y && (due.getMonth() + 1) === m;
          } else if (type === 'year' && year) {
            const y = parseInt(year, 10);
            show = due.getFullYear() === y;
          } else if (type === 'between' && from && to) {
            const f = new Date(from);
            const t = new Date(to);
            // inclusive range
            show = due >= new Date(f.setHours(0,0,0,0)) && due <= new Date(t.setHours(23,59,59,999));
          }

          row.style.display = show ? '' : 'none';
        });

        // Close modal
        const modalEl = document.getElementById('filterModal');
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.hide();
        // Re-evaluate scroll after filtering
        updateTableScroll();
      });
    }

    // View/Edit actions from table
    const table = document.querySelector('.leads-table');
    const createTabBtn = document.getElementById('create-tab');
    const listTabBtn = document.getElementById('list-tab');
    const leadForm = document.getElementById('createLeadForm');
    const tableWrapper = document.querySelector('#list .card .table-responsive');

    function updateTableScroll() {
      if (!table || !tableWrapper) return;
      const visibleRows = Array.from(table.querySelectorAll('tbody tr')).filter(r => r.style.display !== 'none');
      if (visibleRows.length > 10) {
        tableWrapper.style.maxHeight = '480px'; // approx height for ~10 rows
        tableWrapper.style.overflowY = 'auto';
      } else {
        tableWrapper.style.maxHeight = '';
        tableWrapper.style.overflowY = '';
      }
    }

    // Initial scroll setup based on current rows
    updateTableScroll();
    function getRowData(tr) {
      return {
        name: tr.querySelector('[data-label="Name"]').textContent.trim(),
        email: tr.querySelector('[data-label="Email"]').textContent.trim(),
        phone: tr.querySelector('[data-label="Phone"]').textContent.trim(),
        company: tr.querySelector('[data-label="Company"]').textContent.trim(),
        owner: tr.querySelector('[data-label="Owner"]').textContent.trim(),
        priority: tr.querySelector('[data-label="Priority"]').innerText.trim(),
        nextAction: tr.querySelector('[data-label="Next Action"]').textContent.trim(),
        dueIso: tr.getAttribute('data-due'),
        dueText: tr.querySelector('[data-label="Due"]').textContent.trim(),
      };
    }

    if (table) {
      table.addEventListener('click', function (e) {
        const btnView = e.target.closest('.btn-view');
        const btnEdit = e.target.closest('.btn-edit');
        const tr = e.target.closest('tr');
        if (!tr) return;
        const data = getRowData(tr);

        if (btnView) {
          const container = document.getElementById('leadDetails');
          if (container) {
            container.innerHTML = `
              <div class="col-md-6"><strong>Name:</strong> ${data.name}</div>
              <div class="col-md-6"><strong>Company:</strong> ${data.company}</div>
              <div class="col-md-6"><strong>Email:</strong> ${data.email}</div>
              <div class="col-md-6"><strong>Phone:</strong> ${data.phone}</div>
              <div class="col-md-6"><strong>Owner:</strong> ${data.owner}</div>
              <div class="col-md-3"><strong>Priority:</strong> ${data.priority}</div>
              <div class="col-md-3"><strong>Stage:</strong> Proposal</div>
              <div class="col-md-6"><strong>Next Action:</strong> ${data.nextAction}</div>
              <div class="col-md-6"><strong>Due:</strong> ${data.dueText}</div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('viewLeadModal'));
            modal.show();
          }
        }

        if (btnEdit && createTabBtn && leadForm) {
          // Switch to Create tab
          const tab = new bootstrap.Tab(createTabBtn);
          tab.show();

          // Prefill form
          leadForm.querySelector('[name="name"]').value = data.name !== '-' ? data.name : '';
          leadForm.querySelector('[name="email"]').value = data.email !== '-' ? data.email : '';
          leadForm.querySelector('[name="phone"]').value = data.phone !== '-' ? data.phone : '';
          leadForm.querySelector('[name="company"]').value = data.company !== '-' ? data.company : '';
          leadForm.querySelector('[name="owner"]').value = data.owner !== '-' ? data.owner : '';
          // Priority badge text may include spaces; fallback Med
          const prio = (data.priority || 'Med').toLowerCase();
          const prioSel = leadForm.querySelector('[name="priority"]');
          if (prio.includes('high')) prioSel.value = 'High'; else if (prio.includes('low')) prioSel.value = 'Low'; else prioSel.value = 'Med';
          const nextSel = leadForm.querySelector('[name="next_action"]');
          if (data.nextAction) nextSel.value = ['Call','Email','Demo','Meeting'].includes(data.nextAction) ? data.nextAction : '';
          if (data.dueIso) {
            const d = new Date(data.dueIso);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth()+1).padStart(2,'0');
            const dd = String(d.getDate()).padStart(2,'0');
            const hh = String(d.getHours()).padStart(2,'0');
            const mi = String(d.getMinutes()).padStart(2,'0');
            leadForm.querySelector('[name="due_date"]').value = `${yyyy}-${mm}-${dd}`;
            leadForm.querySelector('[name="due_time"]').value = `${hh}:${mi}`;
          } else {
            leadForm.querySelector('[name="due_date"]').value = '';
            leadForm.querySelector('[name="due_time"]').value = '';
          }
          // Scroll to top of form for better UX on mobile
          leadForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }
  });
</script>
{% endblock %}


