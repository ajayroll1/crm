{% extends "dashboard/dashboard_base.html"%}
{% block title %}Leads -Sujata Associates {% endblock %}

{% block content %}
<!-- Display messages -->
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %}
<div class="dashboard-header d-flex align-items-center justify-content-between">
  <div>
    <h1>Leads</h1>
    <p class="text-muted">Add new leads and manage them here</p>
  </div>
  <div class="d-flex gap-2">
    <a href="{% url 'lead_export' %}" class="btn btn-outline-primary btn-sm"><i class="bi bi-download"></i> Export</a>
    <a href="{% url 'leads_import_export' %}" class="btn btn-outline-primary btn-sm"><i class="bi bi-upload"></i> Import</a>
  </div>
</div>

<!-- Local style override: keep tab text black by default and when active -->
<style>
  .nav-tabs .nav-link { color: #000 !important; }
  .nav-tabs .nav-link.active { color: #000 !important; }
  .nav-tabs .nav-link:hover { color: #fff !important; background-color: var(--primary-color) !important; }

  /* Mobile responsive table - convert to card layout */
  @media (max-width: 768px) {
    .leads-table { border: 0; }
    .leads-table thead { display: none; }
    .leads-table tbody tr { display: block; margin: 0 0 1rem 0; border: 1px solid #eee; border-radius: 8px; background: #fff; }
    .leads-table tbody tr td { display: flex; justify-content: space-between; align-items: center; gap: 1rem; padding: 0.5rem 1rem; border-bottom: 1px solid #f1f1f1; }
    .leads-table tbody tr td:last-child { border-bottom: 0; }
    .leads-table tbody tr td::before { content: attr(data-label); font-weight: 600; color: #666; }
    .leads-table .btn { padding: .25rem .5rem; }
    /* Actions row: keep label on left and icons on right under Due */
    .leads-table tbody tr td[data-label="Actions"] { justify-content: space-between; gap: .5rem; }
    /* Push only the first action (view) to the far right; edit follows next to it */
    .leads-table tbody tr td[data-label="Actions"] .btn-view { margin-left: auto; }
  }
</style>

<!-- Tabs: List | Create -->
<ul class="nav nav-tabs" id="leadsTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list" type="button" role="tab" aria-controls="list" aria-selected="true">
      <i class="bi bi-table"></i> List
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="create-tab" data-bs-toggle="tab" data-bs-target="#create" type="button" role="tab" aria-controls="create" aria-selected="false">
      <i class="bi bi-plus-circle"></i> Create Lead
    </button>
  </li>
</ul>

<div class="tab-content pt-3" id="leadsTabsContent">
  <!-- List Tab -->
  <div class="tab-pane fade show active" id="list" role="tabpanel" aria-labelledby="list-tab">
    <div class="card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="card-title mb-0">All Leads ({{ total_leads }})</h5>
        <div class="d-flex gap-2">
          <form method="GET" class="d-flex">
            <input class="form-control form-control-sm" style="max-width: 220px;" type="search" name="search" placeholder="Search leads..." value="{{ search_query }}">
            <button class="btn btn-sm btn-outline-primary" type="submit"><i class="bi bi-search"></i></button>
          </form>
          <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filterModal"><i class="bi bi-funnel"></i> Filter</button>
          <a href="{% url 'lead_export' %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> Export</a>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 leads-table">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Company</th>
                <th>Owner</th>
                <th>Priority</th>
                <th>Next Action</th>
                <th>Due</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for lead in leads %}
              <tr data-due="{% if lead.get_full_due_datetime %}{{ lead.get_full_due_datetime|date:'c' }}{% endif %}">
                <td data-label="Name">{{ lead.name }}</td>
                <td data-label="Email">{{ lead.email|default:"-" }}</td>
                <td data-label="Phone">{{ lead.phone|default:"-" }}</td>
                <td data-label="Company">{{ lead.company|default:"-" }}</td>
                <td data-label="Owner">{{ lead.owner }}</td>
                <td data-label="Priority">
                  <span class="badge {{ lead.get_priority_badge_class }}">{{ lead.priority }}</span>
                </td>
                <td data-label="Next Action">{{ lead.next_action|default:"-" }}</td>
                <td data-label="Due">
                  {% if lead.get_full_due_datetime %}
                    {{ lead.get_full_due_datetime|date:"d-M-Y H:i" }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td data-label="Actions">
                  <a href="{% url 'lead_detail' lead.id %}" class="btn btn-sm btn-outline-primary btn-view"><i class="bi bi-eye"></i></a>
                  <a href="{% url 'lead_edit' lead.id %}" class="btn btn-sm btn-outline-primary btn-edit"><i class="bi bi-pencil"></i></a>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="9" class="text-center text-muted py-4">
                  <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                  No leads found. <a href="#create" data-bs-toggle="tab">Create your first lead</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Pagination -->
      {% if leads.has_other_pages %}
        <div class="card-footer">
          <nav aria-label="Leads pagination">
            <ul class="pagination pagination-sm justify-content-center mb-0">
              {% if leads.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">First</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ leads.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">Previous</a>
                </li>
              {% endif %}
              
              <li class="page-item active">
                <span class="page-link">
                  Page {{ leads.number }} of {{ leads.paginator.num_pages }}
                </span>
              </li>
              
              {% if leads.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ leads.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">Next</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ leads.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">Last</a>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Create Tab -->
  <div class="tab-pane fade" id="create" role="tabpanel" aria-labelledby="create-tab">
    <form id="createLeadForm" method="post" novalidate>
      {% csrf_token %}
      
      <!-- Display form errors -->
      {% if form.errors %}
        <div class="alert alert-danger">
          <strong>Please fix the following errors:</strong>
          <ul class="mb-0">
            {% for field, errors in form.errors.items %}
              {% for error in errors %}
                <li>{{ field|title }}: {{ error }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
        </div>
      {% endif %}
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Add a new lead</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name<span class="text-danger">*</span></label>
              {{ form.name }}
              {% if form.name.errors %}
                <div class="text-danger small">{{ form.name.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-3">
              <label class="form-label">Email</label>
              {{ form.email }}
              {% if form.email.errors %}
                <div class="text-danger small">{{ form.email.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-3">
              <label class="form-label">Phone</label>
              {{ form.phone }}
              {% if form.phone.errors %}
                <div class="text-danger small">{{ form.phone.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="col-md-4">
              <label class="form-label">Company</label>
              {{ form.company }}
              {% if form.company.errors %}
                <div class="text-danger small">{{ form.company.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label">Source<span class="text-danger">*</span></label>
              {{ form.source }}
              {% if form.source.errors %}
                <div class="text-danger small">{{ form.source.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label">Priority</label>
              {{ form.priority }}
              {% if form.priority.errors %}
                <div class="text-danger small">{{ form.priority.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="col-md-8">
              <label class="form-label">Use-case (1–2 lines)<span class="text-danger">*</span></label>
              {{ form.use_case }}
              {% if form.use_case.errors %}
                <div class="text-danger small">{{ form.use_case.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label">Owner (assignee)<span class="text-danger">*</span></label>
              {{ form.owner }}
              {% if form.owner.errors %}
                <div class="text-danger small">{{ form.owner.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="col-md-4">
              <label class="form-label">Next Action</label>
              {{ form.next_action }}
              {% if form.next_action.errors %}
                <div class="text-danger small">{{ form.next_action.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label">Due Date</label>
              {{ form.due_date }}
              {% if form.due_date.errors %}
                <div class="text-danger small">{{ form.due_date.errors.0 }}</div>
              {% endif %}
            </div>
            <div class="col-md-4">
              <label class="form-label">Due Time</label>
              {{ form.due_time }}
              {% if form.due_time.errors %}
                <div class="text-danger small">{{ form.due_time.errors.0 }}</div>
              {% endif %}
            </div>
          </div>

          <!-- Optional fields toggle -->
          <div class="mt-4">
            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#optionalFields" aria-expanded="false" aria-controls="optionalFields">
              <i class="bi bi-sliders"></i> Optional fields
            </button>
          </div>

          <div class="collapse mt-3" id="optionalFields">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Website</label>
                {{ form.website }}
                {% if form.website.errors %}
                  <div class="text-danger small">{{ form.website.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Industry</label>
                {{ form.industry }}
                {% if form.industry.errors %}
                  <div class="text-danger small">{{ form.industry.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label">City</label>
                {{ form.city }}
                {% if form.city.errors %}
                  <div class="text-danger small">{{ form.city.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label">Country</label>
                {{ form.country }}
                {% if form.country.errors %}
                  <div class="text-danger small">{{ form.country.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="col-md-4">
                <label class="form-label">Budget</label>
                {{ form.budget }}
                {% if form.budget.errors %}
                  <div class="text-danger small">{{ form.budget.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Decision Timeline</label>
                {{ form.timeline }}
                {% if form.timeline.errors %}
                  <div class="text-danger small">{{ form.timeline.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Tags</label>
                {{ form.tags }}
                {% if form.tags.errors %}
                  <div class="text-danger small">{{ form.tags.errors.0 }}</div>
                {% endif %}
              </div>
              <div class="col-12">
                <label class="form-label">Notes</label>
                {{ form.notes }}
                {% if form.notes.errors %}
                  <div class="text-danger small">{{ form.notes.errors.0 }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="reset" class="btn btn-outline-secondary">Reset</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save Lead</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- View Lead Modal -->
<div class="modal fade" id="viewLeadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-person-badge"></i> Lead Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs" id="leadDetailTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#ld-overview" type="button" role="tab">Overview</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#ld-activity" type="button" role="tab">Activity</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#ld-files" type="button" role="tab">Files</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#ld-history" type="button" role="tab">History</button>
          </li>
        </ul>
        <div class="tab-content pt-3">
          <div class="tab-pane fade show active" id="ld-overview" role="tabpanel">
            <div class="row g-3" id="leadDetails"></div>
            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-outline-primary btn-sm" id="ld-change-stage"><i class="bi bi-arrow-left-right"></i> Change Stage</button>
              <button class="btn btn-outline-primary btn-sm" id="ld-assign-owner"><i class="bi bi-person-check"></i> Assign</button>
              <button class="btn btn-outline-primary btn-sm" id="ld-schedule"><i class="bi bi-calendar-event"></i> Schedule</button>
              <button class="btn btn-outline-primary btn-sm" id="ld-add-note"><i class="bi bi-journal-plus"></i> Add Note</button>
            </div>
          </div>
          <div class="tab-pane fade" id="ld-activity" role="tabpanel">
            <div class="list-group small" id="ld-activity-list">
              <div class="list-group-item">[Demo] 10:30 AM - Note added by Ajay</div>
              <div class="list-group-item">[Demo] Yesterday - Email sent</div>
            </div>
          </div>
          <div class="tab-pane fade" id="ld-files" role="tabpanel">
            <div class="border rounded p-3 text-center">
              <p class="mb-2">Drag & drop files here</p>
              <input type="file" class="form-control" multiple>
            </div>
          </div>
          <div class="tab-pane fade" id="ld-history" role="tabpanel">
            <ul class="small mb-0">
              <li>[Demo] Stage changed Prospect → Proposal</li>
              <li>[Demo] Owner assigned to Vikas</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filterModalLabel"><i class="bi bi-funnel"></i> Filter Leads by Due</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="filterForm" method="post" action="{% url 'lead_filter' %}">
        {% csrf_token %}
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Filter Type</label>
            <div class="d-flex flex-wrap gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="filter_type" id="ft_date" value="date" checked>
                <label class="form-check-label" for="ft_date">Date</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="filter_type" id="ft_month" value="month">
                <label class="form-check-label" for="ft_month">Month</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="filter_type" id="ft_year" value="year">
                <label class="form-check-label" for="ft_year">Year</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="filter_type" id="ft_between" value="between">
                <label class="form-check-label" for="ft_between">Between</label>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-12" data-ft="date">
              <label class="form-label">Select date</label>
              <input type="date" name="single_date" class="form-control">
            </div>
            <div class="col-12 d-none" data-ft="month">
              <label class="form-label">Select month</label>
              <input type="month" name="month" class="form-control">
            </div>
            <div class="col-12 d-none" data-ft="year">
              <label class="form-label">Select year</label>
              <input type="number" name="year" class="form-control" min="2000" max="2100" placeholder="e.g. 2025">
            </div>
            <div class="col-12 d-none" data-ft="between">
              <div class="row g-3">
                <div class="col-6">
                  <label class="form-label">From</label>
                  <input type="date" name="from_date" class="form-control">
                </div>
                <div class="col-6">
                  <label class="form-label">To</label>
                  <input type="date" name="to_date" class="form-control">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Apply Filter</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('filterForm');
      if (!form) return;
      const typeRadios = form.querySelectorAll('input[name="filter_type"]');
      const sections = form.querySelectorAll('[data-ft]');
      function updateSections() {
        const selected = form.querySelector('input[name="filter_type"]:checked').value;
        sections.forEach(sec => {
          sec.classList.toggle('d-none', sec.getAttribute('data-ft') !== selected);
        });
      }
      typeRadios.forEach(r => r.addEventListener('change', updateSections));
      updateSections();
    });
  </script>
</div>
<!-- Client-side validation -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('createLeadForm');
    if (!form) return;

    form.addEventListener('submit', function (e) {
      const name = form.querySelector('[name="name"]').value.trim();
      const source = form.querySelector('[name="source"]').value.trim();
      const useCase = form.querySelector('[name="use_case"]').value.trim();
      const owner = form.querySelector('[name="owner"]').value.trim();
      const email = form.querySelector('[name="email"]').value.trim();
      const phone = form.querySelector('[name="phone"]').value.trim();

      let messages = [];
      if (!name) messages.push('Name is required');
      if (!source) messages.push('Source is required');
      if (!useCase) messages.push('Use-case is required');
      if (!owner) messages.push('Owner is required');
      if (!email && !phone) messages.push('Either Email or Phone is required');

      if (email) {
        const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        if (!emailOk) messages.push('Enter a valid email');
      }

      if (phone) {
        const phoneOk = /^[0-9+\-()\s]{7,20}$/.test(phone);
        if (!phoneOk) messages.push('Enter a valid phone number');
      }

      if (messages.length) {
        e.preventDefault();
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger';
        alert.innerHTML = '<strong>Please fix the following:</strong><ul class="mb-0">' + messages.map(m => `<li>${m}</li>`).join('') + '</ul>';

        // Remove any old alerts
        form.querySelectorAll('.alert-danger').forEach(x => x.remove());
        form.querySelector('.card-body').prepend(alert);
        alert.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });

    // Filtering logic for All Leads table
    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
      filterForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const type = filterForm.querySelector('[name="filter_type"]:checked').value;
        const date = filterForm.querySelector('[name="single_date"]').value; // format YYYY-MM-DD
        const month = filterForm.querySelector('[name="month"]').value; // format YYYY-MM
        const year = filterForm.querySelector('[name="year"]').value;   // format YYYY
        const from = filterForm.querySelector('[name="from_date"]').value;
        const to = filterForm.querySelector('[name="to_date"]').value;

        const rows = document.querySelectorAll('.leads-table tbody tr');
        rows.forEach(row => {
          const dueIso = row.getAttribute('data-due');
          if (!dueIso) { row.style.display = ''; return; }
          const due = new Date(dueIso);
          let show = true;

          if (type === 'date' && date) {
            const d = new Date(date);
            show = due.getFullYear() === d.getFullYear() && due.getMonth() === d.getMonth() && due.getDate() === d.getDate();
          } else if (type === 'month' && month) {
            const [y, m] = month.split('-').map(n => parseInt(n, 10));
            show = due.getFullYear() === y && (due.getMonth() + 1) === m;
          } else if (type === 'year' && year) {
            const y = parseInt(year, 10);
            show = due.getFullYear() === y;
          } else if (type === 'between' && from && to) {
            const f = new Date(from);
            const t = new Date(to);
            // inclusive range
            show = due >= new Date(f.setHours(0,0,0,0)) && due <= new Date(t.setHours(23,59,59,999));
          }

          row.style.display = show ? '' : 'none';
        });

        // Close modal
        const modalEl = document.getElementById('filterModal');
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.hide();
        // Re-evaluate scroll after filtering
        updateTableScroll();
      });
    }

    // View/Edit actions from table
    const table = document.querySelector('.leads-table');
    const createTabBtn = document.getElementById('create-tab');
    const listTabBtn = document.getElementById('list-tab');
    const leadForm = document.getElementById('createLeadForm');
    const tableWrapper = document.querySelector('#list .card .table-responsive');

    function updateTableScroll() {
      if (!table || !tableWrapper) return;
      const visibleRows = Array.from(table.querySelectorAll('tbody tr')).filter(r => r.style.display !== 'none');
      if (visibleRows.length > 10) {
        tableWrapper.style.maxHeight = '480px'; // approx height for ~10 rows
        tableWrapper.style.overflowY = 'auto';
      } else {
        tableWrapper.style.maxHeight = '';
        tableWrapper.style.overflowY = '';
      }
    }

    // Initial scroll setup based on current rows
    updateTableScroll();
    function getRowData(tr) {
      return {
        name: tr.querySelector('[data-label="Name"]').textContent.trim(),
        email: tr.querySelector('[data-label="Email"]').textContent.trim(),
        phone: tr.querySelector('[data-label="Phone"]').textContent.trim(),
        company: tr.querySelector('[data-label="Company"]').textContent.trim(),
        owner: tr.querySelector('[data-label="Owner"]').textContent.trim(),
        priority: tr.querySelector('[data-label="Priority"]').innerText.trim(),
        nextAction: tr.querySelector('[data-label="Next Action"]').textContent.trim(),
        dueIso: tr.getAttribute('data-due'),
        dueText: tr.querySelector('[data-label="Due"]').textContent.trim(),
      };
    }

    if (table) {
      table.addEventListener('click', function (e) {
        const btnView = e.target.closest('.btn-view');
        const btnEdit = e.target.closest('.btn-edit');
        const tr = e.target.closest('tr');
        if (!tr) return;
        const data = getRowData(tr);

        if (btnView) {
          const container = document.getElementById('leadDetails');
          if (container) {
            container.innerHTML = `
              <div class="col-md-6"><strong>Name:</strong> ${data.name}</div>
              <div class="col-md-6"><strong>Company:</strong> ${data.company}</div>
              <div class="col-md-6"><strong>Email:</strong> ${data.email}</div>
              <div class="col-md-6"><strong>Phone:</strong> ${data.phone}</div>
              <div class="col-md-6"><strong>Owner:</strong> ${data.owner}</div>
              <div class="col-md-3"><strong>Priority:</strong> ${data.priority}</div>
              <div class="col-md-3"><strong>Stage:</strong> Proposal</div>
              <div class="col-md-6"><strong>Next Action:</strong> ${data.nextAction}</div>
              <div class="col-md-6"><strong>Due:</strong> ${data.dueText}</div>
            `;
            const modal = new bootstrap.Modal(document.getElementById('viewLeadModal'));
            modal.show();
          }
        }

        if (btnEdit && createTabBtn && leadForm) {
          // Switch to Create tab
          const tab = new bootstrap.Tab(createTabBtn);
          tab.show();

          // Prefill form
          leadForm.querySelector('[name="name"]').value = data.name !== '-' ? data.name : '';
          leadForm.querySelector('[name="email"]').value = data.email !== '-' ? data.email : '';
          leadForm.querySelector('[name="phone"]').value = data.phone !== '-' ? data.phone : '';
          leadForm.querySelector('[name="company"]').value = data.company !== '-' ? data.company : '';
          leadForm.querySelector('[name="owner"]').value = data.owner !== '-' ? data.owner : '';
          // Priority badge text may include spaces; fallback Med
          const prio = (data.priority || 'Med').toLowerCase();
          const prioSel = leadForm.querySelector('[name="priority"]');
          if (prio.includes('high')) prioSel.value = 'High'; else if (prio.includes('low')) prioSel.value = 'Low'; else prioSel.value = 'Med';
          const nextSel = leadForm.querySelector('[name="next_action"]');
          if (data.nextAction) nextSel.value = ['Call','Email','Demo','Meeting'].includes(data.nextAction) ? data.nextAction : '';
          if (data.dueIso) {
            const d = new Date(data.dueIso);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth()+1).padStart(2,'0');
            const dd = String(d.getDate()).padStart(2,'0');
            const hh = String(d.getHours()).padStart(2,'0');
            const mi = String(d.getMinutes()).padStart(2,'0');
            leadForm.querySelector('[name="due_date"]').value = `${yyyy}-${mm}-${dd}`;
            leadForm.querySelector('[name="due_time"]').value = `${hh}:${mi}`;
          } else {
            leadForm.querySelector('[name="due_date"]').value = '';
            leadForm.querySelector('[name="due_time"]').value = '';
          }
          // Scroll to top of form for better UX on mobile
          leadForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    }
  });
</script>
{% endblock %}


